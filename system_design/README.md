# システム設計の面接試験

## 1 章 ユーザー数 0 から数百万人へのスケールアップ

- どちらの DB を使うのか:
  - RDB: 表と行の形でデータを保存。
  - 非 RDB(NoSQL): DynamoDB, CouchDB, Neo4j など。join 操作の support がない。
    - key value store
    - graph store
    - column store
    - document store
    - NoSQL の使い所:
      - アプリケーションに超低遅延が必要な場合
      - 非構造化データを扱う場合、あるいはリレーショナルデータがない場合
      - データのシリアライズとデシリアライズだけが必要な場合(JSON, XML, YAML など)
      - 大量データの保存が必要な場合
- DB レプリケーション:

  - マスターデータベース: 書き込み操作のみを support
  - リードレプリカ: マスターデータベースからの copy を取得し、読み込み操作のみを support

- <img width="460" alt="image" src="https://github.com/yoshikikasama/system/assets/61643054/bb7d911a-02ba-4748-b759-b80292221194">

- キャッシュ層:
  - 高いレスポンスや頻繁にアクセスされるデータの結果をメモリに保存し、後続のリクエストをより迅速に処理されるようにする一時的な記憶装置。
  - DB を繰り返し呼び出すとアプリケーションの性能に大きな影響を与えるのでキャッシュはこの問題を軽減できる。
  - <img width="536" alt="image" src="https://github.com/yoshikikasama/system/assets/61643054/edb1ac86-7a96-4ba1-9a12-e7d0cc508816">
    - リードスルーキャッシュ: web serverはレスポンスを受け取るとまずキャッシュに利用可能なレスポンスがあるかを確認する。もしあればクライアントにデータを送り返し、なけれbDBに問い合わせ、レスポンスをキャッシュに保存し、クライアントに送り返します。
  - キャッシュを利用するタイミングの決定:
    - データの読み取り頻度が高く、変更頻度が低い場合にはキャッシュの使用を検討する。
    - キャッシュされたデータは揮発性メモリに保存されるため、キャッシュサーバーの再起動によりメモリ内のデータは失われるため、重要なデータは永続的なデータストアに保存する必要がある。
    - 有効期限ポリシー: キャッシュされたデータが永久にメモリに保存されることがないように設定する。
    - エビクション: キャッシュがいっぱいになり、キャッシュにアイテムを追加するリクエストがあると、既存アイテムが削除されること。
    - 消去ポリシー:　 LRU(Least-recently-used)は最も一般的なキャッシュポリシー。
- CDN(Content Delivery Network)

  - 地理的に分散したネットワークであり、静的コンテンツを配信するために使用される。
  - <img width="953" alt="image" src="https://github.com/yoshikikasama/system/assets/61643054/854996ad-1d30-45fa-beec-f4fb1fa940e1">
    - オリジンサーバー: web serverやs3などのオンラインストレージ
    - オリジンサーバーはCDNサーバーにimage.pngを返すときにオプションで画像がキャッシュされる期間を示すHTTPヘッダであるTime-to-Live(TTL)が含まれる。
    - CDNは画像をキャッシュし、ユーザーAに返す。画像はTTLが執行しない限りキャッシュから返される。
    - CDN利用の注意点:
      - コスト: CDNはサードパーティのプロバイダーによって運営されており、CDNへのデータ転送とCDNからのデータ転送に課金される。使用頻度の低いコンテンツはキャッシュしても大きなメリットはないので、CDNからの移動を検討する。
      - キャッシュの有効期限の適切な設定: 長すぎるとコンテンツが新鮮で無くなる可能性があり、短すぎるとオリジンサーバーからCDNへコンテンツを繰り返し再読み込みする可能性がある。
      - CDNフォールバック: CDNが故障した場合にwebサイトやアプリケーションがどのように対処するか検討する必要がある。クライアントがその問題を検知しオリジンサーバーからリソースをリクエストできるようにする必要がある。
      - ファイルの無効化: 有効期限が切れる前にファイルを削除できる
        - CDNベンダーが提供するAPIでCDNオブジェクトを無効化
        - オブジェクトのバージョニングを使用して、オブジェクトの異なるバージョンを提供する。

- ステートレスアーキテクチャ:

  - <img width="572" alt="image" src="https://github.com/yoshikikasama/system/assets/61643054/097abd19-79e6-4922-9342-aded68ac98b2">
  - 状態データを NoSQL データ、Memcached/Redis などに保持する。

- メッセージキュー: producer と consumer は単独でスケールアップできる。メッセージキューのサイズが大きくなれば、ワーカーを追加して処理時間を短縮できる。

- データベースのスケーリング:
- <img width="826" alt="image" src="https://github.com/yoshikikasama/system/assets/61643054/c3fdc90e-1caa-4835-aa82-0a487dab9684">
  - 垂直スケーリング: CPU, RAM, DISKなどのを追加する
  - 水平スケーリング: サーバー増設。
  - シャーディング: 大規模なDBをより小さく、より管理しやすいシャードというパーツに分割する。各シャードは同じスキーマを共有するが、各シャード上の実際のデータはそのシャード固有となる。
  - シャーディングキー(パーティションキー): データの分散方法を決定する
  - セレブ問題: 特定のシャードへの過度なアクセスはサーバーの過負荷を引き起こす。JB,ガガ, taylorなどのデータが同じシャードに入ってしまうことを例に。

## 2 章 おおまかな見積もり

- 2 のべき乗:

| べき乗 | おおよそのデータ量 | Full name    | Short name |
| ------ | ------------------ | ------------ | ---------- |
| 2^10   | 1000               | 1 キロバイト | 1KB        |
| 2^20   | 100 万             | 1 メガバイト | 1MB        |
| 2^30   | 100 億             | 1 ギガバイト | 1GB        |
| 2^40   | 100 兆             | 1 テラバイト | 1TB        |
| 2^50   | 100 京             | 1 ペタバイト | 1PB        |

- Google のディーン博士が 2010 年における典型的なコンピュータ操作の時間を明らかにしている。レイテンシー数値を可視化。
-
