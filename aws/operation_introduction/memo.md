# AWS 運用入門

## 入門

- 機能要件：システムを使って業務を実行するためのアプリケーション機能やデータそのものの要求を示す。
- 非機能要件：「障害発生によりシステムが停止した場合は 3 時間以内に復旧して欲しい」など業務を安定的に稼働させるためのシステムの維持管理の方針やシステムに対するパフォーマンス要求を示す。

- VPC で使用する IP アドレスの CIDR ブロックは/16 から/28 まで指定できる。

  - RFC1918 に記載されている private ip address 範囲内の CIDR ブロックの使用を推奨している。もし範囲外で VPC を指定するとインターネット内の global ip と重複してサーバーなどと通信できなくなる可能性がある。
  - 10.0.0.0 ~ 10.255.255.255(10.0.0.0/8)
  - 172.16.0.0 ~ 172.31.255.255(172.16.0.0/12)
  - 192.168.0.0 ~ 192.168.255.255(192.168.0.0/16)

- public subnet: インターネットゲートウェイへのルーティングがある
- private subnet: インターネットゲートウェイへのルーティングがない

- セキュリティグループ:
  - 適用範囲：EC2 など AWS リソースにアタッチして利用する仮想 firewall
  - 設定方法：許可した通信のみ通過
  - レスポンス通信：
    - ステートフル: サーバーへのリクエストとの通信(インバウンド)がセキュリティグループのルールで許可されていれば、レスポンスの通信(アウトバウンド)は明示的に許可しなくても通信できる仕組み。
  - ルールの評価：全てのルールをチェックし通信拒否を判断する
- ネットワーク ACL:

  - 適用範囲：サブネットに対する仮想ファイアウォール。
  - 設定方法：拒否したい通信を設定できる
  - レスポンス通信：
    - ステートレス：サーバーへのリクエストの通信をネットワーク ACL のルールで許可していても、レスポンスの通信を明示的に許可しないといけない仕組み
  - ルールの評価：ルール番号の小さい順にチェックし、通信内容に合致するルールで通信可否を判断する

- ネットワーク ACL とセキュリティグループの使い分け:

  - ネットワーク ACL はゆるく制限し、セキュリティグループで厳しく制限すると管理しやすくなる。
  - ファイアウォールのルールを考える際、必要な通信だけ許可して、それ以外の通信は拒否するのが一般的ですが、ネットワーク ACL はステートレスのため、レスポンス通信を厳密に制御しようとするとエフェラルポートを考慮するため制限するポート数が増え、非常に大変。また、ネットワーク ACL はルール数が最大 40 までと制限されているため、全てのルールを入れることができなくなる。
  - そのため、たとえば web サーバーだけしかないときは、ネットワーク ACL をのインバウンドで「TCP80 番 port」を許可し、アウトバウンドは「全ての通信を許可」のように緩く制限し、各 EC2 インスタンスへの通信をセキュリティグループで細かく制限すると運用負荷を軽減して比較的安全に運用できる。
  - <img width="909" alt="Screenshot 2023-10-08 at 11 29 13" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/58ebfee3-7018-4d7e-b41d-31b103cebccb">

- エフェメラルポート：通信時にクライアント側で一時的に利用されるポート番号(1024~ 65535)

### EC2 インスタンス

- t2.micro

  - t: 種別
  - 2: 世代
  - micro: インスタンスサイズ

- ENI(Elastic Network Interface): PC の LAN ケーブルの差し込み口のイメージ。AWS では ENI に EC2 の IP アドレスを紐づけてネットワーク通信を行う。

  - <img width="875" alt="Screenshot 2023-10-08 at 11 29 23" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/5f552c76-eb5c-4e53-97c9-f3788fd0094b">

- EBS: ディスクサイズで課金される。

### S3

- <img width="855" alt="Screenshot 2023-10-08 at 21 07 18" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/c65883ca-1c7a-46e2-9582-16992aff8431">

### RDS

- RDS のストレージの比較:

| ストレージタイプ  | 汎用 SSD (gp2/gp3) | プロビジョンド IOPS SSD (io1)     | マグネティック   |
| ----------------- | ------------------ | --------------------------------- | ---------------- |
| 媒体              | SSD                | SSD                               | ハードディスク   |
| 容量範囲          | あり (GB あたり)   | あり (GB あたり)                  | あり (GB あたり) |
| IOPS キャパシティ | なし※              | あり (IOPS あたり)                | なし             |
| IO リクエスト料金 | なし               | なし                              | あり             |
| 性能              | 100-16,000 IOPS    | 1,000-256,000 IOPS (MySQL の場合) | 最大 1,000 IOPS  |

※汎用 SSD (gp3) でベースラインパフォーマンスを超える必要がある場合は IOPS キャパシティが有料となります。

- マグネティックは下位互換のために用意されているため、基本的には汎用 SSD かプロビジョンド IOPS SSD を選択する。
- IOPS(Input/Output Per Second)とは、ストレージに 1 秒間に読み書きできる回数のことで値が大きいほど性能は高くなる。
- 頻繁に読み書きが発生する場合は、プロビジョンド IOPS SSD を使用し、ストレージの処理がボトルネックにならないようにする。
- RDS フェールオーバーの仕組み: <img width="995" alt="Screenshot 2023-10-08 at 21 30 50" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/8b771380-dc91-41ba-aa99-f759733db8a2">

- DB サブネットグループ: DB インスタンスを配置するサブネットを指定する設定で、DB インスタンスを作成する前に作成しておく。最低でも 2 つの AZ をのサブネットを登録する必要がある。

- RDS のリストア:
  - スナップショット
  - ポイントインタイムリカバリ: 自動バックアップを使って 5 分以上前の指定した時間お状態の DB インスタンスを作成する方法。最大 35 日間まで。

### ELB

- ALB: 主に web サーバーの負荷分散に利用。
  - パスベースルーティングの負荷分散が可能。接続先 URLhttp://example.comに対してパスにcorpとrecruitが含まれるときにcorpは左、recruiteは右のサーバーに転送するようにURL中に含まれるパスによって転送するサーバーを変えることができる。
  - <img width="1018" alt="Screenshot 2023-10-09 at 8 33 48" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/1d6c33a0-dc54-415b-b59a-9232fbf88470">
- NLB: OSI 参照モデルのレイヤー 4 であるトランスポート層で機能し、主に web サーバー以外の負荷分散に使用する。低レイテンシーで高スループットな処理が可能。

- リスナー: ALB がどのような通信を受け付け、どこに転送するかを決める設定。(HTTP もしくは HTTPS)+port 番号を設定する。
- ターゲットグループ: 負荷分散対象サーバーをまとめたグループ。
- ヘルスチェック: ALB がターゲットグループ内のターゲットに対して定期的にチェックを行い、正常に稼働しているかを確認する機能。

- ヘルスチェックで監視できる項目

| 項目           | 説明                                                                     | デフォルト値 (ALB) |
| -------------- | ------------------------------------------------------------------------ | ------------------ |
| プロトコル     | ヘルスチェック時にロードバランサーが使用するプロトコル                   | HTTP               |
| パス           | ヘルスチェック配置先のパス                                               | /                  |
| ポート         | ヘルスチェック時にロードバランサーが使用するポート                       | トラフィックポート |
| 正常のしきい値 | 非正常なターゲットを正常とみなすための、ヘルスチェックの連続成功回数     | 5                  |
| 異常のしきい値 | ターゲットを異常とみなすための、ヘルスチェックの連続失敗回数             | 2                  |
| タイムアウト   | ヘルスチェックを失敗とみなすまでの、ターゲットからのレスポンスがない時間 | 5 (秒)             |
| 間隔           | ターゲットのヘルスチェックの概算間隔                                     | 30 (秒)            |
| 成功コード     | ターゲットからの正常なレスポンスの確認に使う HTTP コード                 | 200                |

## IAM

- 信頼ポリシーの設定

| 要素      | 説明                                   | 記述内容の説明                                                               |
| --------- | -------------------------------------- | ---------------------------------------------------------------------------- |
| Version   | ポリシーバージョンを指定　             | '2012-10-17' の現行 version 指定。AWS で決められた構文のルールのバージョン。 |
| Statement | ポリシーを記述することを宣言           | 具体的なポリシーを定義することを宣言                                         |
| Effect    | 許可を許可 (Allow)                     | 操作を許可。信頼ポリシーでは Allow のみ記述する。                            |
| Principal | どのサービスへ委任 (アタッチ) できるか | 例では EC2 ("Service": "ec2.amazonaws.com") を指定。                         |
| Action    | 指定的な操作内容                       | 信頼ポリシーでは特定の実行 (sts:AssumeRole) のみ許可される                   |

- IAM policy の 3 分類

| ポリシー分類           | 権限                                                                                                                                                                |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| AWS 管理ポリシー       | • AWS が提供するポリシー群で標準の IAM エンティティで使い回しが可能 <br> • IAM ユーザーによる編集はできない                                                         |
| カスタマー管理ポリシー | • ユーザーが作成するポリシー群で標準の IAM エンティティで使い回し可能 <br> • IAM ユーザーによる編集が可能であるため必要に応じてポリシーの追加/削除/修正が可能       |
| インラインポリシー     | • IAM エンティティ固有のポリシー群で標準の IAM エンティティの使い回しはできない <br> • ユーザーによる編集が可能であるため必要に応じてポリシーの追加/削除/修正が可能 |

- 複数の AWS アカウントを所有するメリット
  - アカウントごとに料金を管理できる。
  - アカウントごとに利用者のアクセスを管理できる。
  - アカウントをわけることで、ユーザーの誤操作を防ぐ。
- 踏み台アカウント運用
  - ![1000001628](https://github.com/yoshikikasama/network-and-server/assets/61643054/45929508-2f5e-490d-95fc-4a2e7554e4c1)
  - ![1000001629](https://github.com/yoshikikasama/network-and-server/assets/61643054/e17f23c0-cf1d-4c09-ba1b-394cf1d4755d)
- IAM グループの IAM policy で特定の役割をもつユーザー郡に対するロールの切り替えを制御する。

- アカウント運用のサンプルアーキテクチャ:

  - ![1000001631](https://github.com/yoshikikasama/network-and-server/assets/61643054/66ff9166-d587-4d45-bede-cfa020cbc930)

- IAM Policy simulator: 付与した権限を評価する対象の IAM エンティティと AWS サービス・リソースやアクションを選択しシミュレーションを実行することで、評価対象の IAM エンティティが対象 AWS サービス·リソースへのアクションが許可されているか否かを検証することができる。

## ログ運用

- ログ運用の 4 つの観点:
  - ログ設定:
    - 取得/管理ログのリストアップ
    - ログ出力設定
    - ログローテーション
  - ログ転送:
    - ログ転送先の検討
    - ログ転送設定
  - ログ保管:
    - ログ保管先の検討
    - ログ保管期間の検討
  - ログ利用:
    - ログの閲覧、分析
    - ログの利用
- AWS アカウントに関する取得可能なログの一例:

| ログの種類   | 記録する情報                                                             | AWS ツール     |
| ------------ | ------------------------------------------------------------------------ | -------------- |
| 途中ログ     | AWS アカウント上の操作履歴を記録                                         | AWS CloudTrail |
| 認証ログ     | いつ、どの認証情報 (IAM) を用いて AWS アカウントにアクセスしたのかを記録 | AWS CloudTrail |
| アクセスログ | どの認証情報 (IAM) を用いて AWS サービスにアクセスしたのかを記録         | AWS CloudTrail |
| 設定変更ログ | AWS アカウント上で設定変更した際の内容を記録                             | AWS Config     |
| エラーログ   | AWS アカウント上で発生した API エラーを記録                              | AWS CloudTrail |

- AWS リソースに関する取得可能なログの一例

| ログの種類   | 記録する情報                                     | AWS ツール                                          |
| ------------ | ------------------------------------------------ | --------------------------------------------------- |
| 操作ログ     | AWS リソース上での操作履歴を記録                 | Amazon EC2<br>Amazon RDS                            |
| 認証ログ     | いつ、誰が、AWS リソースにログインしたのかを記録 | Amazon EC2<br>Amazon RDS                            |
| アクセスログ | AWS リソースへの接続履歴を記録                   | Amazon EC2<br>Amazon RDS<br>Amazon ELB<br>Amazon S3 |
| イベントログ | AWS リソースで発生した事件や動作を記録           | Amazon EC2<br>Amazon RDS<br>Amazon GuardDuty        |
| 通信ログ     | 端末とサーバー間、AWS リソース間の通信内容を記録 | VPC Flow Logs<br>AWS WAF                            |
| 設定変更ログ | AWS リソースで設定変更した際の内容を記録         | Amazon EC2<br>Amazon RDS                            |
| エラーログ   | AWS リソース上でエラーが発生した時の記録         | Amazon EC2<br>Amazon RDS                            |

- 4 つの観点と関連する AWS サービス

| 項目     | 記録する AWS ツール                                     |
| -------- | ------------------------------------------------------- |
| ログ収集 | • Amazon CloudWatch Logs (統合 CloudWatch モニタリング) |
| ログ転送 | • Amazon Kinesis Data Firehose                          |
| ログ保管 | • Amazon S3 <br>• Amazon CloudWatch Logs                |
| ログ利用 | • Amazon CloudWatch Logs Insights<br>• Amazon Athena    |

### Amazon CloudWatch

- EC2 インスタンスをはじめとした AWS リソースと AWS 上で稼働しているアプリケーションをモニタリングし、システムのパフォーマンスやリソース使用率の最適化を行うために必要な判断材料(データ)を提供する。

- CloudWatch の主な機能：

| 名称                                                      | 機能説明                                                                                             | 利用例                                                                                  |
| --------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| CloudWatch Metrics（ログ保管)                             | AWS リソースのメトリクスを収集・管理する                                                             | ・EC2 の CPU 使用率を取得する<br>・RDS のストレージ空き容量を取得する                   |
| CloudWatch Logs （ログ保管)                               | AWS リソースのログを収集・管理する<br>（統合 CloudWatch エージェントを利用）                         | ・EC2 の OS ログを取得する<br>・RDS のエラーログを取得する                              |
| CloudWatch Logs<br>サブスクリプションフィルター(ログ転送) | CloudWatch Logs に出力されたログをリアルタイムに Kinesis Data Firehose などの AWS サービスに連携する | ・ロググループに保存されているログを Kinesis Data Firehose 経由で S3 に転送する         |
| CloudWatch Logs Insights (ログ利用)                       | CloudWatch Logs に収集されたログに対してクエリを実行することでログ分析を行う                         | ・VPC Flow Logs のログに対してクエリを実行し、Reject された送信元 IP アドレスを調査する |
| EventBridge<br>(旧: CloudWatch Events)                    | AWS リソースの状態(イベント)を監視する。イベントの変化をトリガーに処理を実行することも可能           | ・EC2 の設定変更（イベント）をトリガーにしてメールで変更通知を行う                      |

※ メトリクスとは定量化したデータを加工し、評価や分析に適した形式に変換したもの。

- Amazon CloudWatch Logs における 3 つの構成要素：

| コンポーネント | 説明                                                                                                                     | 利用例                                                                                                                     |
| -------------- | ------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------- |
| ログインベント | モニタリングされているアプリケーションまたは AWS リソースによって記録されたアクティビティのログデータ                    | CloudWatch Logs に実際に出力された EC2 インスタンスのログを閲覧する                                                        |
| ログストリーム | モニタリングされているアプリケーションや AWS リソースから送信された順序に従って集約された一連のログイベント              | ロググループ内で EC2 インスタンスにごとにログイベントの集約先を分ける。                                                    |
| ロググループ   | ログストリームをグループピングしたもので、ログストリーム群に対してログイベントの保持期間などを一元的に設定することが可能 | CloudWatch Logs にログを出力する際、ログ出力先として指定して保存する 。 CloudWatch Logs に出力されたログに保持期間を設ける |

- 統合 CloudWatch エージェント:

  - EC2 のように OS やソフトウェアでの運用管理を利用者側で実施する必要があるサービスについては、利用者が OS 上でログの取得設定を実施する必要がある。
  - EC2 インスタンスのログを CloudWatch Logs へ出力するためには統合 CloudWatch エージェントと呼ばれるミドルウェアを EC2 インスタンスにインストールした上で各種設定を行う。
  - EC2 インスタンスの詳細なメトリクスを収集したり、ログを CloudWatch Logs に出力したりすることを可能にする。
  - 設定順序:
    - Internet Gateway や NAT Gateway を利用して EC2 インスタンスがインターネットと通信することができるネットワーク経路を確保する。
    - EC2 インスタンスから CloudWatch および CloudWatch Logs に対する一部操作を許可する必要がある。

- CloudWatch Logs の利用料金：
  - ログデータの保管料より取り込み料金の方が高くなる。
  - <img width="532" alt="Screenshot 2023-11-05 at 14 15 16" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/1e2fee2b-1991-4051-83e2-49b100f3add2">
- CloudWatch Logs Insights: CloudWatch Logs のロググループに対してクエリを実行することで、ログデータを分析したり、問題発生時の原因調査(トラブルシューティング)に利用したりすることができる機能。

### Amazon Kinesis

- 大規模なストリーミングデータ（継続的に生成されるデータ）をリアルタイムで収集・処理するサービス。

  - データの順序: iterator と呼ばれるシーケンス番号を割り当てることでデータの順序を適切に管理することができる。
  - データの処理能力: 従量課金
  - 拡張性: 従量課金

  | サービス                      | 説明                                                                                                                                                                                                                                                               |
  | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
  | Amazon Kinesis Data Streams   | ストリーミングデータをリアルタイムでキャプチャ・処理・保存することが可能                                                                                                                                                                                           |
  | Amazon Kinesis Data Firehose  | ストリーミングデータを S3 などのデータストア、Datadog や Splunk などのサードパーティー製の分析ツールへ配信することが可能                                                                                                                                           |
  | Amazon Kinesis Data Analytics | ストリーミングデータに対してクエリを実行し、リアルタイム分析を行うことが可能。データソースは Kinesis Data Streams または Kinesis Data Firehose のいずれかを選択、実行したクエリ結果は Kinesis Data Streams や Kinesis Data Firehose、S3 などに出力することが可能。 |
  | Amazon Kinesis Video Streams  | AWS によって用意されている SDK を利用して防犯カメラ・スマートフォン・ドローン・センサーなどの動画撮影デバイスからストリーミングデータをキャプチャ・処理・保存することが可能                                                                                        |

- Amazon Kinesis Data Firehose:

  - <img width="876" alt="Screenshot 2023-11-05 at 15 34 35" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/30770ff1-1147-4736-91c0-2226fd0e6763">
  - distination に応じて配信ストリームを個別に作成する。転送するデータを振り分ける管のようなもの。

  ### Amazon Athena

  - 標準的な SQL を使用して S3 Bucket 内のデータソースに対してクエリを実行することができるサービス。
  - Athena で S3 Bucket 上のデータを参照するには:
    - データを S3 Bucket に保存
    - DB および table を定義する
    - SerDe(Serialize/Deserialize)というデータ処理をする。
      - Serialize: オブジェクトをバイト列に変換する処理
      - Deserialize: バイト列から元のオブジェクトを復元する処理
    - Athena がサポートしている圧縮形式。
    - 実行した table 定義の情報は AWS Glue Data Catalog と呼ばれるメタデータを管理する場所に保存される。

- CloudWatch Logs Insights と Athena の使い分け:
  - <img width="544" alt="Screenshot 2023-11-05 at 16 09 55" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/e28978a0-4078-4e71-b705-6635c5c62aa9">
  - <img width="545" alt="Screenshot 2023-11-05 at 16 09 47" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/b0bb35d0-51b0-4b05-af4f-5940fe62e9bd">

### ログ運用のサンプルアーキテクチャ

- <img width="868" alt="Screenshot 2023-11-05 at 16 16 34" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/299cb98c-d4aa-4738-ac14-0961adef431d">

  - インターネット公開する web アプリケーションをデプロイする環境を Web3 層アーキテクチャで構築することを想定しています。
  - Protected Subnet: NAT Gateway を経由してインターネットと接続可能なネットーワーク(DMZ)。
  - 各 AWS サービスから出力されるログに関しては、のちのログ利用を想定し、コストパフォーマンスが高い S3 への長期保管を意識した設計としています。
  - EC2 と Amazon Aurora は S3 と統合されていないため、Kinesis Data Firehose 経由で CloudWatch Logs から S3 Bucket へログを転送している。
  - VPC Flow Logs は直近出力された少量のログ利用ならびにログの長期保管の観点から、CloudWatch Logs と S3 の両方にログを出力する設計としています。
  - AWS 利用料の観点で、S3 のライフサイクルポリシーを設定し、必要に応じて S3 Glacier Flexible Retrieval をはじめとしたストレージクラスにアーカイブしたり、一定期間保管後にオブジェクトを削除したりすることを推奨します。

| ログ取得対象  | 取得用途                              | ログ保管場所                         | ログ利用方法                                            |
| ------------- | ------------------------------------- | ------------------------------------ | ------------------------------------------------------- |
| ALB           | アクセスログ                          | S3                                   | Athena                                                  |
| EC2           | OS ログの取得<br>アプリケーションログ | CloudWatch Logs<br> S3（長期保管用） | CloudWatch Logs <br>CloudWatch Logs Insights<br> Athena |
| Amazon Aurora | DB ログ                               | CloudWatch Logs<br> S3（長期保管用） | CloudWatch Logs <br>CloudWatch Logs Insights<br> Athena |
| VPC Flow Logs | 通信ログ                              | CloudWatch Logs<br> S3（長期保管用） | CloudWatch Logs <br>CloudWatch Logs Insights<br> Athena |

- EC2 インスタンスの台数が多い場合の「EC2 のログ取得設定」：

  - EC2 インスタンスが SSM のマネージドノードである必要がある。
    - SSM の管理下に置かれたマネージドノードは SSM のフリートマネージャーで確認可能。
  - SSM と EC2 インスタンス間でコマンドを送受信するための通信経路の確保が必要。
  - EC2 インスタンスに SSM エージェントをインストールすること。
  - SSM の region endpoint との通信経路を確保すること。
  - IAM Role を利用して EC2 インスタンスが SSM と通信するために必要な権限を付与すること。

- CloudWatch Logs のログを Kinesis Data Firehose を経由して S3 へ出力する:

  - S3 Bucket 作成
  - Kinesis Data Firehose で配信ストリーム作成
  - CloudWatch Logs サブスクリプションフィルター作成

- 信頼ポリシー:

  - sts: AWS Security Token Service を示しており、各種 AWS リソースへのアクセスをコントロールする一時的な認証情報を発行するサービス。
  - AssumeRole: STS に対して一時的な認証情報(IAM Role にアタッチされた IAM policy)の提供をリクエストする操作。一時的な認証情報を用いて AWS リソースが別のリソースを操作する。

- CloudWatch Logs が Kinesis Data Firehose の配信ストリームに対して操作を許可するための信頼ポリシー:
  - CloudWatch Logs では region の記述を含む
  - Condition 句で同一アカウント同一 region に存在する CloudWatchLogs に限定している理由は、混乱する代理問題を回避するため。AWS サービス間での不正アクセスに関する問題。
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/confused-deputy.html

```
{
  "version":"2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Principal":{
      "Service": "logs.ap-northeast-1.amazonaws.com"
    },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringLike": {
        "aws:SourceArn": "aen:aws:logs:ap-northeast-1:アカウントID:*"
      }
    }
  }
}

```

### AWS SSM

- AWS Systems Manager Prameter Store: SSM が提供している機能の一つで、設定データおよび機密データをパラメータ(値)として安全に管理するためのストレージを提供している。

  - パラメータの version 管理が可能。
  - プログラムのコードと設定データを分離して管理できること。
  - IAM を利用することでパラメータへのアクセス制御が可能。

- AWS Systems manager Run Command: EC2 インスタンスに OS ログインすることなくコマンドやスクリプトをリモートで実行することができる。
  - AWS-ConfigureAWSPackage: 統合 CloudWatch エージェントをはじめとしたパッケージのインストール、アンインストールを実施するコマンドドキュメント。
  - AmazonCloudWatch-ManageAgent: Amazon CloudWatch Agent にコマンドを送信する(設定を適用)するコマンドドキュメント
- SSM エージェント:
  - EC2 インスタンス、エッジデバイス、オンプレミスサーバー、および仮想マシン上で動作するミドルウェアで、DDM によるサーバーの更新・管理を実現する。
  - EC2 にインストールされた SSM エージェントは、AWS リージョン後よに存在する SSM の region endpoint に対してポーリングを実行します。このポーリングによって、SSM エージェントは SSM からコマンド実行などの指示を受け付ける。
  - ポーリングの問い合わせ先となる SSM の region endpoint はインターネット上に存在するため、EC2 インスタンスに Internet Gateway を経由したアウトバウンド通信をあらかじめ許可しておきます。
  - VPC Endpoint を利用すると VPC 内の AWS リソースと VPC 外のリソースとの通信を、インターネットを経由することなく接続できるようになる。VPC Endpoint を活用して SSM の region endpoint と通信することも可能。

## 監視

- 監視: 各コンポーネントから情報を計測・収集し、問題が起こった場合に意いち早く知ること。

- メトリクス：「いつ」「何が」「どういう状態・値であったのか」の情報。

- CloudWatch Alarm:

  - 期間: アラームの閾値の範囲内か範囲外か評価する間隔。評価された時点は「データポイント」と呼ばれる。
  - Evaluation Period: アラームの評価の対象となる直近のデータポイント数。
  - Datapoints to Alarm: Evaluation Period のうちアラームの状態を決定するのに必要なデータポイント数。

- 例えば期間が 3 分で Evaluation Period が 10 の場合、評価対象期間は直近の 3\*10=30 分となります。
- Datapoints to Alarm を 8 とすると 3 分おきメトリクスが評価され直近 30 分の評価対象期間のうち 8 回閾値の範囲外となればアラームの状態が変化することになる。
- ![PXL_20231216_224433689 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/0fde75a7-0cb7-445f-ab02-ebc667a734ee)
- ![PXL_20231216_231746824 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/90e4a794-05a1-45e3-a44d-90060bd72dda)


