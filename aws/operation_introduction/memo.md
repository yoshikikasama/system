# AWS 運用入門

## 入門

- 機能要件：システムを使って業務を実行するためのアプリケーション機能やデータそのものの要求を示す。
- 非機能要件：「障害発生によりシステムが停止した場合は 3 時間以内に復旧して欲しい」など業務を安定的に稼働させるためのシステムの維持管理の方針やシステムに対するパフォーマンス要求を示す。

- VPC で使用する IP アドレスの CIDR ブロックは/16 から/28 まで指定できる。

  - RFC1918 に記載されている private ip address 範囲内の CIDR ブロックの使用を推奨している。もし範囲外で VPC を指定するとインターネット内の global ip と重複してサーバーなどと通信できなくなる可能性がある。
  - 10.0.0.0 ~ 10.255.255.255(10.0.0.0/8)
  - 172.16.0.0 ~ 172.31.255.255(172.16.0.0/12)
  - 192.168.0.0 ~ 192.168.255.255(192.168.0.0/16)

- public subnet: インターネットゲートウェイへのルーティングがある
- private subnet: インターネットゲートウェイへのルーティングがない

- セキュリティグループ:
  - 適用範囲：EC2 など AWS リソースにアタッチして利用する仮想 firewall
  - 設定方法：許可した通信のみ通過
  - レスポンス通信：
    - ステートフル: サーバーへのリクエストとの通信(インバウンド)がセキュリティグループのルールで許可されていれば、レスポンスの通信(アウトバウンド)は明示的に許可しなくても通信できる仕組み。
  - ルールの評価：全てのルールをチェックし通信拒否を判断する
- ネットワーク ACL:

  - 適用範囲：サブネットに対する仮想ファイアウォール。
  - 設定方法：拒否したい通信を設定できる
  - レスポンス通信：
    - ステートレス：サーバーへのリクエストの通信をネットワーク ACL のルールで許可していても、レスポンスの通信を明示的に許可しないといけない仕組み
  - ルールの評価：ルール番号の小さい順にチェックし、通信内容に合致するルールで通信可否を判断する

- ネットワーク ACL とセキュリティグループの使い分け:

  - ネットワーク ACL はゆるく制限し、セキュリティグループで厳しく制限すると管理しやすくなる。
  - ファイアウォールのルールを考える際、必要な通信だけ許可して、それ以外の通信は拒否するのが一般的ですが、ネットワーク ACL はステートレスのため、レスポンス通信を厳密に制御しようとするとエフェラルポートを考慮するため制限するポート数が増え、非常に大変。また、ネットワーク ACL はルール数が最大 40 までと制限されているため、全てのルールを入れることができなくなる。
  - そのため、たとえば web サーバーだけしかないときは、ネットワーク ACL をのインバウンドで「TCP80 番 port」を許可し、アウトバウンドは「全ての通信を許可」のように緩く制限し、各 EC2 インスタンスへの通信をセキュリティグループで細かく制限すると運用負荷を軽減して比較的安全に運用できる。
  - <img width="909" alt="Screenshot 2023-10-08 at 11 29 13" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/58ebfee3-7018-4d7e-b41d-31b103cebccb">

- エフェメラルポート：通信時にクライアント側で一時的に利用されるポート番号(1024~ 65535)

### EC2 インスタンス

- t2.micro

  - t: 種別
  - 2: 世代
  - micro: インスタンスサイズ

- ENI(Elastic Network Interface): PC の LAN ケーブルの差し込み口のイメージ。AWS では ENI に EC2 の IP アドレスを紐づけてネットワーク通信を行う。

  - <img width="875" alt="Screenshot 2023-10-08 at 11 29 23" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/5f552c76-eb5c-4e53-97c9-f3788fd0094b">

- EBS: ディスクサイズで課金される。

### S3

- <img width="855" alt="Screenshot 2023-10-08 at 21 07 18" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/c65883ca-1c7a-46e2-9582-16992aff8431">

### RDS

- RDS のストレージの比較:

| ストレージタイプ  | 汎用 SSD (gp2/gp3) | プロビジョンド IOPS SSD (io1)     | マグネティック   |
| ----------------- | ------------------ | --------------------------------- | ---------------- |
| 媒体              | SSD                | SSD                               | ハードディスク   |
| 容量範囲          | あり (GB あたり)   | あり (GB あたり)                  | あり (GB あたり) |
| IOPS キャパシティ | なし※              | あり (IOPS あたり)                | なし             |
| IO リクエスト料金 | なし               | なし                              | あり             |
| 性能              | 100-16,000 IOPS    | 1,000-256,000 IOPS (MySQL の場合) | 最大 1,000 IOPS  |

※汎用 SSD (gp3) でベースラインパフォーマンスを超える必要がある場合は IOPS キャパシティが有料となります。

- マグネティックは下位互換のために用意されているため、基本的には汎用 SSD かプロビジョンド IOPS SSD を選択する。
- IOPS(Input/Output Per Second)とは、ストレージに 1 秒間に読み書きできる回数のことで値が大きいほど性能は高くなる。
- 頻繁に読み書きが発生する場合は、プロビジョンド IOPS SSD を使用し、ストレージの処理がボトルネックにならないようにする。
- RDS フェールオーバーの仕組み: <img width="995" alt="Screenshot 2023-10-08 at 21 30 50" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/8b771380-dc91-41ba-aa99-f759733db8a2">

- DB サブネットグループ: DB インスタンスを配置するサブネットを指定する設定で、DB インスタンスを作成する前に作成しておく。最低でも 2 つの AZ をのサブネットを登録する必要がある。

- RDS のリストア:
  - スナップショット
  - ポイントインタイムリカバリ: 自動バックアップを使って 5 分以上前の指定した時間お状態の DB インスタンスを作成する方法。最大 35 日間まで。

### ELB

- ALB: 主に web サーバーの負荷分散に利用。
  - パスベースルーティングの負荷分散が可能。接続先 URLhttp://example.comに対してパスにcorpとrecruitが含まれるときにcorpは左、recruiteは右のサーバーに転送するようにURL中に含まれるパスによって転送するサーバーを変えることができる。
  - <img width="1018" alt="Screenshot 2023-10-09 at 8 33 48" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/1d6c33a0-dc54-415b-b59a-9232fbf88470">

## IAM

- 信頼ポリシーの設定
  - ![1000001626](https://github.com/yoshikikasama/network-and-server/assets/61643054/30da8b35-e6f3-46d2-96e1-9a27a0173022) 
- IAM policyの3分類
  - ![1000001627](https://github.com/yoshikikasama/network-and-server/assets/61643054/e0b3baca-3855-4fb2-9569-8256ffa7e38c)


- 複数のAWSアカウントを所有するメリット
  - アカウントごとに料金を管理できる。
  - アカウントごとに利用者のアクセスを管理できる。
  - アカウントをわけることで、ユーザーの誤操作を防ぐ。
- 踏み台アカウント運用
  - ![1000001628](https://github.com/yoshikikasama/network-and-server/assets/61643054/45929508-2f5e-490d-95fc-4a2e7554e4c1)
  - ![1000001629](https://github.com/yoshikikasama/network-and-server/assets/61643054/e17f23c0-cf1d-4c09-ba1b-394cf1d4755d)
- IAMグループのIAM policyで特定の役割をもつユーザー郡に対するロールの切り替えを制御する。

- アカウント運用のサンプルアーキテクチャ:
  - ![1000001631](https://github.com/yoshikikasama/network-and-server/assets/61643054/66ff9166-d587-4d45-bede-cfa020cbc930)

- IAM Policy simulator: 付与した権限を評価する対象のIAMエンティティとAWSサービス・リソースやアクションを選択しシミュレーションを実行することで、評価対象のIAMエンティティが対象AWSサービス·リソースへのアクションが許可されているか否かを検証することができる。

## ログ運用

- ログ運用の4つの観点:
  - ログ設定:
    - 取得/管理ログのリストアップ
    - ログ出力設定
    - ログローテーション
  - ログ転送:
    - ログ転送先の検討
    - ログ転送設定
  - ログ保管:
    - ログ保管先の検討
    - ログ保管期間の検討
  - ログ利用:
    - ログの閲覧、分析
    - ログの利用
