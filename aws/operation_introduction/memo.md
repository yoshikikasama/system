# AWS 運用入門

## 入門

- 機能要件：システムを使って業務を実行するためのアプリケーション機能やデータそのものの要求を示す。
- 非機能要件：「障害発生によりシステムが停止した場合は 3 時間以内に復旧して欲しい」など業務を安定的に稼働させるためのシステムの維持管理の方針やシステムに対するパフォーマンス要求を示す。

- VPC で使用する IP アドレスの CIDR ブロックは/16 から/28 まで指定できる。

  - RFC1918 に記載されている private ip address 範囲内の CIDR ブロックの使用を推奨している。もし範囲外で VPC を指定するとインターネット内の global ip と重複してサーバーなどと通信できなくなる可能性がある。
  - 10.0.0.0 ~ 10.255.255.255(10.0.0.0/8)
  - 172.16.0.0 ~ 172.31.255.255(172.16.0.0/12)
  - 192.168.0.0 ~ 192.168.255.255(192.168.0.0/16)

- public subnet: インターネットゲートウェイへのルーティングがある
- private subnet: インターネットゲートウェイへのルーティングがない

- セキュリティグループ:
  - 適用範囲：EC2 など AWS リソースにアタッチして利用する仮想 firewall
  - 設定方法：許可した通信のみ通過
  - レスポンス通信：
    - ステートフル: サーバーへのリクエストとの通信(インバウンド)がセキュリティグループのルールで許可されていれば、レスポンスの通信(アウトバウンド)は明示的に許可しなくても通信できる仕組み。
  - ルールの評価：全てのルールをチェックし通信拒否を判断する
- ネットワーク ACL:

  - 適用範囲：サブネットに対する仮想ファイアウォール。
  - 設定方法：拒否したい通信を設定できる
  - レスポンス通信：
    - ステートレス：サーバーへのリクエストの通信をネットワーク ACL のルールで許可していても、レスポンスの通信を明示的に許可しないといけない仕組み
  - ルールの評価：ルール番号の小さい順にチェックし、通信内容に合致するルールで通信可否を判断する

- ネットワーク ACL とセキュリティグループの使い分け:

  - ネットワーク ACL はゆるく制限し、セキュリティグループで厳しく制限すると管理しやすくなる。
  - ファイアウォールのルールを考える際、必要な通信だけ許可して、それ以外の通信は拒否するのが一般的ですが、ネットワーク ACL はステートレスのため、レスポンス通信を厳密に制御しようとするとエフェラルポートを考慮するため制限するポート数が増え、非常に大変。また、ネットワーク ACL はルール数が最大 40 までと制限されているため、全てのルールを入れることができなくなる。
  - そのため、たとえば web サーバーだけしかないときは、ネットワーク ACL をのインバウンドで「TCP80 番 port」を許可し、アウトバウンドは「全ての通信を許可」のように緩く制限し、各 EC2 インスタンスへの通信をセキュリティグループで細かく制限すると運用負荷を軽減して比較的安全に運用できる。
  - <img width="909" alt="Screenshot 2023-10-08 at 11 29 13" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/58ebfee3-7018-4d7e-b41d-31b103cebccb">

- エフェメラルポート：通信時にクライアント側で一時的に利用されるポート番号(1024~ 65535)

### EC2 インスタンス

- t2.micro

  - t: 種別
  - 2: 世代
  - micro: インスタンスサイズ

- ENI(Elastic Network Interface): PC の LAN ケーブルの差し込み口のイメージ。AWS では ENI に EC2 の IP アドレスを紐づけてネットワーク通信を行う。

  - <img width="875" alt="Screenshot 2023-10-08 at 11 29 23" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/5f552c76-eb5c-4e53-97c9-f3788fd0094b">

- EBS: ディスクサイズで課金される。

### S3

- <img width="855" alt="Screenshot 2023-10-08 at 21 07 18" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/c65883ca-1c7a-46e2-9582-16992aff8431">

### RDS

- RDS のストレージの比較:

| ストレージタイプ  | 汎用 SSD (gp2/gp3) | プロビジョンド IOPS SSD (io1)     | マグネティック   |
| ----------------- | ------------------ | --------------------------------- | ---------------- |
| 媒体              | SSD                | SSD                               | ハードディスク   |
| 容量範囲          | あり (GB あたり)   | あり (GB あたり)                  | あり (GB あたり) |
| IOPS キャパシティ | なし※              | あり (IOPS あたり)                | なし             |
| IO リクエスト料金 | なし               | なし                              | あり             |
| 性能              | 100-16,000 IOPS    | 1,000-256,000 IOPS (MySQL の場合) | 最大 1,000 IOPS  |

※汎用 SSD (gp3) でベースラインパフォーマンスを超える必要がある場合は IOPS キャパシティが有料となります。

- マグネティックは下位互換のために用意されているため、基本的には汎用 SSD かプロビジョンド IOPS SSD を選択する。
- IOPS(Input/Output Per Second)とは、ストレージに 1 秒間に読み書きできる回数のことで値が大きいほど性能は高くなる。
- 頻繁に読み書きが発生する場合は、プロビジョンド IOPS SSD を使用し、ストレージの処理がボトルネックにならないようにする。
- RDS フェールオーバーの仕組み: <img width="995" alt="Screenshot 2023-10-08 at 21 30 50" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/8b771380-dc91-41ba-aa99-f759733db8a2">

- DB サブネットグループ: DB インスタンスを配置するサブネットを指定する設定で、DB インスタンスを作成する前に作成しておく。最低でも 2 つの AZ をのサブネットを登録する必要がある。

- RDS のリストア:
  - スナップショット
  - ポイントインタイムリカバリ: 自動バックアップを使って 5 分以上前の指定した時間お状態の DB インスタンスを作成する方法。最大 35 日間まで。

### ELB

- ALB: 主に web サーバーの負荷分散に利用。
  - パスベースルーティングの負荷分散が可能。接続先 URLhttp://example.comに対してパスにcorpとrecruitが含まれるときにcorpは左、recruiteは右のサーバーに転送するようにURL中に含まれるパスによって転送するサーバーを変えることができる。
  - <img width="1018" alt="Screenshot 2023-10-09 at 8 33 48" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/1d6c33a0-dc54-415b-b59a-9232fbf88470">
- NLB: OSI 参照モデルのレイヤー 4 であるトランスポート層で機能し、主に web サーバー以外の負荷分散に使用する。低レイテンシーで高スループットな処理が可能。

- リスナー: ALB がどのような通信を受け付け、どこに転送するかを決める設定。(HTTP もしくは HTTPS)+port 番号を設定する。
- ターゲットグループ: 負荷分散対象サーバーをまとめたグループ。
- ヘルスチェック: ALB がターゲットグループ内のターゲットに対して定期的にチェックを行い、正常に稼働しているかを確認する機能。

- ヘルスチェックで監視できる項目

| 項目           | 説明                                                                     | デフォルト値 (ALB) |
| -------------- | ------------------------------------------------------------------------ | ------------------ |
| プロトコル     | ヘルスチェック時にロードバランサーが使用するプロトコル                   | HTTP               |
| パス           | ヘルスチェック配置先のパス                                               | /                  |
| ポート         | ヘルスチェック時にロードバランサーが使用するポート                       | トラフィックポート |
| 正常のしきい値 | 非正常なターゲットを正常とみなすための、ヘルスチェックの連続成功回数     | 5                  |
| 異常のしきい値 | ターゲットを異常とみなすための、ヘルスチェックの連続失敗回数             | 2                  |
| タイムアウト   | ヘルスチェックを失敗とみなすまでの、ターゲットからのレスポンスがない時間 | 5 (秒)             |
| 間隔           | ターゲットのヘルスチェックの概算間隔                                     | 30 (秒)            |
| 成功コード     | ターゲットからの正常なレスポンスの確認に使う HTTP コード                 | 200                |

## IAM

- 信頼ポリシーの設定

| 要素      | 説明                                   | 記述内容の説明                                                               |
| --------- | -------------------------------------- | ---------------------------------------------------------------------------- |
| Version   | ポリシーバージョンを指定　             | '2012-10-17' の現行 version 指定。AWS で決められた構文のルールのバージョン。 |
| Statement | ポリシーを記述することを宣言           | 具体的なポリシーを定義することを宣言                                         |
| Effect    | 許可を許可 (Allow)                     | 操作を許可。信頼ポリシーでは Allow のみ記述する。                            |
| Principal | どのサービスへ委任 (アタッチ) できるか | 例では EC2 ("Service": "ec2.amazonaws.com") を指定。                         |
| Action    | 指定的な操作内容                       | 信頼ポリシーでは特定の実行 (sts:AssumeRole) のみ許可される                   |

- IAM policy の 3 分類

| ポリシー分類           | 権限                                                                                                                                                                |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| AWS 管理ポリシー       | • AWS が提供するポリシー群で標準の IAM エンティティで使い回しが可能 <br> • IAM ユーザーによる編集はできない                                                         |
| カスタマー管理ポリシー | • ユーザーが作成するポリシー群で標準の IAM エンティティで使い回し可能 <br> • IAM ユーザーによる編集が可能であるため必要に応じてポリシーの追加/削除/修正が可能       |
| インラインポリシー     | • IAM エンティティ固有のポリシー群で標準の IAM エンティティの使い回しはできない <br> • ユーザーによる編集が可能であるため必要に応じてポリシーの追加/削除/修正が可能 |

- 複数の AWS アカウントを所有するメリット
  - アカウントごとに料金を管理できる。
  - アカウントごとに利用者のアクセスを管理できる。
  - アカウントをわけることで、ユーザーの誤操作を防ぐ。
- 踏み台アカウント運用
  - ![1000001628](https://github.com/yoshikikasama/network-and-server/assets/61643054/45929508-2f5e-490d-95fc-4a2e7554e4c1)
  - ![1000001629](https://github.com/yoshikikasama/network-and-server/assets/61643054/e17f23c0-cf1d-4c09-ba1b-394cf1d4755d)
- IAM グループの IAM policy で特定の役割をもつユーザー郡に対するロールの切り替えを制御する。

- アカウント運用のサンプルアーキテクチャ:

  - ![1000001631](https://github.com/yoshikikasama/network-and-server/assets/61643054/66ff9166-d587-4d45-bede-cfa020cbc930)

- IAM Policy simulator: 付与した権限を評価する対象の IAM エンティティと AWS サービス・リソースやアクションを選択しシミュレーションを実行することで、評価対象の IAM エンティティが対象 AWS サービス·リソースへのアクションが許可されているか否かを検証することができる。

## ログ運用

- ログ運用の 4 つの観点:
  - ログ設定:
    - 取得/管理ログのリストアップ
    - ログ出力設定
    - ログローテーション
  - ログ転送:
    - ログ転送先の検討
    - ログ転送設定
  - ログ保管:
    - ログ保管先の検討
    - ログ保管期間の検討
  - ログ利用:
    - ログの閲覧、分析
    - ログの利用
- AWS アカウントに関する取得可能なログの一例:

| ログの種類   | 記録する情報                                                             | AWS ツール     |
| ------------ | ------------------------------------------------------------------------ | -------------- |
| 途中ログ     | AWS アカウント上の操作履歴を記録                                         | AWS CloudTrail |
| 認証ログ     | いつ、どの認証情報 (IAM) を用いて AWS アカウントにアクセスしたのかを記録 | AWS CloudTrail |
| アクセスログ | どの認証情報 (IAM) を用いて AWS サービスにアクセスしたのかを記録         | AWS CloudTrail |
| 設定変更ログ | AWS アカウント上で設定変更した際の内容を記録                             | AWS Config     |
| エラーログ   | AWS アカウント上で発生した API エラーを記録                              | AWS CloudTrail |

- AWS リソースに関する取得可能なログの一例

| ログの種類   | 記録する情報                                     | AWS ツール                                          |
| ------------ | ------------------------------------------------ | --------------------------------------------------- |
| 操作ログ     | AWS リソース上での操作履歴を記録                 | Amazon EC2<br>Amazon RDS                            |
| 認証ログ     | いつ、誰が、AWS リソースにログインしたのかを記録 | Amazon EC2<br>Amazon RDS                            |
| アクセスログ | AWS リソースへの接続履歴を記録                   | Amazon EC2<br>Amazon RDS<br>Amazon ELB<br>Amazon S3 |
| イベントログ | AWS リソースで発生した事件や動作を記録           | Amazon EC2<br>Amazon RDS<br>Amazon GuardDuty        |
| 通信ログ     | 端末とサーバー間、AWS リソース間の通信内容を記録 | VPC Flow Logs<br>AWS WAF                            |
| 設定変更ログ | AWS リソースで設定変更した際の内容を記録         | Amazon EC2<br>Amazon RDS                            |
| エラーログ   | AWS リソース上でエラーが発生した時の記録         | Amazon EC2<br>Amazon RDS                            |

- 4 つの観点と関連する AWS サービス

| 項目     | 記録する AWS ツール                                     |
| -------- | ------------------------------------------------------- |
| ログ収集 | • Amazon CloudWatch Logs (統合 CloudWatch モニタリング) |
| ログ転送 | • Amazon Kinesis Data Firehose                          |
| ログ保管 | • Amazon S3 <br>• Amazon CloudWatch Logs                |
| ログ利用 | • Amazon CloudWatch Logs Insights<br>• Amazon Athena    |

### Amazon CloudWatch

- EC2 インスタンスをはじめとした AWS リソースと AWS 上で稼働しているアプリケーションをモニタリングし、システムのパフォーマンスやリソース使用率の最適化を行うために必要な判断材料(データ)を提供する。

- CloudWatch の主な機能：

| 名称                                                      | 機能説明                                                                                             | 利用例                                                                                  |
| --------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| CloudWatch Metrics（ログ保管)                             | AWS リソースのメトリクスを収集・管理する                                                             | ・EC2 の CPU 使用率を取得する<br>・RDS のストレージ空き容量を取得する                   |
| CloudWatch Logs （ログ保管)                               | AWS リソースのログを収集・管理する<br>（統合 CloudWatch エージェントを利用）                         | ・EC2 の OS ログを取得する<br>・RDS のエラーログを取得する                              |
| CloudWatch Logs<br>サブスクリプションフィルター(ログ転送) | CloudWatch Logs に出力されたログをリアルタイムに Kinesis Data Firehose などの AWS サービスに連携する | ・ロググループに保存されているログを Kinesis Data Firehose 経由で S3 に転送する         |
| CloudWatch Logs Insights (ログ利用)                       | CloudWatch Logs に収集されたログに対してクエリを実行することでログ分析を行う                         | ・VPC Flow Logs のログに対してクエリを実行し、Reject された送信元 IP アドレスを調査する |
| EventBridge<br>(旧: CloudWatch Events)                    | AWS リソースの状態(イベント)を監視する。イベントの変化をトリガーに処理を実行することも可能           | ・EC2 の設定変更（イベント）をトリガーにしてメールで変更通知を行う                      |

※ メトリクスとは定量化したデータを加工し、評価や分析に適した形式に変換したもの。

- Amazon CloudWatch Logs における 3 つの構成要素：

| コンポーネント | 説明                                                                                                                     | 利用例                                                                                                                     |
| -------------- | ------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------- |
| ログインベント | モニタリングされているアプリケーションまたは AWS リソースによって記録されたアクティビティのログデータ                    | CloudWatch Logs に実際に出力された EC2 インスタンスのログを閲覧する                                                        |
| ログストリーム | モニタリングされているアプリケーションや AWS リソースから送信された順序に従って集約された一連のログイベント              | ロググループ内で EC2 インスタンスにごとにログイベントの集約先を分ける。                                                    |
| ロググループ   | ログストリームをグループピングしたもので、ログストリーム群に対してログイベントの保持期間などを一元的に設定することが可能 | CloudWatch Logs にログを出力する際、ログ出力先として指定して保存する 。 CloudWatch Logs に出力されたログに保持期間を設ける |

- 統合 CloudWatch エージェント:

  - EC2 のように OS やソフトウェアでの運用管理を利用者側で実施する必要があるサービスについては、利用者が OS 上でログの取得設定を実施する必要がある。
  - EC2 インスタンスのログを CloudWatch Logs へ出力するためには統合 CloudWatch エージェントと呼ばれるミドルウェアを EC2 インスタンスにインストールした上で各種設定を行う。
  - EC2 インスタンスの詳細なメトリクスを収集したり、ログを CloudWatch Logs に出力したりすることを可能にする。
  - 設定順序:
    - Internet Gateway や NAT Gateway を利用して EC2 インスタンスがインターネットと通信することができるネットワーク経路を確保する。
    - EC2 インスタンスから CloudWatch および CloudWatch Logs に対する一部操作を許可する必要がある。

- CloudWatch Logs の利用料金：
  - ログデータの保管料より取り込み料金の方が高くなる。
  - <img width="532" alt="Screenshot 2023-11-05 at 14 15 16" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/1e2fee2b-1991-4051-83e2-49b100f3add2">
- CloudWatch Logs Insights: CloudWatch Logs のロググループに対してクエリを実行することで、ログデータを分析したり、問題発生時の原因調査(トラブルシューティング)に利用したりすることができる機能。

### Amazon Kinesis

- 大規模なストリーミングデータ（継続的に生成されるデータ）をリアルタイムで収集・処理するサービス。

  - データの順序: iterator と呼ばれるシーケンス番号を割り当てることでデータの順序を適切に管理することができる。
  - データの処理能力: 従量課金
  - 拡張性: 従量課金

  | サービス                      | 説明                                                                                                                                                                                                                                                               |
  | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
  | Amazon Kinesis Data Streams   | ストリーミングデータをリアルタイムでキャプチャ・処理・保存することが可能                                                                                                                                                                                           |
  | Amazon Kinesis Data Firehose  | ストリーミングデータを S3 などのデータストア、Datadog や Splunk などのサードパーティー製の分析ツールへ配信することが可能                                                                                                                                           |
  | Amazon Kinesis Data Analytics | ストリーミングデータに対してクエリを実行し、リアルタイム分析を行うことが可能。データソースは Kinesis Data Streams または Kinesis Data Firehose のいずれかを選択、実行したクエリ結果は Kinesis Data Streams や Kinesis Data Firehose、S3 などに出力することが可能。 |
  | Amazon Kinesis Video Streams  | AWS によって用意されている SDK を利用して防犯カメラ・スマートフォン・ドローン・センサーなどの動画撮影デバイスからストリーミングデータをキャプチャ・処理・保存することが可能                                                                                        |

- Amazon Kinesis Data Firehose:

  - <img width="876" alt="Screenshot 2023-11-05 at 15 34 35" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/30770ff1-1147-4736-91c0-2226fd0e6763">
  - distination に応じて配信ストリームを個別に作成する。転送するデータを振り分ける管のようなもの。

  ### Amazon Athena

  - 標準的な SQL を使用して S3 Bucket 内のデータソースに対してクエリを実行することができるサービス。
  - Athena で S3 Bucket 上のデータを参照するには:
    - データを S3 Bucket に保存
    - DB および table を定義する
    - SerDe(Serialize/Deserialize)というデータ処理をする。
      - Serialize: オブジェクトをバイト列に変換する処理
      - Deserialize: バイト列から元のオブジェクトを復元する処理
    - Athena がサポートしている圧縮形式。
    - 実行した table 定義の情報は AWS Glue Data Catalog と呼ばれるメタデータを管理する場所に保存される。

- CloudWatch Logs Insights と Athena の使い分け:
  - <img width="544" alt="Screenshot 2023-11-05 at 16 09 55" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/e28978a0-4078-4e71-b705-6635c5c62aa9">
  - <img width="545" alt="Screenshot 2023-11-05 at 16 09 47" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/b0bb35d0-51b0-4b05-af4f-5940fe62e9bd">

### ログ運用のサンプルアーキテクチャ

- <img width="868" alt="Screenshot 2023-11-05 at 16 16 34" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/299cb98c-d4aa-4738-ac14-0961adef431d">

  - インターネット公開する web アプリケーションをデプロイする環境を Web3 層アーキテクチャで構築することを想定しています。
  - Protected Subnet: NAT Gateway を経由してインターネットと接続可能なネットーワーク(DMZ)。
  - 各 AWS サービスから出力されるログに関しては、のちのログ利用を想定し、コストパフォーマンスが高い S3 への長期保管を意識した設計としています。
  - EC2 と Amazon Aurora は S3 と統合されていないため、Kinesis Data Firehose 経由で CloudWatch Logs から S3 Bucket へログを転送している。
  - VPC Flow Logs は直近出力された少量のログ利用ならびにログの長期保管の観点から、CloudWatch Logs と S3 の両方にログを出力する設計としています。
  - AWS 利用料の観点で、S3 のライフサイクルポリシーを設定し、必要に応じて S3 Glacier Flexible Retrieval をはじめとしたストレージクラスにアーカイブしたり、一定期間保管後にオブジェクトを削除したりすることを推奨します。

| ログ取得対象  | 取得用途                              | ログ保管場所                         | ログ利用方法                                            |
| ------------- | ------------------------------------- | ------------------------------------ | ------------------------------------------------------- |
| ALB           | アクセスログ                          | S3                                   | Athena                                                  |
| EC2           | OS ログの取得<br>アプリケーションログ | CloudWatch Logs<br> S3（長期保管用） | CloudWatch Logs <br>CloudWatch Logs Insights<br> Athena |
| Amazon Aurora | DB ログ                               | CloudWatch Logs<br> S3（長期保管用） | CloudWatch Logs <br>CloudWatch Logs Insights<br> Athena |
| VPC Flow Logs | 通信ログ                              | CloudWatch Logs<br> S3（長期保管用） | CloudWatch Logs <br>CloudWatch Logs Insights<br> Athena |

- EC2 インスタンスの台数が多い場合の「EC2 のログ取得設定」：

  - EC2 インスタンスが SSM のマネージドノードである必要がある。
    - SSM の管理下に置かれたマネージドノードは SSM のフリートマネージャーで確認可能。
  - SSM と EC2 インスタンス間でコマンドを送受信するための通信経路の確保が必要。
  - EC2 インスタンスに SSM エージェントをインストールすること。
  - SSM の region endpoint との通信経路を確保すること。
  - IAM Role を利用して EC2 インスタンスが SSM と通信するために必要な権限を付与すること。

- CloudWatch Logs のログを Kinesis Data Firehose を経由して S3 へ出力する:

  - S3 Bucket 作成
  - Kinesis Data Firehose で配信ストリーム作成
  - CloudWatch Logs サブスクリプションフィルター作成

- 信頼ポリシー:

  - sts: AWS Security Token Service を示しており、各種 AWS リソースへのアクセスをコントロールする一時的な認証情報を発行するサービス。
  - AssumeRole: STS に対して一時的な認証情報(IAM Role にアタッチされた IAM policy)の提供をリクエストする操作。一時的な認証情報を用いて AWS リソースが別のリソースを操作する。

- CloudWatch Logs が Kinesis Data Firehose の配信ストリームに対して操作を許可するための信頼ポリシー:
  - CloudWatch Logs では region の記述を含む
  - Condition 句で同一アカウント同一 region に存在する CloudWatchLogs に限定している理由は、混乱する代理問題を回避するため。AWS サービス間での不正アクセスに関する問題。
    - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/confused-deputy.html

```
{
  "version":"2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Principal":{
      "Service": "logs.ap-northeast-1.amazonaws.com"
    },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringLike": {
        "aws:SourceArn": "aen:aws:logs:ap-northeast-1:アカウントID:*"
      }
    }
  }
}

```

### AWS SSM

- AWS Systems Manager Prameter Store: SSM が提供している機能の一つで、設定データおよび機密データをパラメータ(値)として安全に管理するためのストレージを提供している。

  - パラメータの version 管理が可能。
  - プログラムのコードと設定データを分離して管理できること。
  - IAM を利用することでパラメータへのアクセス制御が可能。

- AWS Systems manager Run Command: EC2 インスタンスに OS ログインすることなくコマンドやスクリプトをリモートで実行することができる。
  - AWS-ConfigureAWSPackage: 統合 CloudWatch エージェントをはじめとしたパッケージのインストール、アンインストールを実施するコマンドドキュメント。
  - AmazonCloudWatch-ManageAgent: Amazon CloudWatch Agent にコマンドを送信する(設定を適用)するコマンドドキュメント
- SSM エージェント:
  - EC2 インスタンス、エッジデバイス、オンプレミスサーバー、および仮想マシン上で動作するミドルウェアで、DDM によるサーバーの更新・管理を実現する。
  - EC2 にインストールされた SSM エージェントは、AWS リージョン後よに存在する SSM の region endpoint に対してポーリングを実行します。このポーリングによって、SSM エージェントは SSM からコマンド実行などの指示を受け付ける。
  - ポーリングの問い合わせ先となる SSM の region endpoint はインターネット上に存在するため、EC2 インスタンスに Internet Gateway を経由したアウトバウンド通信をあらかじめ許可しておきます。
  - VPC Endpoint を利用すると VPC 内の AWS リソースと VPC 外のリソースとの通信を、インターネットを経由することなく接続できるようになる。VPC Endpoint を活用して SSM の region endpoint と通信することも可能。

## 監視

- 監視: 各コンポーネントから情報を計測・収集し、問題が起こった場合に意いち早く知ること。

- メトリクス：「いつ」「何が」「どういう状態・値であったのか」の情報。

- CloudWatch Alarm:

  - 期間: アラームの閾値の範囲内か範囲外か評価する間隔。評価された時点は「データポイント」と呼ばれる。
  - Evaluation Period: アラームの評価の対象となる直近のデータポイント数。
  - Datapoints to Alarm: Evaluation Period のうちアラームの状態を決定するのに必要なデータポイント数。

- 例えば期間が 3 分で Evaluation Period が 10 の場合、評価対象期間は直近の 3\*10=30 分となります。
- Datapoints to Alarm を 8 とすると 3 分おきメトリクスが評価され直近 30 分の評価対象期間のうち 8 回閾値の範囲外となればアラームの状態が変化することになる。
- CloudWatch Metrics:
  - ![PXL_20231216_224433689 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/0fde75a7-0cb7-445f-ab02-ebc667a734ee)
- CloudWatch Logs Metrics Filter:
  - ![PXL_20231216_231746824 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/90e4a794-05a1-45e3-a44d-90060bd72dda)
- CloudWatch Logs Subscription Filter: メトリクスフィルターと同じく CloudWatch Logs が受信したログをフィルターする機能ですが、フィルターしたログを CloudWatch Metrics ではなく、AWS Lambda や Amazon Kinesis へ送信して、AWS Lambda を介して SNS 発報できる。

### EC2 のステータスチェックとオートリカバリー

- ステータスチェック： EC2 インスタンスの稼働に対して影響を与える問題を自動でチェックする機能。
- インスタンスステータスチェック：それぞれのインスタンスのネットワークやリソースをチェック。ENI に対して API リクエストを送信しチェックする。CPU やメモリの枯渇、ネットワーク設定の誤り。
- システムステータスチェック：インスタンスが稼働する AWS 基盤をチェック。AWS 基盤の障害。

- オートリカバリー： CloudWatch Alarm をトリガーに自動で EC2 を停止・起動・復旧する機能。

### 監視のサンプルアーキテクチャ

![PXL_20231216_233752375 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/0ea2f5fd-2a7e-400c-a7b8-af3185ef98fd)

- 監視の要件:
  - メトリクス監視：AWS リソースの稼働状況を監視し、異常があれば通知する
  - ログ監視：OS やアプリケーションログを監視し、エラーを通知する
  - AWS のメンテナンス・障害情報：利用している AWS リソースに影響する AWS 基盤側のメンテナンス情報・障害情報を通知する。

運用後は閾値が妥当か、リソースが充足しているかを CloudWatch ダッシュボードや CloudWatch Alarm の履歴から見直しが必要。

## パッチ適用

- パッチベースライン：マネージドインスタンスにどのパッチの適用を承認もしくは拒否するかを定めたルール。
- 承認ルール：どのようなパッチが何日経てばパッチ適用を承認するかを定義する。

### パッチ適用のサンプルアーキテクチャ

- ![PXL_20231218_134623439 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/c25d2ece-c8b3-4964-be96-47c53a8f6280)
- 検証環境に自動でパッチを適用する
- 本番適用までに検証環境にて動作確認する
- 問題があった場合は、本番環境のパッチベースラインにてパッチの例外として拒否するパッチに設定する。
- 必要なパッチのみ本番環境に適用する。

## バックアップ/リストア運用

- オフラインバックアップ: システムを停止した状態でバックアップを行う方法。
- オンラインバックアップ: システムを稼働させている状態でバックアップを行う方法。

- ファイル単位のバックアップ: コピーするファイルが変更中の場合は、適切に反映されない可能性があるため、一般的にはオフラインバックアップが推奨されている。

- バックアップの世代管理:

  - フルバックアップ：全てのデータをバックアップ
  - 増分バックアップ：前回のバックアップから更新されたデータをバックアップとして取得する。リストアする際は、増分バックアップを一つずつ足していく。
  - 差分バックアップ：前回のフルバックアップから更新されたデータのみをバックアップとして取得する。リストアする際は、フルバックアップと差分バックアップを足し合わせる。

- RTO (Recovery Time Objective): システムを復旧させるにあたっての業務・ビジネスへの影響を考慮した目標復旧時間。
- RPO(Recovery Point Objective): どの時点までのデータを復旧させる必要があるのか。

- EC2 のバックアップ:

  - AMI: EC2 の起動に必要な情報をひとまとめにした template。EBS も含む。
  - EBS スナップショット: EBS ボリュームから取得するバックアップ。
  - 多くの場合でバックアップ用途に AMI を取得し、EC2 にアタッチされている特定の EBS ボリュームのデータのみをバックアップしたい場合は EBS スナップショットを取得すると良い。

- RDS と Aurora のバックアップ:
  - 自動バックアップ: 自動の日次バックアップ。最大 35 日間
  - スナップショット: 保持期間は設けられない。
- Aurora のリストア機能:

  - ポイントインタイムリカバリ: 特定の時点の DB クラスターをリストアする機能。
  - バックトラック: Amazon Aurora の MySQL 互換エディションのみ利用可。既存のクラスターをある特定の時点の状態に戻す機能。

- AWS Backup: 多数ある AWS サービスのバックアップを一元管理・自動化する機能。
  - バックアッププラン: バックアップを取得するポリシー
  - 復旧ポイント: 各バックアップに割り当てられる論理 ID
  - バックアップボールト: 復旧ポイントを管理する単位
  - AWS Backup が対応している AWS サービスでは一部を除いて増分バックアップ。
  - サービスのオプトイン: アカウント内・リージョンにある AWS サービス・リソースを AWS Backup に設定する機能。
  - タグによってバックアッププランを設定すると複数資産を管理しやすい。
  - バックアップボールトはシステムやリソースごとに分けることが推奨されている。
  - オンデマンドバックアップも可能。業務時間外にバックアップウィンドウを設定する。

### バックアップ/リストア運用のサンプルアーキテクチャ

- ![PXL_20231218_134623439 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/be842cdf-f928-4d13-a2c9-c5d1476fc0c3)
- 各システムでバックアップ/リストア要件が異なるため、システムごとにリソースをまとめて管理すること
- EC2 と Aurora でバックアップ/リストア機能の仕様が異なること
- システムによってバックアップ要件が異なる場合でもバックアッププランやバックアップボールトを分けることで管理が可能。
- システムごとに AWS リソースにタグ付けする。
- <img width="571" alt="Screenshot 2023-12-09 at 10 11 24" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/bd0c5945-0874-4e7a-92cb-68b706c823fe">
- リストア方法：
  - バックアップボールト
  - インスタンス起動ウィザード
- EC2 でリストア後に注意すべき点：
  - ファーストタッチレイテンシー: リストアした時点で S3 バケットからボリュームにデータはコピーされておらず、各ブロックに最初にアクセスした際に初めてボリュームにコピーされる状況のため、レイテンシーが遅くなる。
  - 解決策：EBS ボリュームに対して初期化という作業を実施する必要がある。リストア後に EBS ボリュームを総読みとする作業。リストア後にスナップショットから EBS へコピーするコマンドを EC2 の OS 内で実行。
  - RDS・Aurora のリストア：RDS の DB インスタンス識別子や Aurora のクラスター識別子はリージョン内で一意である必要がある。
    - エンドポイントを同じままにするためには、既存の DB インスタンス識別子・Aurora クラスター識別子をあらかじめ変更しておくなどの作業が必要。
  - ![PXL_20231219_135425923 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/4ffb695c-38b7-46d2-b9d3-c6ab2acceda1)

## セキュリティ統制

- セキュリティ: 不特定多数の第三者から情報資産を守り、安全な状態を維持すること。

- 機密性(Confidentiality): 許可された個人やコンピュータだけがシステムやデータを利用可能な状態であること。
- 完全性(Integrity): データに対して改ざんや破壊が行われておらず、情報の正確性が保たれた状態であること。
- 可用性(Availability): 障害が発生した場合でも影響を最小限に抑え、システムを稼働し続けられる状態であること。

- 発見的統制: 早期発見及び迅速な対処。
- 予防的統制: リスクや脅威が顕在化することを未然に防ぐ。

- Well-Architected フレームワークのセキュリティの柱:
- ![PXL_20231220_135000672 MP](https://github.com/yoshikikasama/network-and-server/assets/61643054/1e08afe6-d86e-406e-83d4-12324f2aa621)
- ![Screenshot 2023-12-20 at 22 58 51](https://github.com/yoshikikasama/network-and-server/assets/61643054/f7a131ef-da4d-4957-a088-6104f66d224e)
- ![Screenshot 2023-12-20 at 22 58 59](https://github.com/yoshikikasama/network-and-server/assets/61643054/02b3ca9d-531a-4eac-8bd2-b324bb23d4a1)

- SSL(Security Sockets Layer): インターネットを経由した通信において二つのシステム間で送受信される情報を保護し、悪意のある第三者が情報を読み取ったり改変したりできないようする技術。
- TLS(Transport Layer Security): SSL のセキュリティをより強化したもの。
- HTTPS(Hypertext Transfer Protocol Secure): クライアント端末とサーバー間の通信が SSL/TLS の技術を用いて暗号化されていることを意味する。ここで SSL/TLS 証明書が利用される。
- ![Screenshot 2023-12-21 at 19 46 59](https://github.com/yoshikikasama/network-and-server/assets/61643054/dbad85e0-403f-4166-ad75-d1c3cbf13ca0)

- public 証明書: 公的に認められた企業が発行する SSL/TLS 証明書
- private 証明書: 個人や法人が独自に発行する証明書

- ACM: 無償でかつコンソール画面から Amazon Trust Services(認証局)が発行する public 証明書を発行できる。

  - ただ ACM で発行可能なのは、ドメイン認証型 SSL サーバー証明書なので Web サイト運営団体の実在性についても認証・証明する必要がある高度なセキュリティが要求される Web サイトには適していない。

- マネージドプレフィクスで多数の EC2 インスタンスにアタッチされている全てのセキュリティグループに適用できる。
- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/4f566fde-304b-4156-8c7b-aadb5cba973a)

- WAF (web Application Firewall): web アプリケーションに対する通信内容(HTTP/HTTPS)を検査し、web アプリケーションの脆弱性を悪用する攻撃などの不正アクセスから web アプリケーションを守るためのセキュリティ対策機能。web サーバーよりも前の通信段階に配置し、ファイアウォールや IDS/IPS(侵入検知/侵入防御)では検知することが難しい SQL インジェクションやクロスサイトスクリプティングといったアプリケーションレベルの攻撃を緩和して、アプリケーションを保護する。
- <img width="575" alt="image" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/891ecb1e-b05b-42db-b6d1-1f3e1d699dd6">
  - ユーザーがカスタマイズして利用することもできるが、webサイトへの攻撃は日々変化しており、それらの脅威に対応するために継続的な運用の見直しが必要不可欠。
  - WafCharmのようなAWS WAF運用支援を行うサードパーティ製品を活用して運用負荷を軽減することが推奨される。

- AWS KMS:
  - CDK(Customer Data Key):保管データを暗号化する key
  - CMK(Customer Master Key):CDK を暗号化する key
    - AWS Managed CMK: AWS 管理。
    - Customer Managed CMK: ユーザー管理。アクセス管理をポリシーで厳重に取り決め可能。
- リソースベースのポリシーは IAM ポリシーよりも優先される

- AWS Config: Rules でルールに準拠したリソースの構成となっているか。

- Amazon GuardDuty:

  - DNS クエリログ、VPC Flow Logs, CloudTrail, EKS 監査ログに対して、機械学習技術を用いて分析し、セキュリティの観点から脅威だと考えられるデータをそのリスクによって検出する。
  - 特に S3 データイベントログは有効化が推奨されている。
  - 例えばユーザー A という人物は怪しいから気をつけた方が良い。というデータが脅威インテリジェンスに定義されていた場合にユーザー A を脅威と判断する。
  - 分析したログの件数に基づいて課金。
  - ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/9227e647-2a8a-4c8f-ae68-77a8d71850e2)

- Amazon EventBridge:
  - AWS や独自のアプリケーション、SaaS アプリなどから送信されるイベントと呼ばれるデータを受け取り、SNS や Lambda などのターゲットと呼ばれるアプリケーションにデータを転送する。
  - イベントバス: 仲介の役割を果たすコンポーネント
    - デフォルトイベントバス: AWS サービスから送信されたイベントを受け取りターゲットに転送する
    - カスタムイベントバス: 独自のアプリケーションから送信されたイベントを受け取りターゲットに転送する
    - パートナーイベントバス: SaaS アプリ(Datadog など)から送信されたイベントを受け取りターゲットに転送する

### セキュリティのサンプルアーキテクチャ

- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/509e0d8a-6d1e-4dbf-88d3-833e17d28c6d)
  - 1. クライアント端末と ALB ALB 間の HTTP 通信を ACM を利用して HTTPS 通信に。
  - 2. WAF を使用して ALB に対す外部からの不正アクセス防止。
  - 3.EBS および Aurora DB インスタンスデータを KMS で暗号化。
  - 4. Security Hub で集約管理

## 10. 監査準備

- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/0524f9f1-84e9-4edb-877e-db84d3535c4c)
- log の完全性を高めるために CloudTrail の「ログファイルの検証」を有効化している。

## 11. コスト最適化

- コスト削減をしすぎてしまうと例えば EC2 インスタンスのバッチ処理に時間がかかり後続処理に影響を及ぼすなど、システムが全体最適ではなくなる。
- コスト最適化: 必要な分だけ利用料を払っている状態にすること。
- コスト最適化が必要な理由:

  - オンプレミスとは異なる capacity planning があるため: 必要な時に必要な分だけ調達し、必要に応じて適切なスペックに変更する
  - 高い頻度でサービスアップデートがあるため: AWS では頻繁に update が行われ、最新世代ほど費用対効果が高いため
  - 新しいサービスがリリースされるため: 利用中の AWS サービスを互換するコスト効率の良い AWS サービスが発表されるため

- コスト最適化の一連の流れ:
  - AWS 利用料の把握: AWS Cost Explorer 参照
  - タグの配布: m5.xlarge の EC2 インスタンスが 2 台ある場合に、どちらの EC2 インスタンスが本番用なのか検証用なのか判断するなど
  - AWS 利用状況の分析: 高額なサービスから分析する。
  - コスト最適化の実施: 対象 AWS リソースの管理者への事前調整。

| プロセス           | プロセスの概要                                                                                 | 関連する AWS サービス                                                            |
| ------------------ | ---------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| AWS 利用料金の把握 | 現時点での AWS 利用料を把握                                                                    | - AWS Cost Explorer<br>- AWS Budgets<br>- AWS Cost Anomaly Detection             |
| タグの付与         | AWS 利用状況を詳細に分析するために AWS リソースに対してタグ付けする                            | コスト配分タグ                                                                   |
| AWS 利用状況の分析 | 過去から現在に至るまでの AWS 利用状況を分析し、コスト最適化の対象となる AWS サービスを選定する | - AWS Cost Explorer<br>- AWS Compute Optimizer<br>- AWS Trusted Advisor          |
| コスト最適化の実行 | 対象となる AWS サービスに対して、コスト最適化を実行する                                        | - リザーブドインスタンス<br>- Savings Plans<br>- AWS Systems Manager Quick Setup |

- コスト最適化手法:

  - 未使用の AWS リソースの削除: 該当 AWS リソースに支払っている AWS 利用料が 100%削減されるため最も効果が高い。
  - 不適正スペックの AWS リソースの発見
  - AWS リソース稼働時間の見直し
  - 常時稼働 AWS リソースの特定
  - ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/fb24bee7-6b27-4d28-a4ab-30e85c6e9754)

- AWS Cost Anomary Detection: AWS 利用料及び AWS リソースの使用状況を継続的に監視することで AWS 利用用における異常値を検出し、通知することができるサービス。過去のコストデータから支出・利用パターンをベースラインとして学習し、そのベースラインから逸脱した異常な AWS 利用料の上昇を検出する。AWS 利用料の増加を早期に把握しそれを抑制するためにも Cost Anomaly Detection は非常に有用な機能のため、基本的には有効化しておく。

- AWS におけるタグ付け戦略:

| 項目     | 基準内容                                           |
| -------- | -------------------------------------------------- |
| タグキー | AWS リソースを横断・識別・検索する「目的」を定める |
| タグ値   | タグキーで定めた「目的」に即した「値」を決める     |

| タグ付け戦略           | 内容                                                                                                        | 利用例                                                                                                                                                                      |
| ---------------------- | ----------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| リソース整理のタグ     | AWS リソースを一覧に認識したり、グルーピングしたりするためにタグを付与する                                  | AWS リソースを一覧に識別するために、EC2 インスタンスに「Name」タグを付与する                                                                                                |
| コスト配分のタグ       | AWS 利用料金が発生する AWS リソースにタグを付与することで AWS 利用料を追跡できるようにする (コスト配分タグ) | AWS リソースの利用料金を部署別に grouping するために「DivisionCode」タグを付与する                                                                                          |
| オートメーションのタグ | AWS リソースに対するオペレーションを自動化する際、自動化対象のリソースを識別するためにタグを付与する        | AWS Backup によるバックアップ対象をオートメーションするために「Backup」タグを付与する                                                                                       |
| アクセス制御のタグ     | AWS リソースに対して条件付きのアクセス制御を実現するためにタグを付与する                                    | 部署 A のユーザー A が、部署 B が管理している EC2 インスタンスを起動・停止できないよう、ユーザー A に対する IAM ポリシーで Condition を用いた条件付きアクセス制御を実現する |

- コスト配分タグ: AWS 利用料が発生する AWS リソースにタグを付与することで AWS 利用料をタグでフィルターをかけて確認・分析できる。

- AWS Compute Optimizer: デフォルトで最大過去 14 日間の CloudWatch メトリクスの値を分析することでコンピューティングリソースのスペックが最適かどうかを評価し推奨事項などを表示する AWS サービス。EC2, EBS, EC2 Auto Scaling Group, AWS Lambda, Fargate を support

- RI(Reserved Instance): 常時稼働している EC2 インスタンスの OS とインスタンスタイプに対して購入すると最も割引率が高くなる。
- キャパシティ予約: 該当する EC2 インスタンスタイプの EC2 インスタンスを任意の時間に起動可能とするキャパシティ(容量)を予約する権利。
- Savings Plans: RI と同様に AWS のコンピューティングリソースを一定期間継続して利用することを前提に大幅な割引を受けることができる。割引適用後の 1 時間あたりの利用料をドルで指定して購入する。
  - Compute Savings Plans: 適用可能な AWS サービス(EC2, Lambda, Fargate)が最も多く、適用条件も柔軟で利用実績が多い。割引効果が最も高いリソースから自動的に適用。
  - EC2 Instance Savings Plans: Compute Savings Plans と比較してよりディスカウント効果が高い Savings Plans。EC2 インスタンスのインスタンスファミリーのみ。
- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/a38f1a5a-11d9-454e-8b73-037958e98ebd)

- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/507f4cb0-b29a-44f0-9151-4e844f6bbea9)
- RDS の場合は RI のみ購入可能。
- RDS は Convertible RI が選択できないため、DB エンジンと DB インスタンスクラスを購入後に変更できない。
- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/e002888c-66a3-46cb-a6f3-a15087465d8d)
- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/afb5b895-dfe8-44a9-85fb-44b1a9fbd314)
- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/5dd3a2de-88d0-4640-b269-a3441ad87dc7)
- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/849acb07-a6bc-4e6c-b388-1426523dfd13)

- Resource Scheduler: 未使用時の EC2 インスタンスの停止のスケジューリング。

### サンプルアーキテクチャ

- ![image](https://github.com/yoshikikasama/network-and-server/assets/61643054/595fd08a-c798-4770-89b2-f0a9744525a9)
