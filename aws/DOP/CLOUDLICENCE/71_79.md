# CloudLicence

## 71.

- ある開発チームでは、CodeDeploy による Blue/Green デプロイを使用してウェブサイトのデプロイを管理します。アプリケーションは、Auto Scaling グループの Application Load Balancer の背後にある Amazon EC2 インスタンスで実行されています。
  新しいリビジョンをデプロイするとき、チームはデプロイが最終的に失敗することに気づきましたが、失敗するまでに長い時間がかかります。さらに開査したところ、AllowTraffic ライフサイクルイベントが 1 時間実行され、最終的に他の情報を提供することなく失敗したことが分かりました。チームは、障害が発生した場合でもアプリケーションの可用性を維持しながら、障害通知がより迅速に配備されるようにしたいと考えています。
  これらの要件を満たすための最適な方法の組み合わせを選択してください。

  - デプロイ失敗イベント用の CodeDeploy トリガーを作成する
    - CodeDeploy トリガーを使用すると、デプロイが失敗したときに通知を受け取ることができます。これにより、単一のヘルスチェックが失敗した場合でも即座にデプロイを失敗と判断し、迅速に通知を受け取ることができます。これにより、問題が発生した際にすぐに対応でき、アプリケーションの可用性を維持するのに役立ちます。
  - appspec.yml ファイルを使用して BeforeAllowTraffic フックでスクリプトを実行する
    - BeforeAllowTraffic フックを使用することで、アプリケーションがトラフィックを受け入れる前にヘルスチェックを実行できます。ヘルスチェックに失敗した場合はデプロイを即座に停止させることができます。これにより、問題のあるバージョンがユーザーに影響を与える前にデプロイを中止でき、アプリケーションの安定性を保つことができます。

- 企業の要件
  - トラフィックが一定しないステートレスなウェブアプリケーション: 時間や状況によってアクセス量が変わるアプリケーション。
  - AWS CloudFormation でデプロイ: インフラのコード管理ツールを使用。
  - ALB の背後にある Amazon EC2 インスタンスで実行: 負荷分散機能を利用し、複数の EC2 インスタンスでアプリケーションを実行。
  - 複数のアベイラビリティーゾーンで実行: 高可用性の確保。
  - コスト削減のためにスポットインスタンスを使用したい: スポットインスタンスは、余剰の EC2 インスタンスを割安で利用できるもの。
- スポットフリート: スポットインスタンスとオンデマンドインスタンスの組み合わせを使って、アプリケーションの要件を満たすようにインスタンスを自動的に管理する機能です。スポットインスタンスは安価ですが、AWS の需要に応じて停止されることがあります。そのため、信頼性を保つためにオンデマンドインスタンスと併用することが推奨されます。
  - スポットフリートでは、以下の配分戦略がありますが、最適なものを選ぶ必要があります。
    - lowestPrice: 最も安いスポットインスタンスを選ぶ。
    - diversified: スポットインスタンスを複数のプールに分散させる。
    - capacityOptimized: 最も容量が最適化されたスポットインスタンスプールを選ぶ。capacityOptimized 配分戦略は、リアルタイムの容量データに基づいて最適なスポットインスタンスプールを選びます。これにより、インスタンスの割り当てに失敗するリスクが低減され、コスト効率が向上します。特に、中断がコストのかかるワークロードに適しています。
    - スポットインスタンスのプールは、特定のインスタンスタイプ（例: m4.large）と特定のアベイラビリティーゾーン（例: us-east-1a）の組み合わせのことを指します。つまり、各プールは特定のインスタンスタイプと特定のアベイラビリティーゾーンで構成されています。
      - 例えば、m4.large インスタンスのスポットプールが以下のようにあるとします。
        - m4.large in us-east-1a
        - m4.large in us-east-1b
        - m4.large in us-east-1c
- IT における「プール（pool）」は、特定の目的のためにグループ化されたリソースの集合を意味します。泳ぐためのプールとは異なり、これらのプールはシステムの効率化やリソースの最適化に役立つものです。

- 企業が AWS 環境でのセキュリティ監視を強化し、特に restricted-ssh ルールに準拠していないセキュリティグループに対してリアルタイムでカスタマイズされた通知を受ける方法
  - Amazon SNS トピックの作成:
    - SNS トピックを作成し、通知を受け取る担当者（例えば、セキュリティチームのメールアドレス）をサブスクライブします。
  - AWS Config でルールを設定:
    - AWS Config で restricted-ssh ルールを有効にします。このルールは、セキュリティグループが特定の SSH ポリシーに準拠しているかどうかを監視します。
  - Amazon EventBridge ルールの設定:
    - Amazon EventBridge を使用して、AWS Config の評価結果をフィルタリングし、restricted-ssh ルールのコンプライアンスステータスが NON_COMPLIANT の場合にトリガーするルールを作成します。
  - 入力トランスフォーマーの設定:
    - イベントブリッジで、通知に必要な情報（準拠していないセキュリティグループの名前と ID など）を抽出してカスタマイズするために入力トランスフォーマーを使用します。
  - SNS 通知の設定:
    - EventBridge ルールがトリガーされた際に、カスタマイズされた通知を Amazon SNS トピックに送信するように設定します。

## 72.

- 問題の背景
  - ソフトウェア開発チームは、同じコードブランチを使用して 2 つの異なる環境にデプロイしています。
  - 開発環境：開発者がコードをテストするための環境。
  - UAT 環境：ビジネスユーザーが最終確認を行うための環境。
  - ある日、UAT 環境でビジネスユーザーから不具合が報告されました。しかし、同じコードを実行している開発環境ではその不具合は再現しませんでした。この問題を解決するためには、2 つの環境が同じ構成であることを保証する必要があります。
- 解決方法

  - CloudFormation を使用して環境を構築：
    - AWS CloudFormation は、AWS リソースのセットアップを自動化するツールです。単一のテンプレートを使用して、開発環境と UAT 環境を同じ設定で構築することで、環境の違いによる問題を防ぎます。
    - CloudFormation テンプレートをパイプラインのデプロイステージで使用し、環境をプロビジョニングします。
  - アーティファクトのチェックサムを比較：
    - チェックサムとは、ファイルの整合性を確認するためのデジタル署名のようなものです。
    - AWS CodeBuild を使用してビルドされたアーティファクト（ビルド成果物）の SHA-256 チェックサムを取得します。
    - 例えば、開発環境でビルドされたアーティファクトの SHA-256 チェックサムと UAT 環境でビルドされたアーティファクトの SHA-256 チェックサムを比較します。
    - パイプライン内で Lambda 関数を呼び出して、このチェックサムを比較し、アーティファクトが正しいものであることを確認します。
    - ![image](https://github.com/yoshikikasama/system/assets/61643054/0244b345-5f95-413f-88b6-2dacefa93f52)

- 背景と要件

  - AMI（Amazon Machine Image）: EC2 インスタンスのテンプレートで、ソースアカウントにあります。
  - 暗号化: すべての AMI は暗号化される必要があります。
  - 共有: 暗号化された AMI をターゲットアカウントと共有します。
  - KMS キー: ソースアカウントに作成された AWS KMS キーを使用します。 -　手順の流れ
  - ステップ 1: 暗号化されていない AMI を暗号化された AMI にコピーする
    - 暗号化されていない AMI を選択し、「Actions」ドロップダウンメニューから「Copy AMI」を選択します。
    - 「Encryption」セクションで、「Add Encryption」を選択し、KMS キーを指定します。
    - 「Copy AMI」をクリックして、暗号化された AMI を作成します。
  - ステップ 2: KMS キーのポリシーを設定し、ターゲットアカウントにアクセス許可を付与する
  - ステップ 3: 暗号化された AMI をターゲットアカウントと共有する
    - 「AMIs」を選択し、暗号化された AMI を選択します。
    - 「Actions」ドロップダウンメニューから「Modify Image Permissions」を選択します。
    - 「Add Account ID」を選択し、ターゲットアカウントの ID を入力します。

- AWS Organizations:
  - 管理アカウントのみを使用: シンプルで設定が簡単。ただし、管理アカウントに負荷が集中する可能性があります。管理アカウントを使用する方が簡単です。追加の設定や管理アカウントの登録が不要です。
  - 委任管理アカウントを使用: 管理の役割分担とセキュリティの強化が可能。設定手順はやや複雑ですが、長期的な運用効率とセキュリティ向上が期待できます。委任管理アカウントを使用することで、管理の分散とセキュリティの強化が図れます。

## 73.

- Amazon GuardDuty

  - 一元管理: GuardDuty を使用することで、全てのアカウントで一元的に監視が可能です。
  - 自動検出: パブリックアクセスブロックが無効にされた場合、GuardDuty は自動的に検出します。
  - 通知の保護: 通知設定を中央アカウントで管理するため、個々のメンバーアカウントが通知を無効にできません。

- CloudFormation のスタックポリシー（Stack Policy）
  - 目的: スタックポリシーは、CloudFormation スタックの更新中に特定のリソースが誤って変更されることを防ぐために使用されます。
  - 使用方法: スタックポリシーは JSON 形式で定義され、スタックの作成または更新時に適用されます。リソースの更新を制御し、保護するために、特定のリソースに対する更新操作を許可または禁止するルールを設定します。
  - 例: 特定の S3 バケットやデータベースインスタンスが誤って更新されないように保護します。
- CloudFormation の Update Policy（更新ポリシー）

  - 目的: 更新ポリシーは、Auto Scaling グループや Amazon ECS サービスなどのリソースがどのように更新されるかを指定するために使用されます。特にローリング更新（Rolling Update）などのデプロイメント戦略を制御します。
  - 使用方法: Update Policy は CloudFormation テンプレート内でリソースに対して設定され、更新中のリソースの動作を指定します。例えば、Auto Scaling グループのインスタンスをバッチで更新する方法や、一度に更新するインスタンスの数を設定します。
  - 例: Auto Scaling グループ内の EC2 インスタンスをローリングアップデートする場合。

- 企業は、IAM ユーザーに関連する異常なアクティビティを監視し、その情報を通知したいと考えています。通知は、異常なアクティビティが検出されたユーザーとそのチームリーダーに送信されます。これを達成するために、次の条件を満たすソリューションが必要です。
  - 異常なアクティビティの監視: IAM ユーザーに関連する異常なアクティビティを検出する。
  - 通知の送信: 異常なアクティビティが検出されたユーザーとそのチームリーダーに通知を送信する。
  - ユーザー情報の取得: 外部メッセージングプラットフォームに通知を送信するために、受信者ごとのターゲットユーザー ID を取得する。
  - AWS Organizations を使用: 企業は AWS Organizations を使用してアカウントを管理している。
- なぜ Amazon GuardDuty が最適なのか

  - 異常なアクティビティの検出:
    - Amazon GuardDuty は、AWS アカウントと IAM ユーザーに関連する異常なアクティビティを検出するサービスです。
    - GuardDuty は機械学習を使用して異常な行動を検出し、セキュリティインシデントとして報告します。
  - 通知のトリガー:
    - GuardDuty の検出結果は、Amazon EventBridge（以前は CloudWatch Events）にイベントとして発行されます。
    - EventBridge ルールを使用して、GuardDuty の検出結果をトリガーとして AWS Lambda 関数を呼び出すことができます。
  - ユーザー情報の取得:
    - 企業の API を使用して IAM ユーザー名からスタッフおよびチームリーダーのユーザー ID を取得することができます。
    - AWS Lambda 関数内でこの API を呼び出して、外部メッセージングプラットフォームに通知を送信します。

- Amazon Detective は、AWS 環境で発生したセキュリティインシデントの調査を支援するサービスです。セキュリティデータを収集・分析し、インシデントの原因や影響を特定するのに役立ちます。

  - 主な機能
    - データ収集と分析
      - AWS ログデータ（VPC フローログ、CloudTrail、GuardDuty など）を自動で収集。
      - 異常なアクティビティの検出には使用されず、既存の GuardDuty 検出結果の分析に特化しています。
      - データをグラフデータベースに変換し、リソース間の関係を可視化。
    - インシデント調査
      - タイムライン表示でイベントの時系列を確認。
      - リソースの詳細なアクティビティログを提供。
    - 相関分析
      - 関連するリソースやイベントの相関関係を分析し、異常なアクティビティの原因を特定。
  - 使用例
    - GuardDuty が異常なアクティビティを検出した場合：
      - GuardDuty アラート確認: Detective コンソールでアラートを確認。
      - タイムライン調査: 異常なイベントの前後のアクティビティを時系列で確認。
      - リソース関係確認: 異常が発生したリソースの関連アクティビティをグラフで確認。
      - 相関分析: イベントやリソース間の関係を分析し、原因を特定。
  - 利点
    - 迅速なインシデント対応: 複雑なインシデントの調査を効率化。
    - 包括的なセキュリティ管理: 他の AWS セキュリティサービス（GuardDuty、Security Hub）と連携。
    - Amazon Detective を使用することで、セキュリティインシデントの迅速な原因究明と対策が可能になります。

- AWS CloudFormation StackSets の「自動デプロイ設定」を有効にします。
  ```bash
  aws cloudformation create-automatic-deployment-rule \
    --stack-set-name EnableConfigStackSet \
    --automatic-deployment-enabled true \
    --retained-stacks OrgId=<OrganizationsId>
  ```
  - これで、新しい AWS アカウントが作成されたときに、自動的に AWS Config を有効にする CloudFormation StackSet の設定が完了しました。これにより、全ての新しいアカウントに対して一貫した設定を自動的に適用することができます。

## 74.

- AWS Firewall Manager は、AWS アカウントおよびリソースに対して一貫したファイアウォールルールを適用するためのサービスです。
- Amazon CloudWatch Synthetics は、エンドポイントや API を監視するための Canary（スケジュールで実行される設定可能なスクリプト）を作成するのに役立つ。ウェブアプリケーションや API を定期的に監視し、パフォーマンスや可用性を確認するためのサービスです。

## 75.
