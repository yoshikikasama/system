# CloudLicence

## 41.

- Amazon Inspector を使用した Amazon EC2 インスタンスのスキャン:

  - Amazon EC2 インスタンスに対して脂弱性スキャンを実行するために、AWS Systems Manager エージェント（SSM Agent）のインストールと動作、ポート 443 でのアウトバウンド通の許可、そして AWS Systems Manager との通信に対するアクセス許可が必要となる。ターゲット EC2 インスタンスに、AWS Systems Manager サービスのエンドポイントへのポート 443 でのアウトバウンドを許可するセキュリティグループを関連付けます。これにより、インスタンスは SSL/TLS を通じて AWS Systems Manager と通信できます。AWS Systems Manager (SSM) エージェントは、AWS Systems Manager のエンドポイントと通信するためにポート 443 を使用します。これにより、エージェントがインスタンスの状態やインベントリデータを AWS Systems Manager に報告し、指示を受け取ることができます。
    - AWS Systems Manager は、以下の方法で通信を確立できます：
      - インターネット経由: インスタンスがインターネットに接続されている場合、SSM エージェントはデフォルトでポート 443 を使用して、AWS Systems Manager のパブリックエンドポイントと通信します。
      - VPC エンドポイント経由: インターネットアクセスが制限されている環境では、Amazon VPC エンドポイントを使用することで、インターネットを経由せずに AWS Systems Manager と通信できます。これにより、セキュリティグループでポート 443 を開ける必要はなくなります。
  - Amazon Inspector は、AWS Systems Manager （SSM）と SSM エージェントを使用して、EC2 インスタンスのソフトウェアアプリケーションインベントリに関する情報を収集します。このデータは、Amazon Inspector によってソフトウェアの胎弱性がないかスキャンされます。Amazon Inspector は、Systems Manager でサポートされているオペレーティングシステムのソフトウエアの弱性のみをスキャンできます。

- DynamoDB Streams は、データベース内の変更をリアルタイムで捕捉する機能を提供します。これにより、データの変更に対してトリガーを設定して、リアルタイムアプリケーションやイベント駆動型サービスを構築できます。

- Permissions Boundary: IAM ユーザまたは IAM ロールに対するアクセス権限として動作します。これまで設定していた Permissions Policy に加えて、追加オプションとして設定することが可能です。Permissions Policy と Permissions Boundary の両方で許可されているものが有効なアクセス権限ということになります。Permissions Boundary では、制限したいアクセス権を広く定義しつつ、Permissions Policy の方でユーザやロールごとに、付与したいアクセス権限を細かく管理するイメージになると思います。Permissions Boundary については、制限したい権限は細かく規定しなければいけない一方で、将来的に付与したいアクセス権限は許可しておかなければ、万一の権限追加の際に Permissions Policy と Permissions Boundary の両方をメンテナンスしなければいけないということにもなりかねませんので、十分に注意しましょう。

## 42.

- Amazon SNS デッドレターキュー (DLQ)(Redrive ポリシー ): Amazon SNS サブスクリプションが受信者にリトライしても正常に配信できないメッセージの送信先としての Amazon SQS キューです。クライアントエラーまたはサーバーエラーが原因で配信できないメッセージは、詳細な分析や再処理のためにデッドレターキューに保持されます。

- 大企業が買収した小企業の AWS アカウントを、自社の AWS Organizations と AWS Control Tower 環境に統合する方法:
  - ステップ 1: AWS Config コンフォーマンスパックの作成と適用
    - コンフォーマンスパックの作成: 大企業のポリシーに基づいた AWS Config ルールを集めたコンフォーマンスパックを作成します。これには、セキュリティ、コンプライアンス、ベストプラクティスに関連するルールが含まれます。
      - AWS Config 適合パック(コンフォーマンスパック): 適合パックは一つのエンティティであり、複数作成することができます。適合パックの中心となるのはテンプレートです。 CloudFormation と同じような記法で一つ以上の AWS Config ルール（および必要に応じて修復アクション）を定義し、一括でデプロイすることができます。デプロイされた Config ルールは個別に作成された場合と同様に管理することもできますし、適合パックというグループの中で管理することもできます。
    - コンフォーマンスパックの適用: 小企業のアカウントに対してこのコンフォーマンスパックを適用します。これにより、小企業のアカウントがどの程度大企業のポリシーに適合しているかを評価できます。
  - ステップ 2: 設定レコーダーと配信チャンネルの削除
    - 影響評価の結果確認: コンフォーマンスパックの評価結果を確認し、設定の不整合や問題点を特定します。
    - 設定レコーダーと配信チャンネルの削除: 小企業のアカウントで設定レコーダーと配信チャンネルを手動で削除します。これは AWS CLI やマネジメントコンソールを使用して実行します。小企業のアカウントが独自に設定している AWS Config 設定レコーダーや配信チャンネルが、大企業の AWS Control Tower によって提供される設定と競合する可能性があります。これにより、重複したデータ収集やコンプライアンスチェックが発生し、リソースの無駄遣いやパフォーマンスの低下を引き起こすことがあります。AWS Control Tower は、自動的に設定レコーダーと配信チャンネルを再作成し、組織全体の一貫したガバナンスを適用します。これにより、統一されたポリシーとコンプライアンス基準が維持されます。
      - AWS Config の配信チャンネル（Delivery Channel）: AWS Config が収集した設定変更データやコンプライアンスデータを Amazon S3 バケットや Amazon SNS トピックに配信するための設定です。配信チャンネルは、AWS Config が監視および記録したリソースの設定履歴、設定変更、コンプライアンス評価結果を保存および通知するために使用されます。
  - ステップ 3: AWSControlTowerExecution ロールの作成
    - 小企業のアカウントに AWSControlTowerExecution ロールを作成します。このロールは、AWS Control Tower の機能やサービスとの連携を可能にします。
  - ステップ 3: AWS Control Tower Account Factory に登録
    - 小企業のアカウントのメールアドレス、所有者情報、および宛先 OU を提供し、AWS Control Tower Account Factory に登録リクエストを行います。これにより、スムーズに統合が進行します。
  - AWS Organizations で信頼されたアクセスを有効にする - まず、AWS Organizations で信頼されたアクセスを有効にする必要があります。これは AWS Control Tower が AWS Organizations と連携して、他のアカウントに対する操作を実行できるようにする設定です。 - {"trustedAccessEnabled": true,"servicePrincipal": "controltower.amazonaws.com"} - AWSControlTowerExecution ロールの作成:
  - 次に、AWSControlTowerExecution ロールを作成します。このロールには、AWS Control Tower が他のアカウントに対して必要な操作を実行するための権限が含まれます。

## 43.

- Amazon SQS デッドレターキューのリドライブポリシー: デッドレターキューにアクセスできるソースキューを指定します。このポリシーは、潜在的なデッドレターキューに適用されます。すべての送信元キューを許可するか、特定のソースキューを許可するか、すべての送信元キューを拒否するかを選択できます。デフォルトでは、すべてのソースキューがデッドレターキューを使用することを許可しています。特定のキューを許可することを選択した場合(byQueue オプション)の場合、ソースキューの Amazon リソースネーム (ARN)を使用して最大 10 個のソースキューを指定できます。denyAll を指定した場合、キューをデッドレターキューとして使用することはできません。

## 45.

- AWS CloudFormation のエラー「指定された期間内に X 個のリソースシグナルを受信できませんでした」を解決するには

  - Amazon Elastic Compute Cloud (Amazon EC2) インスタンス、Auto Scaling グループ、または WaitCondition が CreationPolicy 属性で指定された期間内に 1 つ以上のインスタンスから成功シグナルを受信しない場合にこのエラーが発生します。
    - シナリオ 1: cfn-signal スクリプトが AWS CloudFormation スタックの 1 つ以上のインスタンスにインストールされていません。
    - シナリオ 2: AWS CloudFormation テンプレートに構文エラーまたは正しくない値があります。
    - シナリオ 3: CreationPolicy 属性の Timeout プロパティの値が小さすぎます。
    - シナリオ 4: Amazon EC2 インスタンスから cfn-signal が送信されていません。

- cfn-signal ヘルパー スクリプト: Amazon EC2 インスタンスが正常に作成または更新されたかどうかを CloudFormation に通知します。インスタンスにソフトウェア アプリケーションをインストールして構成すると、それらのソフトウェア アプリケーションの準備ができたときに CloudFormation に通知できます。cfn-signal スクリプトは、CreationPolicy 属性または WaitOnResourceSignals 更新ポリシー を持つ Auto Scaling グループと組み合わせて使用 ​​ します。 CloudFormation は、これらのポリシーを使用してリソースを作成または更新すると、リソースが必要な数のシグナルを受信するか、タイムアウト期間を超えるまで、スタック上の作業を一時停止します。 CloudFormation が受信する有効なシグナルごとに、CloudFormation はシグナルをスタック イベントに発行して、各シグナルを追跡できるようにします。

- cfn-signal: EC2 リソースが正常に作成/更新されたかどうかを示すシグナルを CloudFormation に送信するスクリプトです。 シグナルは CloudFormation の CreationPolicy,UpdatePolicy 属性などで使われています。
- CreationPolicy 属性: リソースに関連付けて、AWS CloudFormation が指定数の成功シグナルを受信するかまたはタイムアウト期間が超過するまでは、ステータスが作成完了にならないようにします。
