# CloudLicence

## 61.

- 現在の状況の問題点
  - ロードバランサー：1 つのロードバランサーがあります。
  - インスタンス：単一のアベイラビリティゾーン（AZ）に micro インスタンスタイプのインスタンスが 2 から 64 の範囲でスケールします。
  - バックエンド：DynamoDB で構成されています。
  - パフォーマンス問題：顧客がウェブサイトを表示する際に長いロード時間を経験しています。
- 問題の原因
  - インスタンスの性能：micro インスタンスはリソースが少なく、パフォーマンスが低いです。
  - 単一 AZ のリスク：単一の AZ に依存しているため、高可用性が確保されていません。
- インスタンスのサイズ変更：
  - 現状：micro インスタンスを使用しています。
  - 改善：より大きなインスタンス（例えば、t3.medium や t3.large など）に変更します。これにより、1 つのインスタンスあたりのリソースが増え、処理能力が向上します。
- 複数 AZ の利用：

  - 現状：単一の AZ でしかスケーリングしていません。
  - 改善：Auto Scaling グループを設定して、複数の AZ でインスタンスをスケールさせます。これにより、高可用性が確保され、1 つの AZ に障害が発生した場合でも、他の AZ でサービスを継続できます。

- EC2 インスタンスのアイドル状態: インスタンスが起動しているものの、特定のリソース（CPU、メモリ、ディスク I/O、ネットワークなど）がほとんど、またはまったく使用されていない状態を指します。この状態では、インスタンスは稼働中ですが、実際の仕事をしていないか、非常に少ない負荷しかかかっていないことになります。
- AWS Trusted Advisor:

  - 以下のコスト最適化チェックでは、リソースの使用率を検査し、使用率が低いリソースにフラグを付けます。
  - Amazon RDS Idle DB Instances では、Amazon Relational Database Service (Amazon RDS) の設定が検査され、アイドル状態の DB インスタンスがあるかどうかが検査されます。過去 7 日間にアクティブな DB インスタンスに接続しなかった場合、このチェック結果の黄色のアイコンが表示されます。スナップショットを作成し、インスタンスを削除または停止できます。
  - Idle Load Balancers は、Elastic Load Balancing (ELB) 設定を検査し、非アクティブなロードバランサーがないか確認します。アクティブに使用されていないロードバランサーがある場合、このチェック結果の黄色のアイコンが表示されます。
  - Low Utilization Amazon EC2 Instances では、使用率が低い Elastic Compute Cloud (Amazon EC2) インスタンスを停止または終了することを推奨しています。また、Amazon EC2 Auto Scaling を使用してインスタンスをスケールすることもできます。
  - Unassociated Elastic IP Addresses は、実行中の EC2 インスタンスに関連付けられていない、アカウント内の Elastic IP アドレスを識別します。実行中のインスタンスにアタッチされていない Elastic IP アドレスには、料金が発生します。Elastic IP アドレスを実行中のインスタンスに関連付けるか、解放してコストを削減できます。
  - Underutilized Amazon EBS Volumes は、Amazon Elastic Block Store (Amazon EBS) ボリューム設定で、使用率の低いボリュームがないかどうかを検査します。使用率の低いボリュームのスナップショットを作成し、削除することで、コストを削減できます。 -使用率の低い Amazon Redshift クラスターは、Amazon Redshift の設定をチェックして、使用率の低いクラスターがないか確認します。クラスターのスナップショットを作成して、シャットダウンできます。クラスターのダウンサイジングを選択することもできます。

- Amazon Aurora Global Database: 複数の AWS リージョン にまたがり配置されます。これにより、低レイテンシーのグローバル読み取りを実現し、AWS リージョン 全体に影響が及ぶ可能性のある停止がまれに起きても、すばやい復旧を可能にします。Aurora Global Database には、1 つのリージョンにプライマリ DB クラスターがあり、異なるリージョンに最大 5 つのセカンダリ DB クラスターがあります。単一の Amazon Aurora データベースを複数の AWS リージョンにまたがって運用できます。データベースのパフォーマンスに影響を与えずにデータをレプリケートし、各リージョンでレイテンシーを低減してローカル読み取りを高速化し、リージョン規模の停止からのディザスタリカバリを実現します。

## 62.

- AWS Storage Gateway: オンプレミス環境と AWS クラウド間のストレージを統合するためのハイブリッドクラウドストレージサービスです。これにより、オンプレミスのアプリケーションがクラウドストレージを使用することができます。
  - ![image](https://github.com/yoshikikasama/system/assets/61643054/230fecbc-38f4-4e59-83c8-23b195f11d27)
  - RefreshCache 操作は、ファイルゲートウェイが S3 バケットの内容を最新の状態に保つためにキャッシュを更新する操作です。これにより、S3 バケット内の新しいオブジェクトや変更されたオブジェクトがファイルゲートウェイ経由でユーザーに見えるようになります。
  - ファイルゲートウェイは、AWS Storage Gateway の一つの動作モードです。このモードでは、オンプレミスのアプリケーションがクラウドに保存されたファイルを簡単に利用できるようにします。
  - ローカルキャッシュ：よくアクセスされるデータをオンプレミスにキャッシュすることで、データアクセスの速度を向上させます。
- ファイルの格納：
  - オンプレミスのアプリケーションはファイルを Storage Gateway に送信します（NFS または SMB プロトコルを使用）。
  - Storage Gateway はファイルを Amazon S3 に保存します。
- ファイルの参照：
  - ユーザーがファイルにアクセスしようとすると、まず Storage Gateway にリクエストを送信します。
  - Storage Gateway は Amazon S3 からファイルを取得し、必要に応じてローカルキャッシュからも提供します。
- ボリュームゲートウェイ

  - 用途：ブロックストレージ
    - プロトコル：iSCSI (Internet Small Computer Systems Interface)
    - データ保存：Amazon S3（バックアップ）または完全にオンプレミスに保存
  - 主なユースケース：
    - データベースや仮想マシンのバックアップと復元
    - ディザスタリカバリ
    - オンプレミスとクラウドのブロックストレージ統合
  - 特徴：
    - キャッシュボリューム：オンプレミスに頻繁にアクセスされるデータをキャッシュし、Amazon S3 にバックアップ
    - ストアボリューム：オンプレミスにデータを保存し、Amazon S3 に定期的にスナップショットを取る

- DynamoDB Stream: DynamoDB にデータの更新があった際、Lambda 関数を起動して非同期で処理を行うことができる

- IAM Roles Anywhere: AWS IAM（Identity and Access Management）ロールをオンプレミスのサーバーやアプリケーションから利用できるようにするサービスです。通常、IAM ロールは AWS 内部でしか使用できませんが、このサービスを使うことで、オンプレミス環境からも IAM ロールを安全に使えるようになります。
  - トラストアンカーとは、オンプレミスの環境から AWS のリソースにアクセスするための信頼の基盤です。まず、これを AWS で設定します。
  - 次に、CodeArtifact アクション（操作）を許可する IAM ロールを作成します。このロールには、トラストアンカーと信頼関係を持たせます。
  - 最後に、オンプレミスの CI/CD パイプラインを設定して、この IAM ロールを引き受けるようにします。これにより、オンプレミスから直接 CodeArtifact にアクセスできるようになります。
- AWS CodeArtifact とパブリックリポジトリの連携
  - 1. CodeArtifact リポジトリの作成: CodeArtifact リポジトリは、ソフトウェアパッケージ（依存関係を含む）を保存・管理するための場所です。これを AWS で作成します。
  - 2. 外部接続の設定: 外部接続を使うと、CodeArtifact リポジトリがパブリックリポジトリ（例えば、npm や Maven など）と直接連携できるようになります。
  - 依存リポジトリをアップストリームとして設定: アップストリームとは、依存関係を取得する元となるリポジトリのことです。CodeArtifact リポジトリに対して、必要なパブリックリポジトリ（npm や Maven など）をアップストリームとして設定します。
  - <img width="503" alt="image" src="https://github.com/yoshikikasama/system/assets/61643054/87970e7c-160f-44c8-a4d6-ab250c9c1ead">
  - アップストリームは、依存パッケージを供給する元（パブリックリポジトリなど）です。
  - ダウンストリームは、供給されたパッケージを使用してビルドやデプロイを行う側（自社の CI/CD パイプラインなど）です。

## 63.

- CloudFormation スタックが UPDATE_ROLLBACK_FAILED 状態のままになっている場合:

  - そのスタックで実行できるアクションは ContinueUpdateRollback または DeleteStack のオペレーションのみになります。これは、CloudFormation がユーザーからの追加入力を必要とし、ロールバックしようとしているテンプレートとスタックが同期していないことを確認するためです。ロールバックを再試行してエラーを解決するには、ContinueUpdateRollback を使用します。
  - 解決するには、手動で修正してロールバックする。

- あなたのアプリケーションは、Application Load Balancer（ALB）の背後にある Amazon EC2 インスタンスで実行されています。DevOps エンジニアが AWS CodeDeploy を使用して新しいバージョンをリリースしていますが、デプロイの際に「AllowTraffic」ライフサイクルイベント中に失敗してしまいます。この際、デプロイログにエラーが報告されていません。

  - 解決策: AllowTraffic ライフサイクルイベントが失敗し、デプロイログにエラーが報告されない場合の原因は、多くの場合、ヘルスチェックの設定が間違っているためです。
  - AllowTraffic ライフサイクルイベント: AWS CodeDeploy のライフサイクルイベントの一つで、アプリケーションがトラフィックを受け入れ始めるタイミングを管理します。このイベントが成功すると、ユーザーからのトラフィックが新しいバージョンのアプリケーションにルーティングされます。
  - ALB や他のロードバランサー（Classic Load Balancer や Network Load Balancer）のヘルスチェック設定が正しくない場合、インスタンスは「ヘルシー」と判断されず、トラフィックを受け入れる準備が整っていないとみなされます。

- Kibana では、IAM ユーザーとロールがネイティブにサポートされていませんが、Amazon ES には Kibana へのアクセスを制御するためのいくつかのソリューションが用意されています。
  - Kibana の SAML 認証を有効にします。
  - HTTP 基本認証できめ細かなアクセスコントロールを使用します。
  - 設定 Amazon Cognito Kibana の 認証.
  - パブリックアクセスドメインの場合は、プロキシサーバーのある、または IP ベースのアクセスポリシーを設定します。
  - VPC アクセスドメインの場合、プロキシサーバーのある、またはないオープンアクセスポリシーを使用し、セキュリティグループを使用してアクセスを制御します。詳細については、「VPC ドメインのアクセスポリシーについて」を参照してください。

-　 Amazon OpenSearch Service（旧称 Amazon Elasticsearch Service）: オープンソースの検索および分析エンジンである Elasticsearch をクラウド上で提供するマネージドサービスです。これは、ログの分析、リアルタイムのアプリケーションモニタリング、インフラストラクチャのパフォーマンス分析などに使用されます。

- Kibana は、Elasticsearch のデータを可視化するためのオープンソースのダッシュボードツールです。ユーザーは、Kibana を使用して、インデックスされたデータを検索、表示、および分析するインタラクティブなダッシュボードを作成できます。Amazon OpenSearch Service は、データ検索と分析のためのマネージドサービスであり、Kibana はそのデータを可視化するためのツールです。Kibana へのユーザーアクセスを制限するには、SAML 認証や Amazon Cognito 認証を使用する方法があります。
- ![image](https://github.com/yoshikikasama/system/assets/61643054/00208cba-d705-44b9-ad06-1f01b2b4980b)

- AWS Global Accelerator は、パブリックアプリケーションの可用性、パフォーマンス、およびセキュリティの向上に役立つネットワークサービスです。Global Accelerator は、Application Load Balancer、Network Load Balancer、Amazon Elastic Compute Cloud (EC2) インスタンス、エラスティック IP などのアプリケーションエンドポイントへの固定エントリポイントとして機能する 2 つのグローバル静的パブリック IP を提供します。
- Amazon DynamoDB Accelerator(DAX): DynamoDB と互換性のあるフルマネージド型のインメモリキャッシュサービスになります。
  レスポンスをミリ秒単位からマイクロ秒単位まで高速化することが出来ます。

## 64.

- IAM PassRole: PassRole は、AWS IAM のアクションの一つで、特定の IAM ロールを他の AWS サービスに渡す権限をユーザーに付与するものです。これは、AWS リソースがユーザーに代わってアクションを実行するために重要な役割を果たします。
- なぜ PassRole が必要なのか: たとえば、AWS CloudFormation がスタックを作成・更新する際に、CloudFormation がリソースを操作するための権限を持つ IAM ロールを使用する必要があります。この場合、ユーザーは CloudFormation に対してその IAM ロールを「渡す」必要があります。これを行うために必要なのが PassRole 権限です。

-　ウェブ ACL（Web Access Control List）は、AWS WAF（Web Application Firewall）で使用される設定で、ウェブアプリケーションに対する HTTP および HTTPS リクエストのトラフィックを制御するためのルールセットを定義します。ウェブ ACL は、特定のルールに基づいてリクエストを許可または拒否することができ、セキュリティやアクセス制御を強化するために使用されます。

## 65.

- Service Quotas: 一元的な場所からクォータを表示および管理できる AWS のサービスです。クォータ (制限とも呼ばれます) は、AWS アカウント のリソース、アクション、アイテムの最大値です。Service Quotas が AWS Organizations に関連付けられている場合、クォータリクエストテンプレートを作成して、アカウントの作成時に自動的にクォータの引き上げをリクエストできます。

- 段階的な AWS Lambda デプロイを提供するために CodeDeploy が組み込まれています。

  - Canary: トラフィックは 2 回の増分で移行されます。事前定義された Canary オプションから選択できます。このオプションは、最初の増分で更新された Lambda 関数バージョンに移行されるトラフィックの割合と、2 番目の増分で残りのトラフィックが移行されるまでの間隔を分単位で指定します。
  - Linear: トラフィックは、毎回同じ間隔（分）の等しい増分で移行します。増分ごとに移行されるトラフィックの割合と、増分間の間隔 (分) を指定する事前定義された Linear オプションから選択できます。
  - AllAtOnce: すべてのトラフィックは元の Lambda 関数から最新バージョンの Lambda 関数に一度に移行されます。
- ![image](https://github.com/yoshikikasama/system/assets/61643054/e6043f63-c984-40c1-91e8-41986d0df0b0)

新しいターゲットグループを作成

各APIエンドポイント（例えば、/api/endpoint1）に対して、Lambda関数ターゲットグループを作成します。
既存のターゲットグループと新しいターゲットグループの設定

既存のEC2インスタンスベースのターゲットグループ（例えば、EC2-Endpoint1）を維持し、新しいLambda関数ターゲットグループ（例えば、Lambda-Endpoint1）と併用します。
Application Load Balancer (ALB)のリスナールールを設定

ALBのリスナーに、新しいパス条件と重み付けルールを設定します。例えば、/api/endpoint1に対して以下のような設定を行います：
EC2-Endpoint1ターゲットグループに80%のトラフィックを割り当てる
Lambda-Endpoint1ターゲットグループに20%のトラフィックを割り当てる
これにより、新しいLambda関数バージョンのテストが限られた数のお客様で行われ、既存のALBアクセスログに影響を与えず、ログ処理サービスとの互換性も維持されます。
