# Techstock

## 11

- トランザクション制御:

  - BASE モデル : 可用性が最重要視され、緩い状態を基本とし、最終的に一貫性が取れるということを意味している。BASE の考え方で ACID を担保しそうな部分は「Eventual consistency （最終的な一貫性）」のみですが、これだけでは原子性や独立性、永続性が欠落しています。（言及されていないということはつまり、担保されないという事になります）
    - Basicall Available: 基本的に利用可能
    - Soft State: 柔らかい状態
    - Eventual Consistency: 最終的な一貫性
  - ACID モデル: 大量の情報を同時処理しても情報が壊れずに格納できる
    - Atomicity: 原子性
    - Consistency: 一貫性
    - Isolation: 独立性
    - Durability: 永続性

- EBS スナップショットからの復元作業:
  - EC2 インスタンス A の EBS ボリューム A から新しい EBS ボリューム B を作成
  - EC2 インスタンス A の別のディレクトリ(/mnt/new-volume)に EBS ボリューム B をマウント
  - /mnt/new-volume にマウントされた新しいボリューム B にアクセスし、実際のボリューム A 内のウェブサイトのデータをコピーします。

## 13.

- AWS Storage Gateway のバックアップ戦略:

  - キャッシュボリューム: 全てのデータがローカルに保存されているわけではありません。データは仮想アプライアンス経由で Amazon S3 へと保存されますが、その際に仮想アプライアンスにマウントされている Cache Volume に一時的に保存されます。勘の鋭い方はお気づきかと思いますが、データへのアクセスが発生した際、Volume Gateway はまず Cache Volume を参照します。Cache Volume にデータが存在しなかった場合のみ、Amazon S3 へリクエストを行って対象のファイルを取得してきます。ローカルに用意するディスクの容量を最小限に抑えられる点にあります。
  - 保管型ボリューム: 新規にアップロードされたデータをローカルのディスクに保存した上で、非同期的に AWS へとバックアップを行います。すべてのデータがローカルに保存されているため、クライアントからは高速にデータにアクセスすることができます。オンプレミスにデータを保管した上で、バックアップやディザスタリカバリを目的として Storage Gateway を利用することができます。

- BGP（Border Gateway Protocol）: 異なるネットワーク間の経路情報を交換するためのプロトコルであり、オンプレミスネットワークへのトラフィックを正しくルーティングするのに役立ちます。

- 伝播: ルート情報がネットワーク内で広まることを指します。具体的には、ルーターやネットワークデバイス間で経路情報が共有され、ネットワーク上の他のデバイスがその情報を知ることができるようになります。オンプレミスネットワークから AWS Direct Connect を介して接続する場合、BGP を使用してオンプレミスネットワークの特定のルート情報（目的地ネットワークに対する経路）を AWS Direct Connect のお客様のルーター上で伝播（共有）することが必要です。

- 選択したルーティングテーブルに新しいルートを追加します。これは、オンプレミスネットワーク用の特定ルートを指定します。BGP によって伝播されたルート情報を使用するため、目的地としてオンプレミスネットワーク内のネットワークを指定し、ターゲットとして AWS Direct Connect ゲートウェイを指定します。

- ウェブプロキシサーバー: アウトバウンドアクセスの URL ベースのルールを実行するため、特定の URL（製品の更新サイト）以外へのアクセスはブロックします。デフォルトルートを削除することにより、明示的なアウトバウンドアクセスがなければ、インスタンスからのトラフィックはウェブプロキシサーバーを通過するように制限されます。ウェブプロキシサーバーが設定されている場合、インスタンスからのトラフィックはウェブプロキシサーバーを通過するように制限されます。そのため、ウェブプロキシサーバーの設定に基づいてアクセスが許可された特定の宛先のみに制限されます。それ以外の宛先へのアウトバウンドアクセスは拒否されます。

- CloudFront OAI (Origin Access Identity): CloudFront ユーザーを作成して S3 Bucket へアクセスができる。現在は、OAC が推奨されている。
- https://dev.classmethod.jp/articles/amazon-cloudfront-origin-access-control/

- VPC ピアリング: VPC あたりのアクティブな VPC ピアリング接続の上限は 125 個。

- IPSec（Internet Protocol Security）Tunnel:インターネット上での通信にセキュリティを提供するためのプロトコルです。IPSec は、VPN（Virtual Private Network）や他のセキュアなネットワーク接続に使用されます。IPSec トンネルは、公衆インターネットなどの不信なネットワーク上で、安全かつ暗号化された通信経路を確立するために使用されます。通常、IPSec トンネルは、送信元と宛先のネットワーク機器（ルーターやファイアウォールなど）間で確立されます。オフィス間の安全な接続やリモートアクセス VPN など、さまざまなシナリオで使用されます。トンネルは、パケットの送信元 IP アドレスと宛先 IP アドレスに基づいてルーティングされ、通信データはトンネル内で暗号化および保護されます。これにより、ネットワーク上の第三者が通信データを盗聴したり改ざんしたりすることを防ぐことができます。

## 14.

- Amazon S3 Transfer Acceleration: クライアントと S3 Bucket の間で、長距離に渡るファイル転送を高速、簡単、安全に行えるようにする。世界中に分散した CloudFront のエッジロケーションを使用しており、エッジロケーションに到着したデータは、最適化されたネットワークパスで Amazon S3 にルーティングされる。

- DHCP(Dynamic Host Configuration Protocol):

  - VPC 内のデバイスで使用される DNS サーバー、ドメイン名、または Network Time Protocol (NTP) サーバーを制御できます。
  - VPC で DNS 解決を完全に無効にできます。
  - サブネット内の EC2 インスタンスで実行されているアプリケーションは、必要に応じて Amazon DHCP サーバーと通信して、IP アドレスリースまたは他のネットワーク構成情報 (Amazon DNS サーバーの IP アドレスや VPC 内のルーターの IP アドレスなど) を取得できます。

- DHCP オプションセット: VPC 内の EC2 インスタンスが仮想ネットワーク経由で通信するために使用するネットワーク構成のグループ。カスタム DHCP オプションセットを作成するか、VPC から全てのオプションセットの関連付けを解除しない限り、リージョン内の各 VPC は同じデフォルトの DHCP オプションセットを使用する。

  - デフォルトオプションセット: デフォルトの DNS サーバーが含まれています。これは通常、Amazon-provided DNS と呼ばれる Amazon 内部の DNS サービスです。デフォルトでは、この Amazon-provided DNS が VPC 内のリソースに対して DNS 名の解決を提供します。
  - カスタム DHCP オプションセット: 自前の DHCP サーバ等を使いたい場合、DNS サーバ・NTP サーバ・NetBIOS ネームサーバーを使いたい場合に作成。デフォルト DHCP オプションセットを変更できないため、外部の NTP サーバーを使いたい要件が出てきたら必要となる。

- Amazon Route 53 Resolver: 特定のサブネットや AZ には存在せず、VPC に標準で備わっている DNS サーバー。以下の DNS クエリに対応。

  - EC2 インスタンスのローカル VPC ドメイン名
  - プライベートホストゾーンのレコード
  - フルリゾルバに対して外部ドメイン名の再帰的検索

- Amazon RDS: DB インスタンスとは異なる AWS リージョンにリードレプリカを作成できる。

- CloudFront: 短期間でダウンタイムを回避する最適なシナリオは、短期間でスケーリングを改善すること。CloudFront でデータをキャッシュし、既存のインフラストラクチャの負荷を軽減する。

## 15.

- SQS FIFO キュー:
  - FIFO(First In First Out)配信および 1 回だけの処理。単一キュー内に複数の順序付けされたメッセージグループがサポートされている。
  - メッセージが送信または受診された順序が厳密に保持される。
- SQS Standard キュー: 少なくとも 1 回は確実に配信されるが、複数のコピーまたはメッセージが配信されることもある。メッセージが送信されたのとは異なる順序で配信されることもある。

- DynamoDB: 高速でスケーラブルな NoSQL DB サービス。
  - セカンダリインデックス: 主キー以外の属性に基づいてテーブルのデータを検索するための補助的なデータ構造です。
    - ローカルセカンダリインデックス（LSI）: 元のテーブルと同じパーティション内でデータをソートするため、データの配置や順序に変化はありません。
    - グローバルセカンダリインデックス（GSI）: 異なるパーティションキーを持つデータを別々のパーティション内でソートする。
- DynamoDB におけるスパースインデックス: 属性が存在するアイテムのみをインデックスに含めることができます。メ属性が存在しないアイテムはインデックスに含まれません。

- Route 53:

  - 加重ルーティング: 指定した比率で複数のリソースにトラフィックをルーティングする場合に使用します。これは単一のドメイン名 (example.com) またはサブドメイン名 (acme.example.com) に複数のリソースを関連付け、各リソースにルーティングされるトラフィックの数を選択できます。このルーティングは負荷分散や新しいバージョンのソフトウェアのテストなど、さまざまな目的に有用です。
  - ![Screen Shot 2022-08-23 at 7 12 26](https://user-images.githubusercontent.com/61643054/186027858-600a72c3-a876-4eed-b1b8-9d14c575eb76.png)
  - レイテンシールーティング（遅延ルーティング）: 複数の AWS リージョンでアプリケーションがホストされている場合、ネットワークレイテンシーが最も低い AWS リージョンに基づいてリクエストを処理することで、ユーザーのパフォーマンスを向上させる。

- CloudFront とカスタムオリジンの間で HTTPS を必須にするよう CloudFront を設定する:

  - Origin Protocol Policy:
    - [HTTPS Only (HTTPS のみ)]: CloudFront は HTTPS のみを使ってカスタムオリジンと通信します。
    - [Match Viewer (ビューワーに合わせる)]: CloudFront は、ビューワーのリクエストのプロトコルに応じて HTTP または HTTPS を使用し、カスタムオリジンと通信します。例えば、オリジンプロトコルポリシー の [Match Viewer (ビューワーに合わせる)] を選択し、ビューワーで HTTPS を使用して CloudFront からオブジェクトをリクエストする場合は、CloudFront でも HTTPS を使用してリクエストをオリジンに転送します。オリジンで HTTPS が設定されていない場合にエラーが発生します。
    - [Viewer Protocol Policy]で、[Redirect HTTP to HTTPS] または [HTTPS Only] を指定する場合は、[Match Viewer] のみを選択します。ビューワーが HTTP と HTTPS の両方のプロトコルを使用してリクエストを行った場合も、CloudFront がオブジェクトをキャッシュするのは 1 回だけです。

- TCP ソケット: TCP 通信において、クライアントとサーバー間でデータを送受信するための接続

- TCP: 信頼性のあるデータ転送が必要な場合に使用されます。例えば、ファイルのアップロードやダウンロード、電子メールの送受信、リモートアクセスなど。
- HTTP: ウェブブラウザとウェブサーバー間のデータ転送に使用されます。具体的には、ウェブページの閲覧、フォームの送信、画像や動画のダウンロード、API の呼び出しなど。

- ELB: トラフィックを複数のアベイラビリティーゾーン（AZ）にわたって均等に分散するため、サーバーの負荷を分散し、冗長性を確保することができます。
- Proxy Protocol: ロードバランサーやプロキシサーバーを介して複数の層を通過するトランスポート層のプロトコルです。通常、ネットワークトラフィックがロードバランサーやプロキシサーバーを通過すると、オリジナルのクライアントの IP アドレス情報は失われてしまいます。しかし、Proxy Protocol を使用することで、ロードバランサーやプロキシサーバーを通過した後でもクライアントの IP アドレス情報を保持することができます。AWS の場合、ELB（Elastic Load Balancer）を使用してクライアントからのリクエストをアプリケーションサーバーに転送する際に、Proxy Protocol を有効にすることができます。Proxy Protocol を有効にすると、ELB はクライアントの IP アドレス情報を含んだヘッダー情報をアプリケーションサーバーに渡すことができます。これにより、アプリケーションサーバーは正確なクライアントの IP アドレスを取得し、必要な処理を行うことができます。
  - TCP リスナ（TCP Listener）：ELB が受け取るリクエストのプロトコルとポート番号を指定する機能です。TCP リスナを設定することで、ELB は指定したポート番号でクライアントからの TCP 接続を待ち受け、リクエストをアプリケーションサーバーに転送します。例えば、TCP リスナをポート番号 80 に設定すると、ELB はクライアントからの HTTP リクエストを受け付けます。
  - クロスゾーンロードバランシング（Cross-Zone Load Balancing）： ELB が異なるアベイラビリティーゾーン（AZ）にある複数のアプリケーションサーバーに対してトラフィックを均等に分散する機能です。通常、ELB は各 AZ ごとにロードバランシングを行い、AZ ごとにトラフィックを分散します。しかし、クロスゾーンロードバランシングを有効にすると、ELB は複数の AZ を 1 つのプールとして扱い、すべてのアプリケーションサーバーに均等にトラフィックを分散します。これにより、各 AZ に均等に負荷がかかり、高可用性とスケーラビリティが向上します。

## Route53 のフェールオーバー構成と ELB と Auto Scaling

- Route53 のフェールオーバールーティングと ELB: 異なるリージョンでプライマリー、セカンダリー構成が可能、あくまでリージョン単位。
  - Route53 は ELB のヘルスチェックを行い、障害時に sorry ページへ行く
  - <img width="771" alt="Screenshot 2022-12-31 at 9 21 49" src="https://user-images.githubusercontent.com/61643054/210119551-0ea870da-a7ca-4513-b926-91f2988d006a.png">
  - <img width="856" alt="Screenshot 2023-01-27 at 22 36 03" src="https://user-images.githubusercontent.com/61643054/215100045-4061f796-12ec-4546-af48-9d80d85f7f07.png">

## ヘルスチェック

- Route53 のヘルスチェック:

  - エンドポイントをモニタリングするヘルスチェック: IP アドレスあるいはドメイン名で特定するエンドポイントをモニタリングするヘルスチェックを設定できます。指定された一定の間隔で、Route 53 は自動リクエストをインターネット経由でアプリケーションやサーバーなどのリソースに送信して、そのリソースが到達可能、使用可能、機能中であることを確認します。
  - 他のヘルスチェック (算出したヘルスチェック) を監視するヘルスチェック: 他のヘルスチェックが正常あるいは異常であるかを Route 53 が判断するかについてをモニタリングするヘルスチェックを作成できます。複数のウェブサーバーなどの同じ機能を実行する複数のリソースがあるときに、最低限のリソースが正常であるかどうかに重点を置く場合などに使用する。
  - CloudWatch アラームをモニタリングするヘルスチェック: CloudWatch アラームを作成したら、そのアラームをモニタリングする CloudWatch と同じデータストリームをモニタリングするヘルスチェックを作成できます。
  - エンドポイントの正常性を確認する HTTP、HTTPS、および TCP ヘルスチェックを作成できます。
  - ELB のヘルスチェックも行う
  - Route53 は region を跨ぐ:
    - ![Screenshot 2023-06-11 at 9 24 05](https://github.com/yoshikikasama/network-and-server/assets/61643054/9598fafb-44f5-4ec3-9f85-43decee53edf)

- ELB のヘルスチェック: EC2 インスタンス群などのターゲットグループ単位でヘルスチェックを行う。
- Auto Scaling Group:

  - EC2 のステータス: EC2 インスタンスのステータスが runnning 以外の時
  - ELB: ELB のヘルスチェック機能で ELB が異常の時にスケーリング

- S3 からユーザーコンテンツを提供します。各リージョンの ELB 間で Route 53 レイテンシーベースルーティングを使用します。各リージョンの DynamoDB テーブからユーザ設定を取得し、SQS ワーカーを使用して各テーブルに更新を伝播するために SQS を利用してユーザ設定への変更を伝達します。

  - この構成では、ユーザーのリクエストが Route 53 を介して適切なリージョンの ELB にルーティングされます。ELB はリクエストを受け取り、対応するリージョンの EC2 インスタンスに転送します。EC2 インスタンスは必要なデータを S3 から取得し、DynamoDB からユーザー設定を取得します。また、SQS Worker は DynamoDB の更新を監視し、変更を受け取った場合には対応するリージョンの DynamoDB テーブルに更新を伝播します。この構成により、複数のリージョンでアプリケーションを実行し、ユーザー設定の変更を効率的に伝播させることが可能となります。また、Route 53 のレイテンシーベースのルーティングを使用することで、ユーザーへのアクセスレイテンシーを最小限に抑えることができます。

                            +-----------------+
                            |   Route 53 DNS  |
                            +--------+--------+
                                     |
                          +----------+----------+
                          |                     |
               +----------v----------+  +-------v-------+
               |   ELB (Region 1)    |  |  ELB (Region 2) |
               +----------+----------+  +-------+-------+
                          |                     |
               +----------v----------+  +-------v-------+
               |    EC2 Instances    |  |  EC2 Instances |
               +----------+----------+  +-------+-------+
                          |                     |
          +---------------v-----------------v---------------+
          |                                               |
          +------v-------+                        +-------v------+
          | DynamoDB |                            | DynamoDB |
          | (Region 1) |                          | (Region 2) |
          +------+-------+                        +-------+------+
          |                                               |
          +------v-------------------+      +--------------v-------+
          |                          |      |                       |
          | SQS Worker (Region 1)    |      | SQS Worker (Region 2) |
          |                          |      |                       |
          +-------------------------+       +----------------------+

## 16.

- DDoS(Distributed Denial of Service attack): 標的となるコンピュータに対して複数のマシンから大量の処理負荷を与えることで、サービスを機能停止状態へ追い込む手法のこと。
  - CloudFront: 攻撃の緩和に役立ちます。また、地域制限(地理的ブロッキング)を使用すると、CloudFront ウェブディストリビューションを通じて配信しているコンテンツについて、特定地域のユーザーによるアクセスを回避できます。
  - Auto Scaling グループを備えた ELB はスケールして攻撃を吸収するのに役立ちます。
- Elasitc Network Interface(ENI): 仮想ネットワークカードを表す VPC 内の倫理ネットワーキングコンポーネント。アカウントで独自のネットワークインターフェイスを作成して、VPC 内のインスタンスにアタッチできる。

  - プライマリーネットワークインターフェース: eth0。デフォルトのネットワークインターフェース。アクセス制御を強化した VPC 内の個別のサブネットに接続。
  - セカンダリーネットワークインターフェース: 追加でアタッチでいる ENI。public 側のトラフィックを処理する。

- CPU 使用率に基づいてインスタンスを追加、削除できるようにする方法:

  - EC2 インスタンスにソフトウェアをインストールし、カスタム AMI 作成
  - 起動設定にカスタム AMI を指定
  - Auto Scaling Group に先ほどの起動設定を指定
  - Cloud Watch Alarm で Auto Scaling Group Policy を作成し、CPU 使用率に応じてスケールインとスケールアウトを行う。

- エフェメラルポート: クライアントとの接続中に生成される一時的なポート番号です。アプリケーションが外部リソースに接続する際には、クライアントからのリクエストに応答するためにエフェメラルポートが使用されることが一般的です。そのため、アウトバウンドルールではエフェメラルポート範囲を指定しています。

- 既存のルーティングインフラストラクチャ: お使いのネットワーク内で既に存在しているルーティング設定や機器などを指します。具体的な例としては、オンプレミスネットワーク内のルーターやスイッチなどが考えられます。
- BGP ルートを既存のルーティングインフラストラクチャに再配布する: AWS Direct Connect 接続で得られた BGP（Border Gateway Protocol）ルートを既存のルーティングインフラストラクチャに伝えることを意味します。BGP はインターネット上の経路情報を交換するためのプロトコルであり、BGP ルートの再配布により、AWS Direct Connect 経由のネットワークトラフィックを既存のネットワークに統合します。
- AWS へのデフォルトルートを経路広告(アドバタイズ)する: 既存のルーティングインフラストラクチャから AWS に対してデフォルトルート（0.0.0.0/0）を通知することを意味します。これにより、AWS へのトラフィックが AWS Direct Connect 経由でルーティングされるようになります。

- AWS Direct Connect を介して AWS にデフォルトルートを経路広告することは、AWS Direct Connect を優先的な経路として設定する意味です。
- AWS Direct Connect: インターネットサービスプロバイダ（ISP）を介して AWS のパブリックサービスに接続するための専用接続を提供します。

- BGP ルートの再配布は、AWS Direct Connect で受け取ったネットワーク経路情報を既存のネットワークに統合する手順です。
- デフォルトルートの経路広告は、既存のネットワークから AWS に対してデフォルトルートを通知する手順です。これにより、AWS へのトラフィックが既存のネットワーク内で AWS Direct Connect 経由でルーティングされるようになります。
- 既存のルーティングインフラストラクチャからのトラフィックが AWS Direct Connect を経由して AWS に直接送信されるように設定する方法です。

- スタティックルート（Static Route）: ネットワークデバイス（ルーターやスイッチ）に手動で設定される経路情報です。スタティックルートは、特定の宛先ネットワークやサブネットへのトラフィックを特定の次のホップ（ネクストホップ）に送信するための設定です。ネットワーク管理者が手動で設定するため、動的なルーティングプロトコル（例：BGP）に比べて設定が簡単で管理が容易です。また、スタティックルートは一定の経路を明示的に指定するため、ネットワークトラフィックのルーティングパスを制御する際に有用です。スタティックルートは一時的なルーティングの設定や特定のネットワークトラフィックの制御に使用されますが、大規模なネットワークやダイナミックな環境では、動的なルーティングプロトコルがより効果的です。動的ルーティングプロトコルはネットワーク間の経路情報を自動的に交換し、変更に迅速に適応することができます。スタティックルートは、AWS の VPC やオンプレミスネットワークなど、さまざまなネットワーク環境で使用されることがあります。特に、AWS Direct Connect を介して AWS のパブリックサービスへのアクセスを制御するために、スタティックルートの設定が行われることがあります。

- パブリックインターフェイスを作成する必要: AWS Direct Connect を介して AWS のパブリックサービスにアクセスするためです。パブリックインターフェイスは、AWS のパブリックリソースに接続するための仮想インターフェイスです。これを作成することで、BGP セッションを確立し、ルーターがルートを学習してデータを転送することができます。

- AWS に特定のルートを経路広告するとは、BGP（Border Gateway Protocol）を使用して、AWS Direct Connect 接続を介して到達可能なネットワークの経路情報を他のルーターに伝えることを意味します。具体的には、AWS Direct Connect 接続の BGP セッションを確立した後、自身のルーター上で特定のネットワークの経路を AWS にアドバタイズ（広告）します。これにより、他のルーターやインターネット上の BGP ピアと共有されることで、その特定のネットワークへのトラフィックが AWS Direct Connect 経由で送信されるようになります。
- スタティックルートではなく BGP を設定する必要がある理由は、BGP（Border Gateway Protocol）がダイナミックルーティングプロトコルであり、ネットワークの変更や障害に柔軟に対応できるからです。BGP を使用することで、AWS Direct Connect 経由のルート情報を自動的に広告し、最適な経路を選択することができます。一方、スタティックルートは手動で設定する必要があり、ネットワーク変更に対応するためには手動で更新する必要があります。BGP を使用することで、より柔軟かつ効率的なルーティング制御が可能となります。
- 基本的には、AWS Direct Connect を介して AWS のパブリックサービスへのアクセスや特定のネットワークへのトラフィック制御を行う場合、スタティックルートよりも BGP を使用することが一般的です。

- AWS Direct Connect の冗長構成:

  - フェイルオーバーを提供するため、下の図にあるように、AWS への専用接続を 2 つリクエストして設定することをお勧めします。これらの接続は、お客様のネットワーク内の 1 台もしくは 2 台のルーターを終端とすることができます。
  - ![Screenshot 2023-06-11 at 13 03 34](https://github.com/yoshikikasama/network-and-server/assets/61643054/6c2f5856-d36e-4296-9040-c26a95384622)

- Customer Gateway (CGW): オンプレミスのデータセンターから送信されるトラフィックのお客様側のエンドポイント
- Virtual Private Gaetway (VPG): VPC でインスタンスが CGW(オンプレミスのサーバー宛)に到達できるようにするために必要。
