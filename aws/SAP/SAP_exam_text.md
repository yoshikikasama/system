# SAP 試験テキスト

- IAM について:

  - https://qiita.com/c60evaporator/items/0121399880625cc1de51
  - 管理ポリシー → スタンドアロン（ユーザーやロールとは別個に作成する）ポリシー
    - AWS 管理ポリシー → AWS がデフォルトで準備している IAM 管理ポリシー
    - カスタマー管理ポリシー → 利用者が独自に作成、管理する管理ポリシー
  - インラインポリシー → 1 つのアイデンティティ（ユーザー、ロール、グループ）に埋め込まれたポリシー
  - AWS 管理ポリシーを使用 → 必要に応じてカスタマー管理ポリシーを追加の順で選択・運用する事が推奨されています (インラインポリシーは推奨度低)
  - policy の記述:
    - Version → ポリシーの記述言語のバージョン（基本的には 2012/10/17 で固定）
    - id → ポリシーの識別子（オプションのため、上記 AmazonS3ReadOnlyAccess では記述なし）
    - Statement → ポリシーの詳細を記述するフィールド
    - Statement フィールドの下には、以下のフィールドに具体的な条件を記述する必要があります。
    - Effect → アクセス権限の種類（基本的には"Allow"(許可)か"Deny"(拒否)）
    - Action → 許可または拒否するアクション（アスタリスク\*は以下の全アクションが対象となる）
    - Resource → アクションの設定対象となるリソース一覧（S3 の場合、バケット名等を指定）
    - Sid → 複数 Statement が存在する場合の識別子（上記 AmazonS3ReadOnlyAccess では記述なし）
    - Condition → ポリシー適用対象を絞るための追加条件（上記 AmazonS3ReadOnlyAccess では記述なし）
  - リソースベースのポリシー: 例えば S3 のバケットには、独自のリソースベースのポリシー(バケットポリシー)を設定する事ができます。これにより、アクセスされる側であるバケットへのアクセス制御を実現する事ができます。リソースベースのポリシーは使用できるサービス（S3、SQS、VPC 等）が限られていますが、特定のリソース（例：S3 内の特定のバケットに保存された機密データ）のセキュリティを選択的に高めたい場合に役立つでしょう。
  - 信頼ポリシー: あるロールが持っている権限を他のプリンシパル（ユーザー、グループ、ロール）に移譲することができます
  - PassRole: Role を移譲するポリシー

- VPC:

  - https://qiita.com/c60evaporator/items/2f24d4796202e8b06a77
  - サブネット: ネットワーク部が等しい IP アドレス範囲のこと。サブネットを表すアドレスをネットワークアドレスと呼びます
  - ルーティング: サブネットの結節点において他のサブネットとの通信経路を決定する制御を指します。自サブネット以外との通信にはルーティングが必要となるため、複数のサブネットが存在するネットワークにおいて必須の技術と言えます。
  - ルーティングテーブル: ルーティングのルールを定めるテーブル。ルールの決め方には、IP アドレスに基づいて毎回同じ経路が選択される「静的ルーティング」と、動的に経路が決定される「動的ルーティング」が存在しますが、VPC では基本的に静的ルーティングを使用します (VPN やトランジットゲートウェイ使用時は BGP による動的ルーティングでオンプレネットワークと連携することもできます)
  - VPC においては、「ルートテーブル」というサービスを使用する事でサブネット (後述)ごとにルーティングを制御できます。
  - DHCP(Dynamic Host Configuration Protocol): ホストにネットワーク関係の情報を渡すためのプロトコルです。一般的に、ホストにプライベート IP アドレスを動的に割り振る際に使用されますが、それ以外にも DNS サーバの IP アドレスやデフォルトゲートウェイ(ルーター)の IP アドレス等の情報がホストに渡されます。VPC においても、後述の Elastic IP を使用しない限りはこの DHCP 機能が働き、VPC 内部のインスタンスの IP アドレスは動的に割り振られます (再起動すると IP アドレスが変わる)
  - 外向き：内部ネットワーク(VPC 等)からインターネット方向への通信
  - 外向き：内部ネットワーク(VPC 等)からインターネット方向への通信
  - パブリックサブネット:
    - インターネットと直接通信できるサブネット。
    - インターネットゲートウェイにルーティングされるサブネット。
    - パブリックサブネットは外部から(へ)のアクセスが必要な Web サーバやプロキシサーバを設置する。
  - プライベートサブネット:
    - インターネットと直接通信できないサブネット
    - インターネットとの通信が必要ないインスタンスを設置する
  - メインルートテーブル：VPC ごとに自動で作成されるルートテーブル(編集も可能)。サブネットルートテーブルが設定されていないサブネットに適用される
  - サブネットルートテーブル：ユーザが自分で作成し、サブネットと紐づけるルートテーブル
  - インターネットゲートウェイと NAT ゲートウェイ:
    - ![Screenshot 2023-07-02 at 8 28 32](https://github.com/yoshikikasama/network-and-server/assets/61643054/d482496d-ca4f-491f-913c-32b91078bfbe)
    - インターネットゲートウェイ: パブリックサブネットを作成する際に必ず必要となるサービスであり、インターネットとの外向き、内向き双方向の通信を許可します。
    - NAT ゲートウェイ: プライベートサブネットから外向きの通信のみを許可する(内向きは許可しない)サービス。
  - Security Group: サーバ単位あるいはサービス単位といった単位のフィルタ
  - Network ACL: 「特定の IP アドレスからは一切通信をドロップする」といったネットワーク単位での大きなフィルタ
  - ![Screenshot 2023-07-02 at 9 15 21](https://github.com/yoshikikasama/network-and-server/assets/61643054/498cb239-c26a-40ad-be91-6cd79aa8cca6)
  - <img width="760" alt="Screenshot 2023-07-03 at 22 10 52" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/efb25a85-dae8-4fd4-9f4d-e0e23d1c2a48">
  - Egress Only インターネットゲートウェイ: IPv6 専用のインターネットゲートウェイで、外向きの通信のみを許可する(内向きは許可しない)という意味
  - ネットワークファイアウォール: ホワイトリスト・ブラックリスト両者、かつステートレス・ステートフル両者を設定可能で、柔軟なアクセス制御を実現できます。注意点として、ネットワークファイアウォール使用時はルートテーブルを編集して、インターネットとの通信が必ずファイアウォールエンドポイントを経由するよう設定する必要があります。
  - AWS WAF:
    - Web アプリケーションの脆弱性を利用した攻撃から web アプリケーションを保護するサービス。
    - 複数のルールを組み合わせて使用
    - Application Load Balancer(ALB)、Amazon CloudFront、Amazon API Gateway、AWS AppSync にアタッチして使用。トラフィックの検査を開始するには、既存の ALB または CloudFront ディストリビューションでサービスを有効にする必要があります。
  - AWS Network Firewall:
    - VPC サブネットに配置して使用するマネージドサービス
    - ただの FW ではなくシグネチャベースの IDS/IPS としても使用可能
    - パケットのペイロードまで見て、フィルタリングを行う
    - ルールで評価した通信に対してアクションを選択可能
    - ![Screenshot 2023-07-08 at 19 37 11](https://github.com/yoshikikasama/network-and-server/assets/61643054/5120d839-78ae-4ee8-a4be-1f88026f4444)
    - ネットワークコスト:
      - AWS への受信（イン）は料金が発生しない
      - AWS からの送信（アウト）は料金が発生する
      - なんらかのゲートウェイを経由するとデータ転送量に応じた料金が発生する

- Amazon EC2:

  - ![Screenshot 2023-07-12 at 6 46 54](https://github.com/yoshikikasama/network-and-server/assets/61643054/a74721bc-d317-449a-8002-30aef0279c89)
  - AMI (OS): AMI (Amazon Machine Images)とは、インスタンス起動時に実行される OS イメージを表します。
  - インスタンスタイプ: サーバにおいて処理を実行する装置(CPU, メモリ等)を選択します。
    - t2.micro のような名称で表されます。名称の解釈として、t の部分がインスタンスの種類(ファミリー)、2 の部分が世代、micro の部分がサイズを表しており、ファミリーは用途と対応、世代とサイズは基本的に大きいほど高スペックとなります。
  - ストレージ (EBS):パソコンにおける HDD や SSD と同様に、EC2 にもストレージを付与する必要があります。特に、起動用 OS がインストールされたストレージ (ルートボリューム)は必須です。
    - EC2 のストレージには一般的に、EBS (Elastic Block Store)というサービスが用いられますが、特殊な用途ではインスタンスストアと呼ばれるサービスも使用されます。
    - ![Screenshot 2023-07-12 at 6 53 14](https://github.com/yoshikikasama/network-and-server/assets/61643054/8329ab9a-d459-4b6b-b63f-b53c54980650)
    - スループット: 大きなファイルを一度に読み書きする際の速度
    - IOPS: 細切れのファイルに頻繁に読み書きする際の速度
    - EBS は EC2 と一体化して動作するという特性上、同じ AZ 内の EC2 インスタンスとしか紐づけられません。
  - インスタンスストア:
    - EBS と比べデータ消失のリスクがある (冗長性がない＆インスタンス停止時にデータが消える)が、高速アクセス(特に IOPS が速い)が可能なストレージで、耐障害性を犠牲にしてでも高頻度アクセスにおける処理速度を重視したい用途 (一時ストレージ等)に向いています。
    - AWS でよく使用されるストレージに EFS が挙げられ、こちらは EBS のように EC2 にマウントでき、かつ複数の EC2 インスタンスで共有ができるため、NAS に近い存在と言えます (捉え方によっては S3 と EBS の中間的な存在とみなせる)。また EFS は Lambda や Fargate 等の EC2 以外のコンピューティングサービスでも使用できます。
    - ![Screenshot 2023-07-12 at 7 08 25](https://github.com/yoshikikasama/network-and-server/assets/61643054/883b0c9f-369a-4d16-a820-8eb69996ebf1)
  - ENI (Elastic Network Interface):
    - 通常の PC において、NIC と呼ばれる LAN ポートを内蔵したカードを着脱することで、ネットワークの接続経路を増やしたり減らしたりする事ができます。
    - AWS でも同様に、ENI (Elastic Network Interface)と呼ばれるサービスを着脱 (アタッチとデタッチ)する事で、ネットワークへの接続経路、すなわちインスタンスに付与された IP アドレスの数を増やしたり減らしたりすることができます。
    - ENI がないとネットワークにアクセスできないため、EC2 インスタンスにはデフォルトで 1 個 ENI が付加されていますが、さらに ENI を追加することもできます
  - プレイスメントグループ:
    - 物理的位置が遠いマシンと近いマシンでは、基本的に後者の方が通信速度(厳密には「行って帰ってくるまでの時間=RTT, レイテンシー」)が早くなります。
    - 同様に AWS においても、複数のインスタンスをグループ化して RTT が小さくなるよう配置することで、同一 AZ 内のインスタンス同士の通信速度を向上させるプレイスメントグループと呼ばれる機能が存在します。
    - ![Screenshot 2023-07-12 at 7 17 03](https://github.com/yoshikikasama/network-and-server/assets/61643054/271a7c2f-4470-425b-84cb-ad176c8de91d)
  - AMI とスナップショットの使い分け:
    - 元あったインスタンスの中身を再現するためには、AMI とスナップショット両方を取得する必要があります
    - AMI: インスタンスの構成情報(アーキテクチャ＋紐づいたスナップショット等)。AMI はスナップショットの紐付け情報も保持しているため、AMI はスナップショットを内包する存在とみなすこともできます。よって実用上は AMI のみを取得することでスナップショットを兼ねる事ができ、両者を別個にバックアップする必要は低いと言えます
    - スナップショット: EBS 内のデータ(OS の実イメージ＋後からインストールされたソフト等)
    - 作成した AMI を長期間放置するとセキュリティパッチ等が当たらずに危険なので、EC2 Image builder で定期的に中身を更新する事が推奨されます
  - EC2 Image builder:
    - 作成した AMI を長期間放置すると、内部の OS やパッケージにパッチや更新が適用されず、脆弱性が放置されてセキュリティ的に危険な状態となります。
    - このような事態を防ぐために、最新バージョンのパッケージがインストールされた AMI を自動で作成・展開できる EC2 Image builder と呼ばれる機能が準備されています。
  - 起動テンプレート:
    - 同じ設定のインスタンスを複数起動したい場合、上記の設定を毎回入力していては面倒です。そこで、インスタンス起動時の設定を「起動テンプレート」として登録することで、次回以降の設定入力を簡略化することができます。
    - この起動テンプレートは Auto Scaling 使用時はほぼ必須とも言える機能で、Auto Scaling グループ内のすべてのインスタンスに本機能で作成した設定を渡すことができます。
  - インスタンスの購入方式:
    - Savings Plans: リザーブドインスタンスが「期間内ずっとインスタンスを起動し続ける」事を前提としているのに対し、Savings Plans は「期間内ずっと、1 時間あたり最低 ◯ ドル分インスタンスを使用する」という、最低使用量が定められるサービスとなります。
  - セキュリティグループ:
    - VPC 内のリソース (インスタンス)と外部との通信を制限する機能。
    - デフォルトでは 25 番ポート(SMTP=メール転送での踏み台防止)以外全ての外向き通信を許可する。

- S3 Bucket:

  - アイデンティティベースとリソースベース(バケットポリシー, S3 アクセスポイント)両方のポリシーが設定された場合、両方のポリシーで許可されている主体のみがアクセスを許可されます。
  - アイデンティティベースのポリシー: アクセスする側(ユーザー、ロール)にアタッチするポリシー。S3 全体に対するアクセス権限を付与したい場合。
  - バケットポリシー非設定時はバケット所有者の AWS アカウントのみアクセスが許可されるので、バケットへのアクセスには以下のポリシー設定が必要となります
    - バケット所有者の AWS アカウントからバケットにアクセスする場合: アイデンティティベースのポリシーの設定が必要
    - 上記以外からバケットにアクセスする場合: アイデンティティベースとリソースベース両方のポリシーの設定が必要

## 2. 組織の複雑さに対する設計

- 混乱した代理問題: IAM Role の ARN 登録ごとに一意の外部 ID を発行

- AD Connector:
  - オンプレミスなどのデータセンターなどで稼働している Active Directory の認証をそのまま使用できる
  - VPN や Direct Connect で VPC とオンプレミスのネットワークを接続して使用する。
- Simple AD:
  - Samba 4 Active Directory Compatible Server
  - 最大 5000 ユーザー
- AWS Managed Microsoft AD:
  - 5000 を越えるユーザー
  - 他ドメインとの信頼関係
- SSO パターン:

  - ADFS(Active Directory Federation Services)を使用した AWS への SSO:
    - SAML2.0 互換につきコーディングの必要なし
    - AD セキュリティグループと IAM Role をマッピング
  - SAMPL サポートの IdP との SSO 構成:
    - SAML 対応の ID プロバイダーを設定できる
  - AWS SSO で ID ソースを AWS SSO とした構成:

    - SAML プロバイダーと IAM ロールの設定が AWS SSO によって自動化
    - AWS SSO にサインインすれば許可されたアカウントに許可された権限でアクセスできる。

  - VPC エンドポイント:
    - ゲートウェイエンドポイント: VPC サービス専用のゲートウェイをアタッチ。対象サービスは S3 と DynamoDB
    - インターフェースエンドポイント:
      - VPC のサブネットに ENI を作成、ENI に割り当てられたプライベート IP アドレスを使用してサービスにアクセス。
      - エンドポイントポリシーがあり、エンドポイントを使用したリクエストのアクションやリソースを絞ることができる。デフォルトは全てのリソース、アクション。

- AWS Site-to-Site VPN: VPC に仮想プライベートゲートウェイをアタッチして、データセンターなどのオンプレミスのルーターと、インターネットプロトコルセキュリティ(IPsec)VPN 接続が可能。

  - カスタマーゲートウェイ: オンプレミス側のルーターなど、動的ルーティングでは BGP(ボーダーゲートウェイプロトコル)ASN の指定が可能。
  - VPN 接続を作成すると仮想プライベートゲートウェイは 2 つの AZ にそれぞれトンネルを作成する。トンネルにはそれぞれ publicIP を使用する。カスタマーゲートウェイで 2 つのトンネルを設定することで冗長性が確保され、どちらかのトンネルが使用できなくなったときは、もう一方へ自動ルーティングされる。

- AWS Direct Connect(DX): ユーザーまたはパートナーのルーター(Customer Router)から Direct Connect のルーター(DX Router)に、標準のイーサネット光ファイバケーブルを介して接続するサービス。
- 仮想インターフェース(VIF): AWS Direct Connect 接続を使用するのに必要。
  - プライベート仮想インターフェース:
    - VPC にアタッチされた仮想プライベートゲートウェイ、または Direct Connect Gateway に接続する仮想インターフェース。
    - プライベート IP アドレスを使用。
    - 同一 region の仮想プライベートゲートウェイ → VIF
    - 異なる region の仮想プライベートゲートウェイ → Direct Connect Gateway
  - パブリック仮想インターフェース:
    - public な AWS サービス(S3, DynamoDB など)にアクセスできる。
  - トランジット仮想インターフェース:
    - Direct Connect Gateway に関連付けられた TransitGateway にアクセスできる。
- AWS Transit Gateway: 最大 5000 の VPC やオンプレミス環境の接続を簡素化。

  - VPC のサブネットにアタッチメントとして ENI を作成し、Transit Gateway と関連づける
  - オンプレミスとの接続には VPN 接続や Direct Connect と接続する。

- Route53 Resolver:

  - インバウンドエンドポイント: 他のネットワーク、例えばオンプレミスから Route53 プライベートホストゾーンに対しての DNS クエリを使用できる。
  - アウトバウンドエンドポイント: VCP から他のネットワーク、例えばオンプレミス DNS に対しての DNS クエリを使用できる。

- AWS Orgaizations:

  - ![Screenshot 2023-07-29 at 19 02 56](https://github.com/yoshikikasama/network-and-server/assets/61643054/405b998d-88c1-4074-a235-a7f65d83dbfe)
  - 一括請求のメリット:
    - 1 つの請求書、統合請求データ
    - 合計量によるボリュームディスカウント: 複数アカウントの合計容量による従量制の割引が受けられる。S3 のストレージ量やデータ転送量などボリューム料金階層がある料金についてメリットがある。
    - リザーブドインスタンス、Saving Plans の共有: 組織のアカウント合計使用量として適用できる。
  - CloudFormation StackSets: 複数 region、複数アカウントにスタックを作成して、変更、削除、管理できる機能。
  - CloudTrail: Organizations のマスターアカウントで組織内の全てのアカウントについて CloudTrail を有効化できる。このとき書き出される S3 オブジェクトの prefix には組織 ID が含まれる。
  - AWS Service Catalog: ポートフォリオと製品を作成でき、Organizations 組織で OU を指定して共有できる。製品は CloudFormation スタックによる AWS リソースにより構成された、ユーザーが事前に準備したソフトウェアサービス。

- AWS Control Tower:
  - Landing zone: 複数アカウントのベストプラクティスを自動構築。
  - Security OU:
    - Log Account:ログを集約。
    - Audit Account: 各アカウントから SNS TOPIC への通知を集約して監査担当者へ通知
  - Sandbox Ou: 検証、開発などのアカウントを構築
  - Control Tower ダッシュボード: Config ルールによって抽出された非準拠リソースを抽出できる。
  - <img width="954" alt="Screenshot 2023-07-29 at 19 02 39" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/bc20d264-9f6e-4602-9964-cde01f473153">

練習問題：

1. D
2. B❌ C
3. A
4. B
5. D
6. A,D
7. C
8. D❌A
9. C❌D
10. D❌A
11. B❌D
12. B❌C,D
13. D
14. A
15. D
16. A,D
17. D

## 3. 新しいソリューションの設計

- AWS KMS: CMK(Customer Master Key)を管理して、データキーを生成・暗号化・復号するなど、暗号化に必要なキー管理、キーオペレーションを提供する Managed Service。

  - カスタマー管理の CMK: AWS ユーザーが作成、管理、完全に制御する CMK。
  - AWS 管理の CMK: AWS が作成管理する CMK。
  - 対称暗号化: 1 つのデータキーを使った暗号化・復号化
  - 非対称暗号化: Public と Private のキーペアを使って暗号化・復号化を行う。
  - Key の自動ローテーションが可能。

- Amazon S3 クライアントサイド暗号化: S3 に保管されるデータの暗号化。AWS に書き込まれるときに暗号化され、オブジェクトデータにアクセスするときに復号される。

  - SSE-S3: S3 が管理する key によるサーバーサイド暗号化。
  - SSE-KMS: KMS で管理している Key によるサーバーサイド暗号化。
  - SSE-C: オンプレで作成された Key などのユーザー指定 key によるサーバーサイド暗号化。

- AWS CloudHSM:

  - Key 保存、暗号化 Operation を実行するハードウェアを物理的に専有するサービス。
  - 複数の AZ を指定してクラスタを作成し、冗長性と高可用性を実現する。

- AWS Certificate Manager: Public, Private 証明書の保存、更新を提供する無料のサービス。

- Amazon Cognito: web application や mobile application に安全に認証を提供するサービス。

  - Cognito ユーザープール: 認証基盤を開発しなくても web application や mobile application からのサインアップ、サインインのために使用できる。
    - <img width="957" alt="Screenshot 2023-07-30 at 16 45 37" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/a3162858-90ad-448f-997d-cd98774c0588">
  - ID プール: mobile application やクライアントサイド JavaScript が動作しているアプリケーションで AWS のサービスに対して安全にリクエストを実行できる。
    - <img width="973" alt="Screenshot 2023-07-30 at 16 49 24" src="https://github.com/yoshikikasama/network-and-server/assets/61643054/5cf0b889-5081-42a2-915c-472456256711">

- Amazon Kinesis: 以下のものがあります。どの機能もニアリアルタイム(なるべくすぐ)にデータが発生するごとに処理を行なっていく、ストリーミング処理のためのサービス。

  - Kinesis Data Streams:
    - 秒あたり数 GB のデータをリアルタイムにストリーミング処理する。送信データには partition key を使用。
    - シャード一つで 1 秒あたり 1MB, 1000 レコードの取り込みと、1 秒あたり最大 2MB の読み込みが可能。
  - Kinesis Data Firehose: 最低 60 秒のバッファでデータを S3 などに簡単に格納する。送信前に AWS Glue や Lambda での加工ができる。streams より遅い。
  - Kinesis Data Analytics: Kiesis Streams や Firehose のストリーミングデータを SQL など使い慣れた言語を使ってリアルタイムに抽出検索する。
  - Kinesis Video Streams: 監視カメラなどからリアルタイム検知のための動画データをストリーミング upload する。

- Amazon Kinesis Data Firehose: データ変換+データ格納処理。「Zero Administration(ゼロ管理)」というのが挙げられます。Kinesis Streams とは違い、EC2 からポーリングしたり Lambda のコードを書く必要は一切ありません。設定を行うだけで S3 や Redshift にデータがそのまま流れます。 S3 や Redshift に大量のデータを溜める目的は何か。それはズバリ「分析用途」です。各種 BI ツールでデータをわかりやすく表示し、様々なクエリをかけて多様な切り口からデータを分析するために Redshift のような DWH は存在します。 分析するのにデータが put されてから処理するまでのスピードはそれほど求められません。逆に求められるのは大量のデータを効率よく格納する圧縮技術やいかにセキュアにデータを保持するか、という暗号化技術です。 Firehose は GZIP や SNAPPY といった圧縮アルゴリズムが使えますし、KMS を使った暗号化も可能になっています。

- RPO(Recovery Point Objective): 目標復旧時点、障害発生によりオンラインのデータが失われた場合に、バックアップから復旧したデータはいつの時点まで戻っても良いか。RPO が 24 時間の場合は、バックアップは 1 日 1 回となる。
- RTO(Recovery Time Objective): 目標復旧時間、障害発生からシステムが完全復旧するまでに要する時間。
- ![Screenshot 2023-07-30 at 19 03 10](https://github.com/yoshikikasama/network-and-server/assets/61643054/8cb92837-c5d9-4ed6-89a6-648c4eae05ec)

- バックアップ&リストア:
  - バックアップを別リージョンに退避し必要あればリストア。
  - 別リージョンに AMI, DB のバックアップデータ、CloudFormation template からの復元など。
- パイロットライト:
  - 平常時は停止した状態で環境を用意し、非常時に起動
  - RDS クロスリージョンリードレプリカ
  - S3 Bucket はクロスリージョンレプリケーション
  - DynamoDB はグローバルテーブル
  - AMI と CloudFormation template を作成
  - ![Screenshot 2023-06-28 at 6 45 05](https://github.com/yoshikikasama/network-and-server/assets/61643054/f5df0449-f65c-4be6-8878-52f7d2ebf231)
- ウォームスタンバイ:
  - 平常時は最小限のリソースで起動し非常時にスケール
  - パイロットライト構成+ Web 層とアプリケーション層も最小構成で稼働しておく
  - 災害発生時:
    - EC2 は Auto Scaling
    - RDS はマスター昇格
    - Route53 ヘルスチェックと DNS フェイルオーバーで自動でルーティング切り替え
- マルチサイト:
  - 常時、複数リージョンを使ってサービスを提供
- ![Screenshot 2023-06-28 at 6 27 49](https://github.com/yoshikikasama/network-and-server/assets/61643054/2fc1417b-cec2-4a05-914d-7fded7730e33)
- アクティブ/パッシブ(フェイルオーバー):

  - プライマリリソースまたはリソースグループをほとんどの時間で利用可能にして、すべてのプライマリリソースが使用できなくなった場合に備えて、セカンダリリソースまたはリソースグループをスタンバイ状態にします。クエリへの応答で Route53 が返すのは、プライマリリソースのみで、すべてのリソースで異常が発生した場合、Route53 は DNS クエリへの応答として正常なセカンダリリソースのみを返します。

- AWS Storage Gateway: オンプレミスから主に S3 などの AWS ストレージサービスを Backup 用に使用できる。

  - ファイルゲートウェイ: SMB もしくは NFS プロトコルでマウントしたデータを保存するケースで利用。
  - ボリュームゲートウェイ: iSCSI ブロックストレージボリュームをオンプレミスが必要とする場合はボリュームゲートウェイを使用。EBS スナップショットとして S3 に保存。
    - 保管型ボリュームゲートウェイ: プライマリーデータストレージとしてローカルのストレージを使用し、データを非同期に S3 にバックアップする。
    - キャッシュ型ボリューム: 頻繁にアクセスされるデータをローカル環境に保持しながら、S3 をプライマリデータストレージとして使用できる。
  - テープゲートウェイ: backup の保存先をテープ装置から AWS の仮想テープライブラリに変更することが可能。

- EC2 の T2,T3,T3a,T4g インスタンスの CPU バーストパフォーマンス:

  - CPU のベースとラインを超えてバーストすることができる。
  - バーストしているときは CPU クレジットを消費している。

- EC2 のプレイスメントグループ:

  - クラスター: 同一の AZ に配置。拡張ネットワーキングとの併用が望ましい。インスタンス間で低レイテンシー、高スループットなネットワーク性能。
  - パーティション: 起動するインスタンスのホスト・ラックを分散。ハードウェア障害の頻度を低減。ワークロードの相関障害の軽減など。
  - スプレッド: 複数 AZ に独自のネットワークおよび電源がある異なるラックにインスタンスを配置。ハードウェア障害の頻度を低減。各 EC2 インスタンスを個別に独立したハードウェアに配置する必要がある場合など。

- Amazon FSx for Lustre:
  - Lustre を効率よく起動。
  - Lustre:大規模な HPC(High Performance Computing)やスーパーコンピュータで使用されている分散ファイルシステムがある。
- S3 Transfer Acceleration:
  - S3 Bucket のある region から離れた大陸や地域から Upload する場合のレイテンシーを改善するために全世界のエッジロケーションを利用する。

Elastic Beanstalk を使用した Blue-Green Deployment: 個別の環境に新しいバージョンをデプロイしてから、2 つの環境の CNAME を入れ替えて、直ちに新しいバージョンにトラフィックをリダイレクトします。

練習問題：

1. C
2. C
3. D
4. A
5. D
6. D
7. C❌B
8. C
9. D
10. A
11. B
12. C❌B
13. B❌C
14. D
15. A
16. D❌C
17. C
18. D

## 4. 移行の計画

- AWS Cloud Adoption Readiness Tool(CART):
  - クラウド移行導入準備ツール。クラウド移行の大まかな推奨事項のレポートが生成される。
- AWS Application Discovery Service:
  - オンプレミスサーバーの使用状況や設定データを収集することで AWS への移行計画をサポート
  - AWS Migration Hub と統合されており、収集した情報は AWS Migration Hub で確認でき、追加の option で Kinesis Data Firehose から S3 へ送信し、Athena で SQL 分析することができる。
  - エージェント型: Windows や Linux にインストールできる
  - エージェントレスコネクタ型: VMware 向け。
- AWS DMS(Database Migration Service): データベースの移行サービス。オンプレミスから AWS への移行、AWS からオンプレミスへの移行をサポート。
- AWS SCT(Schema Conversion Tool): 異なるデータベースキーマの変換。

- AWS Outposts:

  - ユーザーのデータセンターなど、より近い場所で AWS サービスを使用できるサービス。
  - オンプレミスのロケーションで AWS サービスを使用することによりレイテンシーを下げる。

- Canary: トラフィックは 2 回の増分で移行される。2 回目の増分で移行される前に最初の増分および間隔で移行される、トラフィックの割合(%)が指定されている。
- Linear: トラフィックは毎回同じ間隔(分)の等しい増分で移行する。
- All-at-once: すべてのトラフィックは同時に移行される。

- 移行戦略:
  - Refactor: アプリケーションをフルにカスタマイズできる。コストもアプリケーション内部のレイテンシーも制約にはならないので、ベストプラクティスに突き進める移行戦略。
  - Replatform: アプリケーション内部のカスタマイズは行わない、アプリケーション内部のレイテンシーや、オンプレミスで使用しているソフトウェアやデータベースなどの制約はそのまま引き継ぐ、可能な部分はマネージドサービス。
  - Repurchase: これまで組織で運用管理していたシステムを運用しなくてよくなり、同じ価値を SaaS などにより提供できる時の選択。
  - Rehost: 案マネージドサービスである EC2 を中心に構成する。
  - Relocate: VMware Cloud on AWS の使用を開始し、そのまま AWS へ移行する手段。
  - Retain: クラウドに移行する目的があり、検討した結果、そのままとする。
  - Retire: システムを廃止すること。

練習問題：

1. D
2. C
3. B
4. A
5. B
6. C
7. D
8. B
9. C
10. C
11. A
12. C

## 5. コスト管理

- Amazon EC2 のコスト:

  - リザーブドインスタンス:
    - 購入期間: 1 年または 3 年
    - 提供クラス:
      - スタンダード: 変更はできるが、交換はできない。変更は「スコープを region から az に」、「スコープを AZ から region への変更」「同じ region 内での az の変更」
      - コンパーティブル: 変更だけでなく、交換も可能。
  - スポットインスタンス: 各 AZ の各インスタンスタイプの使用されていない量によって決定されるスポット料金で使用できる。上限料金をリクエストして使用する。スポット料金が上限料金を超えた場合か、キャパシティがなくなった場合は、スポットインスタンスは中断される。
    - 中断に備えたベストプラクティス:
      - リクエスト料金にデフォルトのオンデマンドインスタンス料金を使用する
      - 中断されたインスタンスの代わりのインスタンスをすぐに起動できるように、AMI、起動 template を用意する
      - S3,dynamodb などにデータを保存する
      - SQS からジョブメッセージを受信して処理し、中断時には可視性タイムアウトによって他のインスタンスによって再試行できる構成にする。
      - 中断前の処理が必要な場合、メタデータのポーリングが EventBridge で検知し完了させる。
  - Delicated Hosts: 専有物理サーバーに EC2 インスタンスを起動できる
  - Savings Plans: 1 年または 3 年期間で時間あたりの使用料金を契約することで、割引料金で利用できる。
    - EC2 Instance Savings Plans: 期間(1 年、3 年)、region、インスタンスファミリー、時間あたりの料金、支払いを決定する。
    - Compute Savings Plans: EC2 インスタンス、Fargate、Lambda の仕様に適用。

- S3 のコスト:
  - S3 標準
  - S3-IA: 取り出し頻度が少ないと S3 標準よりコストが安くなる
  - S3 Intelligent-Tiering: アップロード後の経過日数によってアクセス頻度が変化するパターンが一定でない場合。
- S3 リクエスタ支払い:

  - リクエスト料金とデータ転送料金をリクエストした側の AWS アカウントに請求する。
  - AWS アカウント以外からアクセスできなくなる
  - リクエストタは header に x-amz-request-payer を含めることで課金されることを了解している旨を伝える必要がある。

- Amazon DynamoDB のコスト:

  - オンデマンドモード: 書き込みリクエスト、読み込みリクエストが発生するごとに料金が発生する
    - 急激なスパイクリクエスト が発生するケース
  - プロビジョンドキャパシティモード:
    - 1 秒間の書き込み回数・容量に対して設定する WCU、読み込み回数・容量に対して設定する RCU を設定する。
    - 継続的なリクエストかつゆるやかな増減

- DynamoDB Accelerator(DAX):

  - VPC 内で DynamoDB のキャッシュにアクセスできる。
  - DynamoDB table へは数ミリ秒でのリクエストができるがマイクロ秒の応答が必要なケースで DAX を検討できる。
  - ノードの集合のクラスタを作成して複数の AZ に配置でき、ノードの時間単位で料金が発生する。
  - 同じ GET リクエストを何度も DynamoDB table へ実行しているのであれば、DAX で読み込みリクエストを低減でき。全体のコストとパフォーマンスを最適化できる。

- データの region 外への転送にはコストが発生するので、Lambda 関数などで必要なサイズにリサイズし、メディア配信することも考える。

## 6.

- Amazon GuardDuty: CloudTrail, S3 Data log, VPC Flow log, DNS Query log を分析して脅威を検出する。
- Amazon Macie: S3 Bucket に保存された機密データを機械学習とパターンマッチングで検出・監視できる。
- SNS + SQS + Lambda + DynamoDB による疎結合化
- RDS Proxy: データベース接続プールを確立し、再利用することで効率的な接続を提供する。
- CloudFront:

  - Distribution: 配信設定やリソースのこと。
  - エンドユーザーが CloudFront で構成された Web コンテンツにアクセスしたとき、レイテンシーの面から最寄りの POP(Point of Presence)エッジロケーションにルーティングされる。
  - Presense: 名詞でで「目の前」
  - その POP に対象のコンテンツがあればユーザーに返されるが、なければビヘイビアに設定されたパスパターンに応じてオリジンへリクエストされ、オリジンから POP へファイルが転送され、保存される。
  - そして POP からユーザーにファイルが返される。
  - オリジンへのアクセスを制限する 3 つの方法:
    - OAI: OAI という CloudFront で作成できるユーザーを作成してオリジン設定に関連づけ、S3 Bucket policy で OAI からの GetObject のみを許可する。
    - カスタムヘッダー: オリジンが ALB などの場合に有効。Distribution のオリジン設定に任意の key とカスタムヘッダーを追加。ALB のルーティングで指定した HTTP ヘッダーがリクエストに含まれる場合のみ正常なターゲットルーティングする。含まれない場合は、403(Access Denied)
    - IP アドレス制限: オリジン側で IP アドレスによって CloudFront からのリクエストを判定する。
  - フィールドレベルの暗号化: CloudFront はフィールドレベルの暗号化が可能。公開鍵と秘密鍵を使用した非対称暗号化で指定したフィールドを暗号化できる。例えばユーザーが入力した電話番号を CloudFront distribution で登録された公開鍵で暗号化し、オリジンの API Gateyway に POST します。API Gateway は暗号化された電話番号を DynamoDB へ保存します。秘密鍵はパラメータストアで SecureString として KMS で暗号化して保存する。Lambda は GetParameter した秘密鍵を使用して DynamoDB table から GetItem した暗号化された電話番号を復号して Amazon Connect を呼び出し、自動で電話番号発信できる。アプリケーション開発者も電話番号を知る必要はなく Secure に保存することができる。
  - CloudFront Functions: CloudFront の機能で、JavaScript で実装する。Viewer へのリクエスト、レスポンス処理のみをサポートしていて、オリジンへのリクエスト、レスポンスはサポートしていない。リクエスト URL を変換することでキャッシュキーの正規化によってキャッシュヒット率を向上したり、ヘッダーを追加したりリクエストのトークン検証をするためなどに使用できる。
  - Lambda@Edge: AWS Lambda の拡張機能で Node.js、Python がサポートされている。CloudFront Functions ではできない処理に使用する。

- AWS Global Accelerator:

  - エンドユーザーがアクセラレーターにアクセスすると最も近いエッジロケーションでリクエストが受け付けられ、ヘルスチェックに合格したエンドポイントの内、近い場所や重みづけした設定によってルーティングされる。

- Amazon ElastiCache: フルマネージドインメモリデータベース。

  - 高速: メモリは SSD より少なくとも 50 倍高速
  - 予測可能: キーンデクシング、ディスクシークなし
  - Redis & Memcached に完全対応
  - AWS インメモリ耐久性:
    - ElastiCache for Memcached: 揮発性、永続性なし
    - ElastiCache for Redis: 半耐久性、スナップショット、非同期レプリケーション
    - MemoryDB for Redis: マルチ AZ トランザクションログ

- Memcached:

  - シンプル、インメモリ
  - 単純な Key-Value Store
  - マルチスレッド
  - 永続化はサポートしないので、消えても良いデータ
  - スケーリングが用意
  - オープンソース
  - 単一ノードの性能を上げたい場合はこちらを選ぶ。

- Redis:

  - 豊富なインメモリデータ構造:
    - 文字列、list、set, sort set, hash table, HyperLogLog, 地理空間, およびストリーム
  - オープンソース
  - ElastiCache の様々な機能を使いたい場合はこちらを選ぶ。Redis はシングルスレッドなので、コア数の少ないものを選ぶとよいが、メモリ量も少なくなるのでバランスをとって、「cache.m3.large」などを選ぶと良い。

- Amazon ElastiCache Memcached と Redis の違い:
  - <img width="849" alt="Screenshot 2023-01-11 at 7 02 18" src="https://user-images.githubusercontent.com/61643054/211672048-462b18c2-cf40-44f2-a94d-cf94f0788947.png">
- Amazon Elastic Cache :

  - ElastiCache では最小の構成単位を「ノード」と呼びます。EC2 で言うところのインスタンスに相当するものです。このノードを組み合わせた集合体をクラスターと呼びます。ノードに直接接続してしまうと、もしそのノードに問題が発生した場合には新しいノードのアドレス（エンドポイント）をアプリケーション側で書き換えなくてはなりませんし、サービスの成長と共に負荷が上がってくるとノードの台数を増やして負荷やメモリ（キャッシュ）を分散したりといった要件も出てきます。クラスター構成を組んでおいて、常にアプリケーションはエンドポイントを見ておくようにすればノードの増減によってアプリケーションに変更を行う必要がありません。よって、運用を行う上でこのクラスター機能という観点は非常に大事になってくるのです。
  - for Memcached:
    - マルチスレッド動作
    - Memcached のクラスターは単純にノードを追加したり減らしたりして負荷を分散することができます（水平スケーリング、スケールアウト/イン）。
    - データは永続的ではない
  - for Redis:

    - マルチ AZ
    - シングルスレッド動作
    - Cluster Mode Disabled:
      - 1 つのプライマリーノードと 0~5 個のレプリカ
      - スケールアップ/ダウンしてノードタイプを増減する
      - レプリカノードの追加と削除によるスケールアウト/スケールイン
      - プライマリへの書き込み
      - Multi AZ & 自動フェイルオーバー
      - 構造化データ
      - ![Screenshot 2023-06-12 at 22 17 05](https://github.com/yoshikikasama/network-and-server/assets/61643054/c03fbce6-3d5f-4983-a293-38ebbc2c7403)
    - Cluster Mode Enabled:
      - スケールアップ/ダウンしてノードタイプを増減する
      - レプリカノードの追加と削除によるスケールアウト/スケールイン
      - シャードの追加/削除
      - 1 つのプライマリーノードと シャードごとに 0~5 個のレプリカ
      - 最大 500 ノード
      - データは永続的
      - ![Screenshot 2023-06-12 at 22 22 43](https://github.com/yoshikikasama/network-and-server/assets/61643054/9b69384e-ba0a-403a-920e-613ceac1f746)

- Amazon DynamoDB Accelerator(DAX)は Amazon ElasticCache for Memcached よりも優れたキャッシュを提供。

  - シャード（Shard）: データベースやデータストアのコンセプトの一つで、データを分割して複数の部分に分散するための単位です。
  - シャーディング: 大量のデータを複数の Redis ノードに分割（シャード）し、各ノードがデータの一部を管理することで、データベースのパフォーマンスを向上させるための手法です。シャーディングにより、データが均等に分散されるため、単一の Redis ノードにかかる負荷を軽減し、システムのスケーラビリティと処理能力を向上させることができます。
  - Eviction: どんどんデータが保存されて行って maxmemory に到達した際、発生する挙動に対する対処法:
    - noeviction: メモリ制限に達し、クライアントがより多くのメモリを使用する可能性のあるコマンドを実行しようとするとエラーを返します。
    - volatile-ttl: 有効期限（TTL）が短いキーから削除してスペースを確保します。
    - volatile-lfu: LRU アルゴリズムに基づき、有効期限（TTL）のあるキーの中で最もアクセスが少ないキーを失効させてスペースを確保します。
    - allkeys-lfu: LRU アルゴリズムに基づき、最もアクセスが少ないキーを失効させてスペースを確保します。
    - volatile-random: 有効期限（TTL）のあるキーをランダムに失効させてスペースを確保します。
    - allkeys-random: ランダムにキーを失効させてスペースを確保します。

- Auto Scaling ヘルスチェック:
  - EC2 ステータスチェック(デフォルト): インスタンスの状態が runnning 以外の場合、もしくはステータス impaired の場合に異常とみなされます。
  - ELB: ターゲットグループのヘルスチェックで unhealthy となったインスタンスを異常とみなします。
  - カスタムヘルスチェック: ユーザーが独自で用意した監視をヘルスチェックとして使用し、unhealthy となったインスタンスを異常とみなします。
- ELB ヘルスチェック:
  - ターゲットに対して設定したプロトコルでアクセスを行い正常にアクセスできるかをテストする操作。合格したインスタンスのみにリクエストがルーティングされる。
  - ELB から見た EC2 の IP アドレス
- Route53 のヘルスチェック: システムのエンドポイントに対するヘルスチェック。複数のリージョンにあるシステムに対して可能。

- セキュリティグループ:
  - 適用単位: インスタンス単位(EC2, RDS ごとに適用される)
  - 制御する種類: 許可のみを In/Out で指定
  - 戻りの通信の取り扱い: ステートフル(インバウンドのみ設定すればアウトバウンドも許可される)
  - デフォルトでは同じセキュリティグループ内通信のみ許可
  - 全てのルールを適用
  - 制御内容の指定方法: プロトコル、PORT,CIDR, セキュリティグループ
  - インスタンス単位で設定するファイアウォール機能
- ネットワーク ACL:

  - 適用単位: サブネット単位(サブネット内の全 AWS サービスに適用)
  - 制御する種類: 許可/拒否を In/Out で指定
  - 戻りの通信の取り扱い: ステートレス(インバウンド設定だけではアウトバウンドは許可されない)
  - デフォルトでは全ての通信を許可する設定
  - 番号の順序通りに適用
  - 制御内容の指定方法: PORT,CIDR
  - サブネット単位で全インスタンスに適用するファイアウォール機能

Amazon DynamoDB グローバルテーブル:

マルチリージョンにマルチアクティブデータベースをデプロイするための完全マネージド型のソリューションです。
独自のレプリケーションソリューションを構築および管理する必要はありません。
テーブルを利用したい AWS リージョンを指定すると、DynamoDB が進行中のデータ変更をそれらすべてに伝播します。
レプリカテーブル内の項目に加えられた変更は、同じグローバルテーブル内の他のすべてのレプリカにレプリケートされます。
グローバルテーブルでは、新しく書き込まれた項目は通常、1 秒以内にすべてのレプリカテーブルに伝播されます。グローバルテーブルでは、各レプリカテーブルには同じデータ項目のセットが保存されます。
DynamoDB では、一部の項目のみの部分的なレプリケーションはサポートされていません。
アプリケーションは、任意のレプリカテーブルとの間でデータを読み込みおよび書き込みできます。アプリケーションが結果整合性のある読み込みのみを使用し、1 つの AWS リージョンに対して読み込みのみを発行する場合、変更を加えずに動作します。
ただし、アプリケーションで強力な整合性のある読み込みが必要な場合は、同じリージョンですべての強力な整合性のある読み込みと書き込みを実行する必要があります。DynamoDB は、リージョン間での強力な整合性のある読み込みをサポートしていません。したがって、あるリージョンに書き込んで別のリージョンから読み込む場合、読み込みの応答には、他のリージョンで最近完了した書き込みの結果を反映していない古いデータが含まれる可能性があります。

Amazon CloudWatch Synthetics:

スケジュールに沿って実行される設定可能なスクリプトである Canary を作成し、エンドポイントと API をモニターリングできます。Canary は顧客と同じルートをたどり、同じアクションを実行します。これにより、アプリケーションに顧客トラフィックがない場合でも、顧客エクスペリエンスを継続的に検証できます。Canary を使用すると、顧客が問題を検出する前に問題を検出できます。
Canary はエンドポイントの可用性とレイテンシーをチェックし、読み込み時間のデータと UI のスクリーンショットを保存できます。REST API、URL、ウェブサイトのコンテンツをモニターリングし、フィッシング、コードインジェクション、およびクロスサイトスクリプティングによる不正な変更をチェックできます。

- AD Connector: オンプレミスの Microsoft Active Directory ヘリクエストをリダイレクトするディレクトリゲートウェイ

  - ![Screenshot 2023-07-16 at 15 03 58](https://github.com/yoshikikasama/network-and-server/assets/61643054/87478266-f498-448e-ad9a-0fff94ea7d43)

- AWS Resource Access Manager:

  - アカウント間で AWS リソースを簡単に共有するためのサービス。
  - ユーザーは異なる AWS アカウントや AWS Organizations で共有リソースをセキュアに提供できる。

- Amazon RDS for MySQL のクロスリージョンリードレプリカ機能:

  - 複数の region でデータベースの可用性を高めるための仕組み。
  - 主要なデータベースがダウンした際にすぐにリードレプリカをスタンドアロンの DB インスタンスに昇格させることができ、サービスのダウンタイムを最小限に抑えることができる。

- AWS Global Accelerator:

  - 世界中の顧客に提供するアプリケーションの可用性とパフォーマンスを改善するネットワーキングサービスです。
  - AWS Global Accelerator が提供する静的 IP アドレスを、Network Load Balancer、Application Load Balancer、EC2 インスタンス、Elastic IP アドレスなどのリージョン別 AWS リソースまたはエンドポイントに関連付ける。IP アドレスは AWS エッジロケーションからのエニーキャストであるため、ユーザーに近い AWS グローバルネットワークへのオンボーディングを提供します。
  - ゲーム (UDP)、IoT (MQTT)、Voice over IP などの HTTP 以外のユースケース、およびスタティック IP アドレスまたは確定的な高速地域フェールオーバーを特に必要とする HTTP ユースケースに最適です。

- Cross-Origin Resource Sharing(CORS):

  - 異なるオリジン間でリソース共有を制御するブラウザの機能。
  - これが有効でないとセキュリティポリシーによりリクエストがブロックされる。
  - ブラウザ上のスクリプトが Amazon API Gateway API リクエストを送信するためには CORS を有効にする必要がある。
  - 異なるドメインまたは、オリジンでホストされている API にアクセスする web アプリケーションを構築するために必要。

- EC2 の拡張ネットワーキング: 更なるネットワークパフォーマンス向上に貢献する。
- Amazon Macie: S3 Bucket を分析して、public object, public bucket または機密情報が S3 内に存在するかを確認

- Amazon Timestream:

  - 高速でスケーラブルなサーバレスの時系列データベース。
  - 最近のデータ用のメモリストアと履歴データ用の磁気ストアを使用してデータライフサイクル管理を簡素化する。
  - クエリを定期的かつ自動的にスケジュールし、受信データに対してリアルタイム分析が実行できる。

- Amazon S3 Transfer Acceleration: クライアントと S3 Bucket 間での Upload パフォーマンスを改善できる。

- AWS WAF:

  - クロスサイトスクリプティングを含む一般的な攻撃手法を防止し、ボリューム型サービス拒否から保護するために Amazon CloudFront と関連づけることができる。
  - ALB はカスタムヘッダーを追加することで CloudFront からのトラフィックのみを許可するように設定することができる。
  - ユーザーが Application Load Balancer (ALB) に直接アクセスすることを制限し、AWS WAF を使用して Amazon CloudFront からのみアクセスを許可:
    - CloudFront が ALB に送信するリクエストにシークレット値を持つカスタム HTTP ヘッダーを追加するように CloudFront を設定する。
    - ALB に関連付けられた AWS WAF ウェブ ACL で、カスタム HTTP ヘッダーシークレット値を含まないリクエストをブロックするルールを作成する。

- Amazon RDS Proxy: Amazon RDS データベースとアプリケーションの間に位置し、データベースへの接続を管理するフルマネージドのデータベースプロキシサービスです。以下のような機能を提供するため、このシナリオでは Amazon RDS Proxy を使用することが推奨されます。

  - 接続の再利用: Amazon RDS Proxy は、複数のアプリケーションからの接続をプールし、データベースへの新規接続のオーバーヘッドを削減します。これにより、大量の並行リクエストを効率的に処理できます。
  - スケーラビリティ: Amazon RDS Proxy は、接続の数と時間を効率的に管理し、高負荷の状況でのパフォーマンスとスケーラビリティを改善します。AWS Lambda から RDS データベースへの接続時に特に有用です。なぜなら、Lambda がスケールアウトすると、大量の新規接続が一度に発生し、データベースがオーバーロードする可能性があるからです。
  - レジリエンシーとフェールオーバー: Amazon RDS Proxy は、データベースへの接続を維持し、データベースエンジンが再起動したりフェールオーバーしたりした場合でも、トランザクションとセッションの状態を維持することができます。これにより、アプリケーションの中断を最小限に抑えることができます。
  - セキュリティ: Amazon RDS Proxy は、IAM ロールやセキュリティグループを使用してアクセスを制御し、Secrets Manager を通じてデータベースの認証情報を安全に管理します。これにより、アプリケーションのセキュリティを強化することができます。
  - 以上の理由から、このシナリオではデータ収集の Lambda 関数と Aurora MySQL データベース間に Amazon RDS Proxy を使用します。

- 接続プーリング: データベースとの接続を再利用する手法の一つです。これは、アプリケーションとデータベース間の新規接続の確立には時間とリソースが必要であり、アプリケーションが短時間で多数の接続を必要とする場合に特に有効です。

  - 接続プーリングの仕組みは以下の通りです：
    - アプリケーションがデータベースに接続を要求すると、接続プールマネージャー（この場合は Amazon RDS Proxy）は、既存の接続プールから利用可能な接続を探します。
    - 利用可能な接続があれば、その接続をアプリケーションに提供します。アプリケーションはその接続を使用してデータベースと通信します。
    - アプリケーションが接続を閉じると、実際には接続は閉じずに接続プールに戻され、再利用が可能となります。これにより、新たな接続を確立するための時間とリソースを節約することができます。
    - これらの理由から、接続プーリングは頻繁にデータベースとの短期間の接続を必要とするアプリケーション、特に Web アプリケーションやマイクロサービスなどで広く利用されています。

- Amazon API Gateway:

  - エッジ最適化エンドポイント: 地理的に分散されたクライアントに最適。最寄りの CloudFront POP (Point Of Presence) にルーティングされます。これは、API Gateway REST API のデフォルトのエンドポイントタイプです。CloudFront のエッジローケーションを経由して、最適なリージョンにルーティングされます。エッジロケーションからリージョンまでは AWS 内のネットワークが利用されるので高速です。
  - リージョンエンドポイント: 直接リージョンにルーティングされます。同一リージョンの場合、エッジロケーションを経由しない分、レイテンシを削減できます。デフォルトのエンドポイントタイプです。
  - プライベートエンドポイント: VPC 内から AWS PrivateLink でのみアクセスできるエンドポイントです。

- Route53 のルーティングポリシー: DNS の応答をカスタマイズすることでクライアントからのトラフィックを適したリソースへルーティングする機能。

  - シンプルルーティング: 1 つのリソースに複数の IP アドレスを設定可能。
  - 加重ルーティングポリシー: ドメインに対して複数のリソースを関連付けることができ、割合を決めることができる。
  - フェイルオーバールーティングポリシー: Route53 のヘルスチェックによりリソースが正常なほうへトラフィックをルーティング。
  - レイテンシールーティングポリシー: ネットワークレイテンシーが最も低い AWS リージョンに基づいてリクエストをルーティングできる。
  - ユーザーの位置情報ルーティングポリシー: DNS リクエストを送信したユーザーの地理的な場所に基づいて名前解決の結果を変えること。
  - AWS リソースの地理的近接性ルーティングポリシー: クライアントだけでなく AWS リソース側の位置情報を考慮してルーティングすることが可能。

- すべての AWS アカウントの集中型のログ記録アーキテクチャ:

  - Amazon CloudWatch アカウントのロググループにデータを送信するように CloudTrail および VPC フローログを設定します。各 AWS アカウントに CloudWatch サブスクリプションフィルターを設定し、ロギングアカウント内の Amazon Kinesis Data Firehose にデータを送信します。ロギングアカウントで Kinesis Data Firehose から AmazonOpenSearch にデータをロードします。

- Elastic Fabric Adapter(EFA): ハイパフォーマンスコンピューティング(HPC)と機械学習アプリケーションを高速化するために EC2 インスタンスにアタッチできるネットワークデバイス。

- ![Screenshot 2023-07-23 at 21 39 55](https://github.com/yoshikikasama/network-and-server/assets/61643054/af0343fd-1424-4cee-a0ef-737727950bae)

- Amazon ECS のスポットインスタンス自動ドレイン:

  - 2 分間の中断の通知を受信すると、スポットインスタンスが自動的に "ドレイン" 状態に設定されます。スポットインスタンスで実行している ECS タスクは、インスタンスが削除される前に自動的にシャットダウンがトリガーされ、代替タスクがクラスターの別の場所にスケジュールされます。削除プロセスに入った後のインスタンスで、新しい ECS サービスタスクが開始されることはありません。ECS では、インスタンスに備わっている "ドレイン" 機能を使用して、基盤となる EC2 インスタンスの削除に伴うタスク終了の調整を引き継ぎます。削除の管理、代替タスクのスケジュール設定、LB 接続の正常な終了によって、サービスの中断が発生しにくくなります。お客様にとっては、ECS クラスターの一部としてスポットインスタンスを使用することが容易になります。
  - 利用可能なキャパシティーがなくなった場合、または、スポット料金がお客様のリクエストの上限料金を超えた場合には、Amazon EC2 はスポットインスタンスを終了、停止、または休止状態にします。Amazon EC2 は、終了アクションおよび停止アクションに対して、スポットインスタンスに 2 分間の中断通知を提供します。休止状態のアクションについては、2 分間の通知は提供されません。インスタンスで Amazon ECS スポットインスタンスのドレインが有効になっている場合、ECS はスポットインスタンスの中断通知を受け取り、インスタンスを DRAINING ステータスにします。
  - コンテナインスタンスを DRAINING に設定すると、Amazon ECS によって新規タスクがそのコンテナインスタンスに配置されなくなります。ドレインしているコンテナインスタンス上にある PENDING 状態のサービスタスクは即時停止されます。クラスター内に使用可能なコンテナインスタンスがある場合、そのインスタンスで代わりのサービスタスクが開始されます。

- DRAINING:

  - VM がインスタンス グループから削除されたときや、エンドポイントがゾーンネットワークエンドポイントグループ（NEG）から削除されたときに、既存の進行中リクエストを完了するための時間を確保するプロセスです。
  - コンテナインスタンスを DRAINING に設定すると、Amazon ECS によって新規タスクがそのコンテナインスタンスに配置されなくなります。

- ストアドプロシージャ: 一連の SQL クエリと論理操作を実行するためにユーザーが作成するオブジェクトです。プロシージャはデータベースに保存され、実行するのに十分な権限を持つユーザーが利用できます。
  - ストアードプロシージャーは SELECT 照会に加えてデータ定義言語 (DDL) およびデータ操作言語 (DML) を組み込むことができます。ストアドプロシージャは値を返す必要はありません。ループや条件式を含む PL/pgSQL 手続き型言語を使用して論理フローを制御できます。
  - ストアドプロシージャは通常、データ変換、データ検証、およびビジネス固有の操作のためのロジックをカプセル化するために使用されます。複数の SQL ステップをストアドプロシージャに結合することで、アプリケーションとデータベース間のラウンドトリップを減らすことができます。
- リフトアンドシフト（Lift and Shift）: 「まずはクラウド上にそのまま既存システムをあげて（Lift）、その後に随時変更していく（Shift）」という意味

- AWS App Sync:

  - シンプルな GraphQL ベースの実装
  - オフライン処理やデータ競合の解決をサポートする豊富なチャット向け機能
  - Dynamo DB, AWS Lambda, Elastic Search などから柔軟に構成できる。

- Retain policy: CloudFormation のスタックを Delete してもデータを残す方法

- AWS Network Firewall:

  - ネットワークトラフィックをきめ細かく制御するファイアウォールルールを定義できます。Network Firewall は AWS Firewall Manager と連携するため、Network Firewall ルールに基づいてポリシーを構築し、それらのポリシーを仮想プライベートクラウド (VPC) とアカウント全体に一元的に適用できます。
  - カスタマイズされたルールを実装して、VPC が未承認のドメインにアクセスすることを防止したり、数千の既知の不正な IP アドレスをブロックしたり、シグネチャベースの検出を使用して悪意のあるアクティビティを特定したりできます。AWS Network Firewall は、CloudWatch メトリクスを介してファイアウォールのアクティビティをリアルタイムで可視化し、ログを S3、CloudWatch、Kinesis Firehose に送信することでネットワーク トラフィックの可視性を高めます。
  - AWS Network Firewall を使用して制御された制御されたアウトバウンドトラフィック用に別の VPC を使用してトラフィックを統合することが可能。
  - ![Screenshot 2023-07-26 at 8 45 01](https://github.com/yoshikikasama/network-and-server/assets/61643054/ea5fa8df-a158-4317-a149-1a423f2651d6)
  - ![Screenshot 2023-07-26 at 8 45 33](https://github.com/yoshikikasama/network-and-server/assets/61643054/693f680e-f5d2-48b8-8edf-3c64e897b021)

  - AWS DataSync:

    - オンプレミスのストレージシステムと AWS ストレージサービス間、および AWS ストレージサービス間のデータ移動を簡素化、自動化、および高速化するオンラインデータ転送サービスです。DataSync を使用して、アクティブなデータセットを AWS に移行したり、データをアーカイブしてオンプレミスのストレージ容量を解放したり、ビジネス継続性のためにデータを AWS にレプリケートしたり、分析や処理のためにクラウドにデータを転送したりできます。
    - 大量のデータを移動するスクリプトの作成、保守、監視、およびトラブルシューティングを行う場合、IT 運用に負担がかかり、移行プロジェクトの速度が遅くなる可能性があります。DataSync は、この作業を排除するか、自動的に処理します。DataSync は、転送中のデータの暗号化、転送中および保管時のデータ整合性検証などの組み込みのセキュリティ機能を提供します。ネットワーク帯域幅の使用を最適化し、ネットワーク接続障害から自動的に回復します。さらに、DataSync は、データ転送のスケジュール設定や、Amazon CloudWatch のメトリクス、ログ、イベントを通じた転送プロセスの詳細な可視性などの制御およびモニタリング機能を提供します。
    - DataSync はネットワークファイルシステム(NFS) 共有、サーバーメッセージブロック (SMB) 共有、自己管理オブジェクトストレージ、AWS Snowcone、Amazon Simple Storage Service (Amazon S3) バケット、Amazon Elastic File System (アマゾン EFS) ファイルシステム、および Windows ファイルシステム用 Amazon FSx の間でデータをコピーできます。

  - AWS データ移行サービス比較:
    - ![Screenshot 2023-07-27 at 8 12 44](https://github.com/yoshikikasama/network-and-server/assets/61643054/c608e55f-4abc-4148-81a6-45fdf41f3afd)

- スロットリング: 一定の時間内に、事業者が特定の操作に対して送信できるリクエストの数を制限するプロセスです。

- AWS WAF + CloudFront + S3 + ALB:

  - CloudFront: オリジン設定のカスタムヘッダ設定し、リクエスト時にカスタムヘッダーを追加する。
  - AWS WAF: カスタムヘッダーの存在を検証するルールで WebACL を作成し、ALB に関連づける。

- AWS WAF:

  - AWS WAF は Web Application Firewall です。CloudFront、API Gateway、Application Load Balancer、AppSync GraphQL API へのリクエストに対応できます。リクエストの条件に対して、許可、ブロック、カウントを設定できます。それぞれのサービスリソースに WebACL をアタッチするだけなので、アプリケーションへの変更や影響を与えることなく開始できます。よくある攻撃に対してはマネージドルールが用意されていて、それを選択するだけで始めることができます。個別の設定が必要な場合はもちろん独自のルール設定も可能です。API レベルでの設定が可能なので、脅威のイベントに対して自動で設定できます。条件だけではなく、「5 分間に指定した数を超えた場合にブロック」やカウントできるレートベースルールも可能です。
  - AWS WAF の料金
    - Web ACL: 5USD/月
    - ルール:1USD/月
    - リクエスト:0.6USD/100 万リクエスト
    - Bot Control : 10USD/月
    - Bot Control リクエスト: 1USD/100 万リクエスト
    - Web ACL やルールを同じリージョンの複数のリソースで使用できます。
  - AWS WAF の代表的なマネージドルール: AWS WAF でマネージドルールを使用すると、一般的な攻撃を目的とした不要なトラフィックを排除することができます。すぐに始めることができます。以下は代表的なマネージドルールです。

    - ベースラインルールグループ: 一般的な各種脅威に対する保護ルールです。
    - コアルールセット:OWASP に記載されている高リスクの脆弱性や一般的な脆弱性などに対する保護。
    - 管理者保護:sqlmanager など管理用の URI パスへの攻撃からの保護。
    - 既知の不正な入力: localhost、web-inf などのパス、PROPFIND、未承諾の JWT からの保護。
    - SQL データベース:SQL インジェクションなど、SQL データベースを使用しているアプリケーションに対しての脅威からの保護。
    - Linux、POSIX、Windows オペレーティングシステム:各 OS 固有の脆弱性悪用攻撃からの保護。
    - PHP、WordPress アプリケーション:fsockopen や$\_GET などの関数や、
    - WordPress コマンドや xmlrpc.php へのリクエストなどからの保護。
    - IP 評価ルールグループ: Amazon IP 評価リスト:Amazon の内部脅威インテリジェンスによってボットと識別された IP アドレスのリストからの保護。
    - 匿名 IP リスト:クライアントの情報を匿名化することがわかっているソース(TCP ノード、一時プロキシ、その他のマスキングサービスなど)の IP アドレスのリスエンドユーザートラフィックのソースになる可能性が低いホスティングプロバイダーとクラウドプロバイダーの IP アドレスのリストからの保護。
    - AWS WAF ボットコントロールルールグループ: ボットからのリクエストをブロックおよび管理するルールが含まれています。広告目的、アーカイブ目的、コンテンツ取得、壊れたリンクのチェック、監視目的、Web スクレイピング、検索エンジン、Web ブラウザ以外などボットらのリクエストを管理、保護します。

  - AWS WAF のカスタムルール: カスタムルールで使用できる Web リクエストのプロパティです。
    - リクエスト送信元 IP アドレス
    - リクエスト送信元の国
    - リクエストヘッダー
    - リクエストに含まれる文字列(正規表現も可)
    - リクエストの長さ
    - SQL インジェクションの有無
    - クロスサイトスクリプティングの有無
  - AWS WAF のメトリクスとログ:AWS WAF のメトリクスでは、ルールごとと、すべての AllowedRequests、それに BlockRequests がモニタリングできます。サンプリングログ(過去 3 時間)は、Web ACL の概要ビューから確認できます。すべてのフルログは Kinesis Data Firehose を「aws-waf-logs-」で始まる名前をつけて作成して送信します。リクエスト送信元の IP アドレス、国、ヘッダー、メソッド、送信先の URI などを含めた許可·拒否両方のログが送信されます。ログのフィルタリング、フィールド除外が可能です。

- AWS Shield: AWS Shield は DDoS 攻撃から保護するサービスです。Standard と Advanced があります。Standard は無料で有効で、AWS サービスへの悪意のあるトラフィックから保護しています。CloudFront、Route 53 へのベーシックなネットワークレイヤー攻撃を自動的に緩和しています。より高いレベルで保護するためには Advanced を使用します。

  - AWS Shield Advanced で可能になること
    - CloudFront、Route 53、Global Accelerator、Elastic Load Balancing、 EC2Elastic IP の各リソースを指定しての保護。
    - EC2 の Elastic IP を保護する場合、数テラバイトのトラフィックを処理できるようにネットワーク ACL を昇格してデプロイ。
    - 24 時間 365 日対応の DDoS レスポンスチーム(Shield Response Team、SRT)が対応。
    - 正常性ベースの検出により、脅威イベントを検出、検出精度を向上。
    - AWS WAF の使用料金も含まれる。
    - DDoS 攻撃によるスケーリング料金のサービスクレジット。
    - レイヤー 3/4 攻撃の通知、フォレンジックレポート(発生元 IP、攻撃ベクトルなど)。

- AWS Shield Engagement Lambda:

  - DDoS 攻撃を自動検知して、エスカレーションアクションを自動化する設計パターンです。DDoSDetected、DDoSAttackBitsPerSecond、DDoSAttackPacketsPerSecond、DDoSAttackRequestsPerSecond メトリクスなどの攻撃の有無や攻撃の量に応じて CloudWatch アラームを設定します。SNS トピックへ送信して、サブスクリプション E メールで関係者へ送信します。もう一方のサブスクリプションで Lambda 関数を実行し、Shield Advanced API ヘリクエストして、AttackDetail など詳細情報を取得し、エスカレーションアクションを実行します。エスカレーションアクションには、AWS サポートケースの作成や、サードパーティサービスでインシデントチケットを作成するなどが考えられます。

- Amazon API Gateway

  - エッジ最適化 API: エッジロケーション POP を経由してルーティングされるので全世界のユーザーが使用するような API に最適
  - Regional Endpoint: 使用するユーザーが特定の地域に集中している場合
  - プライベートエンドポイント: VPC のみから使用する場合
  - Cognito ユーザープールでサインインした JWT(JSON Web Token)を Authorization ヘッダーに含めて、API Gateway にリクエストを実行する。Cognito ユーザープールで認証済みの JWT がなければ、API を実行することはできない。

- AWS Secret Manager: データベースなどの認証情報を保持し、取得には Secret Manager API を使用する。認証情報のローテーション更新が必要となった際には Secret Manager が DB の認証状号(パスワード)を更新して保持する。アプリケーションからは GetSecretValue リクエストを実行することで、常に現在の認証情報を取得することができる。
